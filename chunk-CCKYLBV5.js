import{K as p,La as b,P as I,U,Wc as w,Xc as g,Zc as D,_c as x,cd as v,dd as y,ed as A,fd as C,g as j,i as d,j as m,md as R,nd as T,o as h,x as l}from"./chunk-IZ5DWI6X.js";import{a,b as _}from"./chunk-7QOE2ANW.js";var k=(()=>{class f{get db(){return this.firebaseService.db}setLoginState(t,e){this.loggedInSubject.next(t),this.isLoggedIn.set(t),e?(this._currentUser.set(e),this.currentUserSubject.next(e),localStorage.setItem("jjm_user_id",e.id),localStorage.setItem("jjm_user_role",e.role)):t||(this._currentUser.set(null),this.currentUserSubject.next(null))}constructor(t,e){this.firebaseService=t,this.storeService=e,this._users=b([]),this.users=this._users.asReadonly(),this._currentUser=b(null),this.currentUser=this._currentUser.asReadonly(),this.usersSubject=new j([]),this.users$=this.usersSubject.asObservable(),this.loggedInSubject=new j(localStorage.getItem("jjm_logged_in")==="true"),this.isLoggedIn$=this.loggedInSubject.asObservable(),this.isLoggedIn=b(localStorage.getItem("jjm_logged_in")==="true"),this.currentUserSubject=new j(null),this.currentUser$=this.currentUserSubject.asObservable(),this.hydrateFromCache()}hydrateFromCache(){let t=localStorage.getItem("jjm_cached_users");if(t)try{let e=JSON.parse(t);this._users.set(e),this.usersSubject.next(e),console.log("Hydrated Users from cache");let r=localStorage.getItem("jjm_user_id");if(r){let s=e.find(i=>i.id===r);s&&(this._currentUser.set(s),this.currentUserSubject.next(s))}}catch(e){console.warn("Failed to hydrate users from cache",e)}}saveToCache(t){localStorage.setItem("jjm_cached_users",JSON.stringify(t))}hashPassword(t){let r=new TextEncoder().encode(t);return d(crypto.subtle.digest("SHA-256",r)).pipe(h(s=>Array.from(new Uint8Array(s)).map(i=>i.toString(16).padStart(2,"0")).join("")))}loadUsers(t=!1){if(!t&&this._users().length>0){console.log("Users already loaded in Signal. Skipping fetch.");return}let e=localStorage.getItem("jjm_user_id"),r=w(this.db,"users");v(r).then(s=>{let i=s.docs.map(n=>{let c=n.data();return this.transformUser(a({id:n.id},c))});if(i.length===0)this.initializeDefaultAdmin().subscribe();else if(this._users.set(i),this.usersSubject.next(i),this.saveToCache(i),e){let n=i.find(c=>c.id===e);n&&(this._currentUser.set(n),this.currentUserSubject.next(n))}}).catch(s=>{console.error("Error fetching users:",s),this.initializeDefaultAdmin().subscribe()})}initializeDefaultAdmin(){return this.usersSubject.value.length>0?m(void 0):this.hashPassword("Gr*l0v3R").pipe(p(t=>{let e={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:t,role:"admin",createdAt:new Date,hasSubscription:!0},r=g(this.db,"users",e.id);return d(y(r,e)).pipe(h(()=>{let s=this.transformUser(e);this._users.set([s]),this.usersSubject.next([s]),this.saveToCache([s])}),l(s=>(console.warn("Could not save default admin to Firestore, using local only",s),this._users.set([e]),this.usersSubject.next([e]),m(void 0))))}))}getUsers(){return this.users$}addUser(t){let e=crypto.randomUUID(),r=_(a({},t),{id:e,createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system"});return this.hashPassword(t.password||"").pipe(p(s=>{r.password=s;let i=g(this.db,"users",e);return d(y(i,r)).pipe(h(()=>{let n=this.transformUser(r),o=[...this._users(),n];return this._users.set(o),this.usersSubject.next(o),this.saveToCache(o),n}))}),l(s=>{throw console.error("Error adding user:",s),s}))}updateUser(t){let e=a({},t);return(e.password?this.hashPassword(e.password):m(void 0)).pipe(p(s=>{s&&(e.password=s);let i=g(this.db,"users",e.id);return d(A(i,e)).pipe(h(()=>{let n=this._users(),c=n.find(S=>S.id===e.id),o=this.transformUser(a(a({},c),e)),u=n.map(S=>S.id===o.id?o:S);return this._users.set(u),this.usersSubject.next(u),this.saveToCache(u),o}))}),l(s=>{throw console.error("Error updating user:",s),s}))}deleteUser(t){let e=g(this.db,"users",t);return d(C(e)).pipe(h(()=>{let s=this._users().filter(i=>i.id!==t);this._users.set(s),this.usersSubject.next(s),this.saveToCache(s)}),l(r=>{throw console.error("Error deleting user:",r),r}))}getUserById(t){return this.usersSubject.value.find(e=>e.id===t)}validateCredentials(t,e){return this.hashPassword(e).pipe(p(r=>{let s=w(this.db,"users"),i=D(s,x("username","==",t));return d(v(i)).pipe(h(n=>{if(n.empty)return null;let c=n.docs[0],o=c.data();if(o.password!==r)return null;let u=this.transformUser(a({id:c.id},o));return u.storeId&&this.storeService.setActiveStore(u.storeId),u}),l(n=>(console.error("Login error:",n),m(null))))}))}transformUser(t){let e=_(a({},t),{createdAt:this.parseDate(t.createdAt)});return(e.role==="admin"||e.username==="jjm143256789")&&(e.hasSubscription=!0),e}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):typeof t=="object"&&t.toDate?t.toDate():new Date(t):new Date}static{this.\u0275fac=function(e){return new(e||f)(U(R),U(T))}}static{this.\u0275prov=I({token:f,factory:f.\u0275fac,providedIn:"root"})}}return f})();export{k as a};
