import{a as S,d as y}from"./chunk-BHAFHNJ3.js";import{B as b,M as p,R as j,W as U,a,b as h,e as o,h as f,l as m,n as d,o as w,t as u}from"./chunk-MNIEKAC2.js";var I=(()=>{class n{constructor(t){this.http=t,this.apiUrl=y.apiUrl,this.usersSubject=new m([]),this.users$=this.usersSubject.asObservable()}hashPassword(t){return o(this,null,function*(){let s=new TextEncoder().encode(t),r=yield crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("")})}loadUsers(){this.http.get(`${this.apiUrl}/users`).subscribe({next:t=>{let e=t.map(s=>this.transformUser(s));e.length===0?this.initializeDefaultAdmin():this.usersSubject.next(e)},error:t=>{console.error("Error fetching users:",t),t.status===404&&this.initializeDefaultAdmin()}})}initializeDefaultAdmin(){return o(this,null,function*(){if(this.usersSubject.value.length>0)return;let e={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:yield this.hashPassword("Gr*l0v3R"),role:"admin",createdAt:new Date};this.http.post(`${this.apiUrl}/users`,e).subscribe({next:s=>{let r=this.transformUser(s);this.usersSubject.next([r])},error:s=>{console.warn("Could not save default admin to backend, using local only",s),this.usersSubject.next([e])}})})}getUsers(){return this.users$}addUser(t){let e=h(a({},t),{createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system"});return d(this.hashPassword(t.password||"")).pipe(p(s=>(e.password=s,this.http.post(`${this.apiUrl}/users`,e))),u(s=>{let r=this.transformUser(s),i=this.usersSubject.value;return this.usersSubject.next([...i,r]),r}))}updateUser(t){return new f(e=>{o(this,null,function*(){let r=a({},t);r.password&&(r.password=yield this.hashPassword(r.password)),this.http.put(`${this.apiUrl}/users/${r.id}`,r).subscribe({next:i=>{let c=this.transformUser(i),g=this.usersSubject.value.map(l=>l.id===c.id?c:l);this.usersSubject.next(g),e.next(c),e.complete()},error:i=>e.error(i)})})})}deleteUser(t){return this.http.delete(`${this.apiUrl}/users/${t}`).pipe(u(()=>{let e=this.usersSubject.value;this.usersSubject.next(e.filter(s=>s.id!==t))}))}getUserById(t){return this.usersSubject.value.find(e=>e.id===t)}validateCredentials(t,e){return d(this.hashPassword(e)).pipe(p(s=>this.http.post(`${this.apiUrl}/login`,{username:t,password:s}).pipe(u(r=>r?this.transformUser(r):null),b(r=>w(null)))))}transformUser(t){return h(a({},t),{createdAt:this.parseDate(t.createdAt)})}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):new Date(t):new Date}static{this.\u0275fac=function(e){return new(e||n)(U(S))}}static{this.\u0275prov=j({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{I as a};
