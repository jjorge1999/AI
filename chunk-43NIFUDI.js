import{La as w,M as p,P as y,U as j,Wc as g,Xc as S,Yc as C,Zc as l,bd as b,cd as x,dd as D,ed as E,g as _,i as n,j as I,jd as N,k as d,kd as R,o as h,x as f}from"./chunk-QPHDTU76.js";import{a as u,b as v}from"./chunk-7QOE2ANW.js";var $=(()=>{class m{get db(){return this.firebaseService.db}constructor(e,t){this.firebaseService=e,this.storeService=t,this._customers=w([]),this.customers=this._customers.asReadonly(),this.customersSubject=new _([]),this.customers$=this.customersSubject.asObservable(),this.hydrateFromCache(),this.storeService.activeStoreId$.subscribe(o=>{o?this.loadCustomers(!0):(this._customers.set([]),this.customersSubject.next([]))})}hydrateFromCache(){let e=localStorage.getItem("jjm_cached_customers");if(e)try{let t=JSON.parse(e);this._customers.set(t),this.customersSubject.next(t),console.log("Hydrated Customers from cache")}catch(t){console.warn("Failed to hydrate customers from cache",t)}}saveToCache(e){localStorage.setItem("jjm_cached_customers",JSON.stringify(e))}loadCustomers(e=!1){if(!e&&this._customers().length>0){console.log("Customers already loaded in Signal. Skipping fetch.");return}this.fetchCustomers()}loadInitialData(){this.loadCustomers()}getCurrentUser(){return localStorage.getItem("jjm_user_id")||"guest"}reloadData(){this.loadCustomers(!0)}fetchCustomers(){let e=this.storeService.getActiveStoreId();if(!e){console.log("CustomerService: No storeId, clearing customers."),this._customers.set([]),this.customersSubject.next([]);return}console.log("CustomerService: Fetching customers for storeId:",e);let t=g(this.db,"customers"),o=C(t,l("storeId","==",e));b(o).then(s=>{let c=s.docs.map(r=>u({id:r.id},r.data()));this._customers.set(c),this.customersSubject.next(c),this.saveToCache(c)}).catch(s=>console.error("Error fetching customers:",s))}getCustomers(){return this.customers$}getCustomerByName(e){let t=this.storeService.getActiveStoreId();if(!t)return I([]);let o=g(this.db,"customers"),s=C(o,l("storeId","==",t));return n(b(s)).pipe(h(c=>c.docs.map(i=>u({id:i.id},i.data())).filter(i=>i.name?.toLowerCase().includes(e.toLowerCase())).map(i=>v(u({},i),{phoneNumber:i.phoneNumber,deliveryAddress:"***",gpsCoordinates:"***",userId:"***"}))))}getCustomerByPhone(e){let t=this.storeService.getActiveStoreId();if(!t)return I([]);let o=g(this.db,"customers"),s=C(o,l("storeId","==",t),l("phoneNumber","==",e));return n(b(s)).pipe(h(c=>c.docs.map(r=>u({id:r.id},r.data()))))}addCustomer(e){let t=this.storeService.getActiveStoreId();if(!t)return d(()=>new Error("Store selection required for this transaction."));let o=crypto.randomUUID(),s=v(u({},e),{id:o,userId:this.getCurrentUser(),storeId:t,createdAt:new Date}),c=S(this.db,"customers",o);return n(x(c,s)).pipe(h(()=>s),p(r=>{let i=[...this._customers(),r];this._customers.set(i),this.customersSubject.next(i),this.saveToCache(i)}),f(r=>(console.error("Error adding customer:",r),d(()=>r))))}updateCustomer(e,t){let o=S(this.db,"customers",e);return n(D(o,t)).pipe(h(()=>{let c=this._customers().find(r=>r.id===e);return u(u({},c),t)}),p(s=>{let r=this._customers().map(a=>a.id===e?u(u({},a),t):a);this._customers.set(r),this.customersSubject.next(r),this.saveToCache(r)}),f(s=>(console.error("Error updating customer:",s),d(()=>s))))}deleteCustomer(e){let t=S(this.db,"customers",e);return n(E(t)).pipe(p(()=>{let s=this._customers().filter(c=>c.id!==e);this._customers.set(s),this.customersSubject.next(s),this.saveToCache(s)}),f(o=>(console.error("Error deleting customer:",o),d(()=>o))))}getCustomerById(e){return this.customersSubject.value.find(t=>t.id===e)}static{this.\u0275fac=function(t){return new(t||m)(j(N),j(R))}}static{this.\u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})();export{$ as a};
