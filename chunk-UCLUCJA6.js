import{G as u,L as f,Q as b,dc as j,f as d,gc as S,h as m,i as o,n,v as h}from"./chunk-VOZMRJF4.js";import{a as c,b as p}from"./chunk-7QOE2ANW.js";var D=(()=>{class a{setLoginState(t){this.loggedInSubject.next(t)}constructor(t){this.http=t,this.apiUrl=S.apiUrl,this.usersSubject=new d([]),this.users$=this.usersSubject.asObservable(),this.loggedInSubject=new d(localStorage.getItem("jjm_logged_in")==="true"),this.isLoggedIn$=this.loggedInSubject.asObservable()}hashPassword(t){let r=new TextEncoder().encode(t);return m(crypto.subtle.digest("SHA-256",r)).pipe(n(s=>Array.from(new Uint8Array(s)).map(i=>i.toString(16).padStart(2,"0")).join("")))}loadUsers(){this.http.get(`${this.apiUrl}/users`).subscribe({next:t=>{let e=t.map(r=>this.transformUser(r));e.length===0?this.initializeDefaultAdmin().subscribe():this.usersSubject.next(e)},error:t=>{console.error("Error fetching users:",t),t.status===404&&this.initializeDefaultAdmin().subscribe()}})}initializeDefaultAdmin(){return this.usersSubject.value.length>0?o(void 0):this.hashPassword("Gr*l0v3R").pipe(u(t=>{let e={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:t,role:"admin",createdAt:new Date,hasSubscription:!0};return this.http.post(`${this.apiUrl}/users`,e).pipe(n(r=>{let s=this.transformUser(r);this.usersSubject.next([s])}),h(r=>(console.warn("Could not save default admin to backend, using local only",r),this.usersSubject.next([e]),o(void 0))))}))}getUsers(){return this.users$}addUser(t){let e=p(c({},t),{createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system"});return this.hashPassword(t.password||"").pipe(u(r=>(e.password=r,this.http.post(`${this.apiUrl}/users`,e))),n(r=>{let s=this.transformUser(r),i=this.usersSubject.value;return this.usersSubject.next([...i,s]),s}))}updateUser(t){let e=c({},t);return(e.password?this.hashPassword(e.password):o(void 0)).pipe(u(s=>(s&&(e.password=s),this.http.put(`${this.apiUrl}/users/${e.id}`,e))),n(s=>{let i=this.transformUser(s),w=this.usersSubject.value.map(l=>l.id===i.id?i:l);return this.usersSubject.next(w),i}))}deleteUser(t){return this.http.delete(`${this.apiUrl}/users/${t}`).pipe(n(()=>{let e=this.usersSubject.value;this.usersSubject.next(e.filter(r=>r.id!==t))}))}getUserById(t){return this.usersSubject.value.find(e=>e.id===t)}validateCredentials(t,e){return this.hashPassword(e).pipe(u(r=>this.http.post(`${this.apiUrl}/login`,{username:t,password:r}).pipe(n(s=>s?this.transformUser(s):null),h(s=>o(null)))))}transformUser(t){let e=p(c({},t),{createdAt:this.parseDate(t.createdAt)});return(e.role==="admin"||e.username==="jjm143256789")&&(e.hasSubscription=!0),e}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):new Date(t):new Date}static{this.\u0275fac=function(e){return new(e||a)(b(j))}}static{this.\u0275prov=f({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{D as a};
