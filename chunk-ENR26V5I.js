import{a as p}from"./chunk-NJOMBBJH.js";import{H as o,M as g,R as h,ec as f,i as s,j as r,o as a,w as l}from"./chunk-Q3VW5VG2.js";import{g as u}from"./chunk-7QOE2ANW.js";var P=(()=>{class c{constructor(e){this.settingsService=e,this.sentimentPipeline=null,this.generationPipeline=null,this.isLoading=!1,this.localModelsSupported=!0,this.HF_API_URL="https://router.huggingface.co/v1/chat/completions",this.useGemmaApi=!0}getHfToken(){return this.settingsService.getHuggingFaceToken()||f.huggingFaceToken||null}setHuggingFaceToken(e){localStorage.setItem("hf_token",e),console.log("AI Service: Hugging Face token set")}isGemmaApiAvailable(){let e=this.getHfToken();return!!e&&e.startsWith("hf_")}setUseGemmaApi(e=!0){this.useGemmaApi=e,console.log(`AI Service: Using ${e?"Gemma API":"Local Models"}`)}init(){return this.sentimentPipeline&&this.generationPipeline||this.isLoading?r(void 0):this.localModelsSupported?(this.isLoading=!0,s(import("./chunk-C33ARDKD.js")).pipe(o(e=>u(this,null,function*(){let{pipeline:t}=e;this.sentimentPipeline||(this.sentimentPipeline=yield t("sentiment-analysis","Xenova/distilbert-base-uncased-finetuned-sst-2-english")),this.generationPipeline||(this.generationPipeline=yield t("text2text-generation","Xenova/LaMini-Flan-T5-77M"))})),a(()=>{console.log("AI Service: Local models loaded successfully"),this.isLoading=!1}),l(e=>(console.error("AI Service: Failed to load local AI models",e),console.log("AI Service: Falling back to Gemma API only"),this.localModelsSupported=!1,this.isLoading=!1,r(void 0))))):(console.log("AI Service: Local models not supported on this browser, using Gemma API only"),r(void 0))}analyzeSentiment(e){return this.init().pipe(o(()=>this.sentimentPipeline?s(this.sentimentPipeline(e)):r(null)),a(t=>Array.isArray(t)&&t.length>0?t[0]:null),l(t=>(console.error("AI Service: Sentiment analysis failed",t),r(null))))}generateText(e){return this.useGemmaApi&&this.getHfToken()?this.generateWithGemma(e).pipe(o(t=>t?r(t):(console.log("AI Service: Gemma API failed, falling back to local model"),this.generateWithLocalModel(e)))):this.generateWithLocalModel(e)}generateWithGemma(e){let t=this.getHfToken();return t?s(fetch(this.HF_API_URL,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:"google/gemma-2-2b-it",messages:[{role:"user",content:e}],max_tokens:150,temperature:.7})})).pipe(o(n=>u(this,null,function*(){if(!n.ok){let i=yield n.json().catch(()=>({}));if(console.error("AI Service: Gemma API error",n.status,i),n.status===503)throw console.log("AI Service: Gemma model is loading, retrying in 5s..."),yield new Promise(m=>setTimeout(m,5e3)),new Error("503 Service Unavailable");return null}return n.json()})),a(n=>n&&n.choices&&n.choices.length>0&&n.choices[0].message?.content?.trim()||null),l(n=>n.message==="503 Service Unavailable"?r(null):(console.error("AI Service: Gemma generation failed",n),r(null)))):(console.warn("AI Service: No Hugging Face token available for Gemma API"),r(null))}generateWithLocalModel(e){return this.init().pipe(o(()=>this.generationPipeline?s(this.generationPipeline(e,{max_new_tokens:60,temperature:.7,repetition_penalty:1.2})):r(null)),a(t=>Array.isArray(t)&&t.length>0?t[0].generated_text:null),l(t=>(console.error("AI Service: Local generation failed",t),r(null))))}chatWithGemma(e){let t=this.getHfToken();if(!t)return console.warn("AI Service: No Hugging Face token for Gemma chat"),r(null);let n=e.map(i=>({role:i.role==="model"?"assistant":i.role,content:i.content}));return s(fetch(this.HF_API_URL,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:"google/gemma-2-2b-it",messages:n,max_tokens:200,temperature:.7})})).pipe(o(i=>u(this,null,function*(){if(!i.ok){let m=yield i.json().catch(()=>({}));return console.error("AI Service: Gemma chat error",i.status,m),null}return i.json()})),a(i=>i&&i.choices&&i.choices.length>0&&i.choices[0].message?.content?.trim()||null),l(i=>(console.error("AI Service: Gemma chat failed",i),r(null))))}static{this.\u0275fac=function(t){return new(t||c)(h(p))}}static{this.\u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();export{P as a};
