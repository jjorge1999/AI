import{$c as w,P as L,U as m,Wc as l,Zc as f,_c as d,ad as A,cd as b,g as I,gd as x,i as j,j as u,ld as E,md as C,nd as U,o as y,x as D}from"./chunk-IZ5DWI6X.js";import{a as h,b as p,g as S}from"./chunk-7QOE2ANW.js";var O=(()=>{class n{get db(){return this.firebaseService.db}constructor(i,s){this.firebaseService=i,this.storeService=s,this.logsSubject=new I([]),this.logs$=this.logsSubject.asObservable(),this.storeService.activeStoreId$.subscribe(t=>{t?this.fetchLogs(t):this.logsSubject.next([])})}getCurrentUserId(){return localStorage.getItem("jjm_user_id")||"guest"}fetchLogs(i){let s=this.getCurrentUserId(),t=i||this.storeService.getActiveStoreId();if(!s||s==="guest"||!t){t||this.logsSubject.next([]);return}let a=l(this.db,"logs"),g=f(a,d("storeId","==",t),w("timestamp","desc"),A(200));b(g).then(e=>{let o=e.docs.map(c=>{let r=c.data();return p(h({id:c.id},r),{timestamp:r.timestamp?.toDate?r.timestamp.toDate():r.timestamp})});this.logsSubject.next(o)}).catch(e=>console.error("Error fetching logs:",e))}logActivity(i,s,t,a,g){let e=this.storeService.getActiveStoreId();if(!e){console.warn("Logging skipped: No active store selected.");return}let o={action:i,entityType:s,entityId:t,entityName:a,details:g,userId:this.getCurrentUserId(),storeId:e,timestamp:new Date};console.log("Logging activity:",o);let c=l(this.db,"logs");x(c,o).then(r=>{let v=h({id:r.id},o);console.log("Activity logged successfully:",v);let q=this.logsSubject.value;this.logsSubject.next([v,...q])}).catch(r=>{console.error("Error logging activity:",r),console.error("Failed log data:",o)})}getLogs(){return this.logs$}refreshLogs(){this.fetchLogs()}cleanupOldLogs(){let i=this.getCurrentUserId(),s=this.storeService.getActiveStoreId();if(!s)return u({message:"No store selected"});let t=new Date;t.setDate(t.getDate()-30);let a=l(this.db,"logs"),g=f(a,d("storeId","==",s),d("timestamp","<",t));return j(b(g)).pipe(y(e=>S(this,null,function*(){let o=E(this.db);return e.docs.forEach(c=>{o.delete(c.ref)}),yield o.commit(),{deleted:e.docs.length}})),D(e=>(console.error("Error cleaning up logs:",e),u({error:e.message}))))}static{this.\u0275fac=function(s){return new(s||n)(m(C),m(U))}}static{this.\u0275prov=L({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{O as a};
