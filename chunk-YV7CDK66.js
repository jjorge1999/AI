import{a as Gt}from"./chunk-PVOQLHET.js";import{a as zt}from"./chunk-MOXUB7QV.js";import{B as Be,C as Ye,D as A,E as ie,G as Ht,H as Je,I as $t,J as S,K as P,M as R,N as b,O as Xe,P as Qe,Q as X,S as Te,T as ue,U as se,Z as qt,a as Ct,b as Nt,c as Ge,d as Ie,e as Ot,f as Dt,g as w,h as Lt,i as Ut,j as Mt,k as Ft,l as xt,p as _e,q as Ee,r as Vt,s as ve,t as ce,u as jt,v as J,w as ze,x as Ke,y as Wt}from"./chunk-HLCCG4YZ.js";import{B as qe,D as At,K as U,La as ne,M,P as ge,Pb as re,U as Y,g as O,i as D,j as B,k as T,nc as Pt,o as ae,qc as Rt,rc as kt,x as L}from"./chunk-OKMRB5PS.js";import{a as g,b as _,d as $e,f as K,g as a}from"./chunk-7QOE2ANW.js";function cn(){return{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}}var un=cn,ln=new Ee("auth","Firebase",cn());var Pe=new Wt("@firebase/auth");function $n(r,...t){Pe.logLevel<=Ke.WARN&&Pe.warn(`Auth (${ie}): ${r}`,...t)}function ye(r,...t){Pe.logLevel<=Ke.ERROR&&Pe.error(`Auth (${ie}): ${r}`,...t)}function $(r,...t){throw _t(r,...t)}function Q(r,...t){return _t(r,...t)}function dn(r,t,e){let n=_(g({},un()),{[t]:e});return new Ee("auth","Firebase",n).create(t,{appName:r.name})}function H(r){return dn(r,"operation-not-supported-in-this-environment","Operations that alter the current user are not supported in conjunction with FirebaseServerApp")}function _t(r,...t){if(typeof r!="string"){let e=t[0],n=[...t.slice(1)];return n[0]&&(n[0].appName=r.name),r._errorFactory.create(e,...n)}return ln.create(r,...t)}function f(r,t,...e){if(!r)throw _t(t,...e)}function F(r){let t="INTERNAL ASSERTION FAILED: "+r;throw ye(t),new Error(t)}function q(r,t){r||F(t)}function nt(){return typeof self<"u"&&self.location?.href||""}function qn(){return Kt()==="http:"||Kt()==="https:"}function Kt(){return typeof self<"u"&&self.location?.protocol||null}function Gn(){return typeof navigator<"u"&&navigator&&"onLine"in navigator&&typeof navigator.onLine=="boolean"&&(qn()||Mt()||"connection"in navigator)?navigator.onLine:!0}function zn(){if(typeof navigator>"u")return null;let r=navigator;return r.languages&&r.languages[0]||r.language||null}var Z=class{constructor(t,e){this.shortDelay=t,this.longDelay=e,q(e>t,"Short delay should be less than long delay!"),this.isMobile=Lt()||Ft()}get(){return Gn()?this.isMobile?this.longDelay:this.shortDelay:Math.min(5e3,this.shortDelay)}};function Et(r,t){q(r.emulator,"Emulator should always be set here");let{url:e}=r.emulator;return t?`${e}${t.startsWith("/")?t.slice(1):t}`:e}var Re=class{static initialize(t,e,n){this.fetchImpl=t,e&&(this.headersImpl=e),n&&(this.responseImpl=n)}static fetch(){if(this.fetchImpl)return this.fetchImpl;if(typeof self<"u"&&"fetch"in self)return self.fetch;if(typeof globalThis<"u"&&globalThis.fetch)return globalThis.fetch;if(typeof fetch<"u")return fetch;F("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static headers(){if(this.headersImpl)return this.headersImpl;if(typeof self<"u"&&"Headers"in self)return self.Headers;if(typeof globalThis<"u"&&globalThis.Headers)return globalThis.Headers;if(typeof Headers<"u")return Headers;F("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static response(){if(this.responseImpl)return this.responseImpl;if(typeof self<"u"&&"Response"in self)return self.Response;if(typeof globalThis<"u"&&globalThis.Response)return globalThis.Response;if(typeof Response<"u")return Response;F("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}};var Kn={CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_PASSWORD:"wrong-password",MISSING_PASSWORD:"missing-password",INVALID_LOGIN_CREDENTIALS:"invalid-credential",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_REQ_TYPE:"internal-error",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",PASSWORD_DOES_NOT_MEET_REQUIREMENTS:"password-does-not-meet-requirements",INVALID_CODE:"invalid-verification-code",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_SESSION_INFO:"missing-verification-id",SESSION_EXPIRED:"code-expired",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",ADMIN_ONLY_OPERATION:"admin-restricted-operation",INVALID_MFA_PENDING_CREDENTIAL:"invalid-multi-factor-session",MFA_ENROLLMENT_NOT_FOUND:"multi-factor-info-not-found",MISSING_MFA_ENROLLMENT_ID:"missing-multi-factor-info",MISSING_MFA_PENDING_CREDENTIAL:"missing-multi-factor-session",SECOND_FACTOR_EXISTS:"second-factor-already-in-use",SECOND_FACTOR_LIMIT_EXCEEDED:"maximum-second-factor-count-exceeded",BLOCKING_FUNCTION_ERROR_RESPONSE:"internal-error",RECAPTCHA_NOT_ENABLED:"recaptcha-not-enabled",MISSING_RECAPTCHA_TOKEN:"missing-recaptcha-token",INVALID_RECAPTCHA_TOKEN:"invalid-recaptcha-token",INVALID_RECAPTCHA_ACTION:"invalid-recaptcha-action",MISSING_CLIENT_TYPE:"missing-client-type",MISSING_RECAPTCHA_VERSION:"missing-recaptcha-version",INVALID_RECAPTCHA_VERSION:"invalid-recaptcha-version",INVALID_REQ_TYPE:"invalid-req-type"};var Bn=["/v1/accounts:signInWithCustomToken","/v1/accounts:signInWithEmailLink","/v1/accounts:signInWithIdp","/v1/accounts:signInWithPassword","/v1/accounts:signInWithPhoneNumber","/v1/token"],Yn=new Z(3e4,6e4);function Ve(r,t){return r.tenantId&&!t.tenantId?_(g({},t),{tenantId:r.tenantId}):t}function oe(s,o,c,u){return a(this,arguments,function*(r,t,e,n,i={}){return hn(r,i,()=>a(this,null,function*(){let l={},h={};n&&(t==="GET"?h=n:l={body:JSON.stringify(n)});let d=ce(g({key:r.config.apiKey},h)).slice(1),p=yield r._getAdditionalHeaders();p["Content-Type"]="application/json",r.languageCode&&(p["X-Firebase-Locale"]=r.languageCode);let I=g({method:t,headers:p},l);return Ut()||(I.referrerPolicy="no-referrer"),r.emulatorConfig&&Ie(r.emulatorConfig.host)&&(I.credentials="include"),Re.fetch()(yield fn(r,r.config.apiHost,e,d),I)}))})}function hn(r,t,e){return a(this,null,function*(){r._canInitEmulator=!1;let n=g(g({},Kn),t);try{let i=new rt(r),s=yield Promise.race([e(),i.promise]);i.clearNetworkTimeout();let o=yield s.json();if("needConfirmation"in o)throw Se(r,"account-exists-with-different-credential",o);if(s.ok&&!("errorMessage"in o))return o;{let c=s.ok?o.errorMessage:o.error.message,[u,l]=c.split(" : ");if(u==="FEDERATED_USER_ID_ALREADY_LINKED")throw Se(r,"credential-already-in-use",o);if(u==="EMAIL_EXISTS")throw Se(r,"email-already-in-use",o);if(u==="USER_DISABLED")throw Se(r,"user-disabled",o);let h=n[u]||u.toLowerCase().replace(/[_\s]+/g,"-");if(l)throw dn(r,h,l);$(r,h)}}catch(i){if(i instanceof _e)throw i;$(r,"network-request-failed",{message:String(i)})}})}function pn(s,o,c,u){return a(this,arguments,function*(r,t,e,n,i={}){let l=yield oe(r,t,e,n,i);return"mfaPendingCredential"in l&&$(r,"multi-factor-auth-required",{_serverResponse:l}),l})}function fn(r,t,e,n){return a(this,null,function*(){let i=`${t}${e}?${n}`,s=r,o=s.config.emulator?Et(r.config,i):`${r.config.apiScheme}://${i}`;return Bn.includes(e)&&(yield s._persistenceManagerAvailable,s._getPersistenceType()==="COOKIE")?s._getPersistence()._getFinalTarget(o).toString():o})}var rt=class{clearNetworkTimeout(){clearTimeout(this.timer)}constructor(t){this.auth=t,this.timer=null,this.promise=new Promise((e,n)=>{this.timer=setTimeout(()=>n(Q(this.auth,"network-request-failed")),Yn.get())})}};function Se(r,t,e){let n={appName:r.name};e.email&&(n.email=e.email),e.phoneNumber&&(n.phoneNumber=e.phoneNumber);let i=Q(r,t,n);return i.customData._tokenResponse=e,i}function Jn(r,t){return a(this,null,function*(){return oe(r,"POST","/v1/accounts:delete",t)})}function ke(r,t){return a(this,null,function*(){return oe(r,"POST","/v1/accounts:lookup",t)})}function le(r){if(r)try{let t=new Date(Number(r));if(!isNaN(t.getTime()))return t.toUTCString()}catch{}}function mn(r,t=!1){return a(this,null,function*(){let e=J(r),n=yield e.getIdToken(t),i=vt(n);f(i&&i.exp&&i.auth_time&&i.iat,e.auth,"internal-error");let s=typeof i.firebase=="object"?i.firebase:void 0,o=s?.sign_in_provider;return{claims:i,token:n,authTime:le(Ze(i.auth_time)),issuedAtTime:le(Ze(i.iat)),expirationTime:le(Ze(i.exp)),signInProvider:o||null,signInSecondFactor:s?.sign_in_second_factor||null}})}function Ze(r){return Number(r)*1e3}function vt(r){let[t,e,n]=r.split(".");if(t===void 0||e===void 0||n===void 0)return ye("JWT malformed, contained fewer than 3 sections"),null;try{let i=Ct(e);return i?JSON.parse(i):(ye("Failed to decode base64 JWT payload"),null)}catch(i){return ye("Caught error parsing JWT payload as JSON",i?.toString()),null}}function Bt(r){let t=vt(r);return f(t,"internal-error"),f(typeof t.exp<"u","internal-error"),f(typeof t.iat<"u","internal-error"),Number(t.exp)-Number(t.iat)}function he(r,t,e=!1){return a(this,null,function*(){if(e)return t;try{return yield t}catch(n){throw n instanceof _e&&Xn(n)&&r.auth.currentUser===r&&(yield r.auth.signOut()),n}})}function Xn({code:r}){return r==="auth/user-disabled"||r==="auth/user-token-expired"}var it=class{constructor(t){this.user=t,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,this.timerId!==null&&clearTimeout(this.timerId))}getInterval(t){if(t){let e=this.errorBackoff;return this.errorBackoff=Math.min(this.errorBackoff*2,96e4),e}else{this.errorBackoff=3e4;let n=(this.user.stsTokenManager.expirationTime??0)-Date.now()-3e5;return Math.max(0,n)}}schedule(t=!1){if(!this.isRunning)return;let e=this.getInterval(t);this.timerId=setTimeout(()=>a(this,null,function*(){yield this.iteration()}),e)}iteration(){return a(this,null,function*(){try{yield this.user.getIdToken(!0)}catch(t){t?.code==="auth/network-request-failed"&&this.schedule(!0);return}this.schedule()})}};var pe=class{constructor(t,e){this.createdAt=t,this.lastLoginAt=e,this._initializeTime()}_initializeTime(){this.lastSignInTime=le(this.lastLoginAt),this.creationTime=le(this.createdAt)}_copy(t){this.createdAt=t.createdAt,this.lastLoginAt=t.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}};function Ce(r){return a(this,null,function*(){let t=r.auth,e=yield r.getIdToken(),n=yield he(r,ke(t,{idToken:e}));f(n?.users.length,t,"internal-error");let i=n.users[0];r._notifyReloadListener(i);let s=i.providerUserInfo?.length?In(i.providerUserInfo):[],o=Qn(r.providerData,s),c=r.isAnonymous,u=!(r.email&&i.passwordHash)&&!o?.length,l=c?u:!1,h={uid:i.localId,displayName:i.displayName||null,photoURL:i.photoUrl||null,email:i.email||null,emailVerified:i.emailVerified||!1,phoneNumber:i.phoneNumber||null,tenantId:i.tenantId||null,providerData:o,metadata:new pe(i.createdAt,i.lastLoginAt),isAnonymous:l};Object.assign(r,h)})}function gn(r){return a(this,null,function*(){let t=J(r);yield Ce(t),yield t.auth._persistUserIfCurrent(t),t.auth._notifyListenersIfCurrent(t)})}function Qn(r,t){return[...r.filter(n=>!t.some(i=>i.providerId===n.providerId)),...t]}function In(r){return r.map(n=>{var i=n,{providerId:t}=i,e=$e(i,["providerId"]);return{providerId:t,uid:e.rawId||"",displayName:e.displayName||null,email:e.email||null,phoneNumber:e.phoneNumber||null,photoURL:e.photoUrl||null}})}function Zn(r,t){return a(this,null,function*(){let e=yield hn(r,{},()=>a(this,null,function*(){let n=ce({grant_type:"refresh_token",refresh_token:t}).slice(1),{tokenApiHost:i,apiKey:s}=r.config,o=yield fn(r,i,"/v1/token",`key=${s}`),c=yield r._getAdditionalHeaders();c["Content-Type"]="application/x-www-form-urlencoded";let u={method:"POST",headers:c,body:n};return r.emulatorConfig&&Ie(r.emulatorConfig.host)&&(u.credentials="include"),Re.fetch()(o,u)}));return{accessToken:e.access_token,expiresIn:e.expires_in,refreshToken:e.refresh_token}})}function er(r,t){return a(this,null,function*(){return oe(r,"POST","/v2/accounts:revokeToken",Ve(r,t))})}var de=class r{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(t){f(t.idToken,"internal-error"),f(typeof t.idToken<"u","internal-error"),f(typeof t.refreshToken<"u","internal-error");let e="expiresIn"in t&&typeof t.expiresIn<"u"?Number(t.expiresIn):Bt(t.idToken);this.updateTokensAndExpiration(t.idToken,t.refreshToken,e)}updateFromIdToken(t){f(t.length!==0,"internal-error");let e=Bt(t);this.updateTokensAndExpiration(t,null,e)}getToken(t,e=!1){return a(this,null,function*(){return!e&&this.accessToken&&!this.isExpired?this.accessToken:(f(this.refreshToken,t,"user-token-expired"),this.refreshToken?(yield this.refresh(t,this.refreshToken),this.accessToken):null)})}clearRefreshToken(){this.refreshToken=null}refresh(t,e){return a(this,null,function*(){let{accessToken:n,refreshToken:i,expiresIn:s}=yield Zn(t,e);this.updateTokensAndExpiration(n,i,Number(s))})}updateTokensAndExpiration(t,e,n){this.refreshToken=e||null,this.accessToken=t||null,this.expirationTime=Date.now()+n*1e3}static fromJSON(t,e){let{refreshToken:n,accessToken:i,expirationTime:s}=e,o=new r;return n&&(f(typeof n=="string","internal-error",{appName:t}),o.refreshToken=n),i&&(f(typeof i=="string","internal-error",{appName:t}),o.accessToken=i),s&&(f(typeof s=="number","internal-error",{appName:t}),o.expirationTime=s),o}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(t){this.accessToken=t.accessToken,this.refreshToken=t.refreshToken,this.expirationTime=t.expirationTime}_clone(){return Object.assign(new r,this.toJSON())}_performRefresh(){return F("not implemented")}};function j(r,t){f(typeof r=="string"||typeof r>"u","internal-error",{appName:t})}var W=class r{constructor(s){var o=s,{uid:t,auth:e,stsTokenManager:n}=o,i=$e(o,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new it(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=t,this.auth=e,this.stsTokenManager=n,this.accessToken=n.accessToken,this.displayName=i.displayName||null,this.email=i.email||null,this.emailVerified=i.emailVerified||!1,this.phoneNumber=i.phoneNumber||null,this.photoURL=i.photoURL||null,this.isAnonymous=i.isAnonymous||!1,this.tenantId=i.tenantId||null,this.providerData=i.providerData?[...i.providerData]:[],this.metadata=new pe(i.createdAt||void 0,i.lastLoginAt||void 0)}getIdToken(t){return a(this,null,function*(){let e=yield he(this,this.stsTokenManager.getToken(this.auth,t));return f(e,this.auth,"internal-error"),this.accessToken!==e&&(this.accessToken=e,yield this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),e})}getIdTokenResult(t){return mn(this,t)}reload(){return gn(this)}_assign(t){this!==t&&(f(this.uid===t.uid,this.auth,"internal-error"),this.displayName=t.displayName,this.photoURL=t.photoURL,this.email=t.email,this.emailVerified=t.emailVerified,this.phoneNumber=t.phoneNumber,this.isAnonymous=t.isAnonymous,this.tenantId=t.tenantId,this.providerData=t.providerData.map(e=>g({},e)),this.metadata._copy(t.metadata),this.stsTokenManager._assign(t.stsTokenManager))}_clone(t){let e=new r(_(g({},this),{auth:t,stsTokenManager:this.stsTokenManager._clone()}));return e.metadata._copy(this.metadata),e}_onReload(t){f(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=t,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(t){this.reloadListener?this.reloadListener(t):this.reloadUserInfo=t}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}_updateTokensIfNecessary(t,e=!1){return a(this,null,function*(){let n=!1;t.idToken&&t.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(t),n=!0),e&&(yield Ce(this)),yield this.auth._persistUserIfCurrent(this),n&&this.auth._notifyListenersIfCurrent(this)})}delete(){return a(this,null,function*(){if(A(this.auth.app))return Promise.reject(H(this.auth));let t=yield this.getIdToken();return yield he(this,Jn(this.auth,{idToken:t})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()})}toJSON(){return _(g({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map(t=>g({},t)),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(t,e){let n=e.displayName??void 0,i=e.email??void 0,s=e.phoneNumber??void 0,o=e.photoURL??void 0,c=e.tenantId??void 0,u=e._redirectEventId??void 0,l=e.createdAt??void 0,h=e.lastLoginAt??void 0,{uid:d,emailVerified:p,isAnonymous:I,providerData:k,stsTokenManager:y}=e;f(d&&y,t,"internal-error");let G=de.fromJSON(this.name,y);f(typeof d=="string",t,"internal-error"),j(n,t.name),j(i,t.name),f(typeof p=="boolean",t,"internal-error"),f(typeof I=="boolean",t,"internal-error"),j(s,t.name),j(o,t.name),j(c,t.name),j(u,t.name),j(l,t.name),j(h,t.name);let V=new r({uid:d,auth:t,email:i,emailVerified:p,displayName:n,isAnonymous:I,photoURL:o,phoneNumber:s,tenantId:c,stsTokenManager:G,createdAt:l,lastLoginAt:h});return k&&Array.isArray(k)&&(V.providerData=k.map(C=>g({},C))),u&&(V._redirectEventId=u),V}static _fromIdTokenResponse(t,e,n=!1){return a(this,null,function*(){let i=new de;i.updateFromServerResponse(e);let s=new r({uid:e.localId,auth:t,stsTokenManager:i,isAnonymous:n});return yield Ce(s),s})}static _fromGetAccountInfoResponse(t,e,n){return a(this,null,function*(){let i=e.users[0];f(i.localId!==void 0,"internal-error");let s=i.providerUserInfo!==void 0?In(i.providerUserInfo):[],o=!(i.email&&i.passwordHash)&&!s?.length,c=new de;c.updateFromIdToken(n);let u=new r({uid:i.localId,auth:t,stsTokenManager:c,isAnonymous:o}),l={uid:i.localId,displayName:i.displayName||null,photoURL:i.photoUrl||null,email:i.email||null,emailVerified:i.emailVerified||!1,phoneNumber:i.phoneNumber||null,tenantId:i.tenantId||null,providerData:s,metadata:new pe(i.createdAt,i.lastLoginAt),isAnonymous:!(i.email&&i.passwordHash)&&!s?.length};return Object.assign(u,l),u})}};var Yt=new Map;function x(r){q(r instanceof Function,"Expected a class definition");let t=Yt.get(r);return t?(q(t instanceof r,"Instance stored in cache mismatched with class"),t):(t=new r,Yt.set(r,t),t)}var tr=(()=>{class r{constructor(){this.type="NONE",this.storage={}}_isAvailable(){return a(this,null,function*(){return!0})}_set(e,n){return a(this,null,function*(){this.storage[e]=n})}_get(e){return a(this,null,function*(){let n=this.storage[e];return n===void 0?null:n})}_remove(e){return a(this,null,function*(){delete this.storage[e]})}_addListener(e,n){}_removeListener(e,n){}}return r.type="NONE",r})(),st=tr;function we(r,t,e){return`firebase:${r}:${t}:${e}`}var Ne=class r{constructor(t,e,n){this.persistence=t,this.auth=e,this.userKey=n;let{config:i,name:s}=this.auth;this.fullUserKey=we(this.userKey,i.apiKey,s),this.fullPersistenceKey=we("persistence",i.apiKey,s),this.boundEventHandler=e._onStorageEvent.bind(e),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(t){return this.persistence._set(this.fullUserKey,t.toJSON())}getCurrentUser(){return a(this,null,function*(){let t=yield this.persistence._get(this.fullUserKey);if(!t)return null;if(typeof t=="string"){let e=yield ke(this.auth,{idToken:t}).catch(()=>{});return e?W._fromGetAccountInfoResponse(this.auth,e,t):null}return W._fromJSON(this.auth,t)})}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}setPersistence(t){return a(this,null,function*(){if(this.persistence===t)return;let e=yield this.getCurrentUser();if(yield this.removeCurrentUser(),this.persistence=t,e)return this.setCurrentUser(e)})}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static create(t,e,n="authUser"){return a(this,null,function*(){if(!e.length)return new r(x(st),t,n);let i=(yield Promise.all(e.map(l=>a(this,null,function*(){if(yield l._isAvailable())return l})))).filter(l=>l),s=i[0]||x(st),o=we(n,t.config.apiKey,t.name),c=null;for(let l of e)try{let h=yield l._get(o);if(h){let d;if(typeof h=="string"){let p=yield ke(t,{idToken:h}).catch(()=>{});if(!p)break;d=yield W._fromGetAccountInfoResponse(t,p,h)}else d=W._fromJSON(t,h);l!==s&&(c=d),s=l;break}}catch{}let u=i.filter(l=>l._shouldAllowMigration);return!s._shouldAllowMigration||!u.length?new r(s,t,n):(s=u[0],c&&(yield s._set(o,c.toJSON())),yield Promise.all(e.map(l=>a(this,null,function*(){if(l!==s)try{yield l._remove(o)}catch{}}))),new r(s,t,n))})}};function Jt(r){let t=r.toLowerCase();if(t.includes("opera/")||t.includes("opr/")||t.includes("opios/"))return"Opera";if(Tn(t))return"IEMobile";if(t.includes("msie")||t.includes("trident/"))return"IE";if(t.includes("edge/"))return"Edge";if(_n(t))return"Firefox";if(t.includes("silk/"))return"Silk";if(yn(t))return"Blackberry";if(wn(t))return"Webos";if(En(t))return"Safari";if((t.includes("chrome/")||vn(t))&&!t.includes("edge/"))return"Chrome";if(Sn(t))return"Android";{let e=/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/,n=r.match(e);if(n?.length===2)return n[1]}return"Other"}function _n(r=w()){return/firefox\//i.test(r)}function En(r=w()){let t=r.toLowerCase();return t.includes("safari/")&&!t.includes("chrome/")&&!t.includes("crios/")&&!t.includes("android")}function vn(r=w()){return/crios\//i.test(r)}function Tn(r=w()){return/iemobile/i.test(r)}function Sn(r=w()){return/android/i.test(r)}function yn(r=w()){return/blackberry/i.test(r)}function wn(r=w()){return/webos/i.test(r)}function Tt(r=w()){return/iphone|ipad|ipod/i.test(r)||/macintosh/i.test(r)&&/mobile/i.test(r)}function nr(r=w()){return Tt(r)&&!!window.navigator?.standalone}function rr(){return xt()&&document.documentMode===10}function bn(r=w()){return Tt(r)||Sn(r)||wn(r)||yn(r)||/windows phone/i.test(r)||Tn(r)}function An(r,t=[]){let e;switch(r){case"Browser":e=Jt(w());break;case"Worker":e=`${Jt(w())}-${r}`;break;default:e=r}let n=t.length?t.join(","):"FirebaseCore-web";return`${e}/JsCore/${ie}/${n}`}var ot=class{constructor(t){this.auth=t,this.queue=[]}pushCallback(t,e){let n=s=>new Promise((o,c)=>{try{let u=t(s);o(u)}catch(u){c(u)}});n.onAbort=e,this.queue.push(n);let i=this.queue.length-1;return()=>{this.queue[i]=()=>Promise.resolve()}}runMiddleware(t){return a(this,null,function*(){if(this.auth.currentUser===t)return;let e=[];try{for(let n of this.queue)yield n(t),n.onAbort&&e.push(n.onAbort)}catch(n){e.reverse();for(let i of e)try{i()}catch{}throw this.auth._errorFactory.create("login-blocked",{originalMessage:n?.message})}})}};function ir(e){return a(this,arguments,function*(r,t={}){return oe(r,"GET","/v2/passwordPolicy",Ve(r,t))})}var sr=6,at=class{constructor(t){let e=t.customStrengthOptions;this.customStrengthOptions={},this.customStrengthOptions.minPasswordLength=e.minPasswordLength??sr,e.maxPasswordLength&&(this.customStrengthOptions.maxPasswordLength=e.maxPasswordLength),e.containsLowercaseCharacter!==void 0&&(this.customStrengthOptions.containsLowercaseLetter=e.containsLowercaseCharacter),e.containsUppercaseCharacter!==void 0&&(this.customStrengthOptions.containsUppercaseLetter=e.containsUppercaseCharacter),e.containsNumericCharacter!==void 0&&(this.customStrengthOptions.containsNumericCharacter=e.containsNumericCharacter),e.containsNonAlphanumericCharacter!==void 0&&(this.customStrengthOptions.containsNonAlphanumericCharacter=e.containsNonAlphanumericCharacter),this.enforcementState=t.enforcementState,this.enforcementState==="ENFORCEMENT_STATE_UNSPECIFIED"&&(this.enforcementState="OFF"),this.allowedNonAlphanumericCharacters=t.allowedNonAlphanumericCharacters?.join("")??"",this.forceUpgradeOnSignin=t.forceUpgradeOnSignin??!1,this.schemaVersion=t.schemaVersion}validatePassword(t){let e={isValid:!0,passwordPolicy:this};return this.validatePasswordLengthOptions(t,e),this.validatePasswordCharacterOptions(t,e),e.isValid&&(e.isValid=e.meetsMinPasswordLength??!0),e.isValid&&(e.isValid=e.meetsMaxPasswordLength??!0),e.isValid&&(e.isValid=e.containsLowercaseLetter??!0),e.isValid&&(e.isValid=e.containsUppercaseLetter??!0),e.isValid&&(e.isValid=e.containsNumericCharacter??!0),e.isValid&&(e.isValid=e.containsNonAlphanumericCharacter??!0),e}validatePasswordLengthOptions(t,e){let n=this.customStrengthOptions.minPasswordLength,i=this.customStrengthOptions.maxPasswordLength;n&&(e.meetsMinPasswordLength=t.length>=n),i&&(e.meetsMaxPasswordLength=t.length<=i)}validatePasswordCharacterOptions(t,e){this.updatePasswordCharacterOptionsStatuses(e,!1,!1,!1,!1);let n;for(let i=0;i<t.length;i++)n=t.charAt(i),this.updatePasswordCharacterOptionsStatuses(e,n>="a"&&n<="z",n>="A"&&n<="Z",n>="0"&&n<="9",this.allowedNonAlphanumericCharacters.includes(n))}updatePasswordCharacterOptionsStatuses(t,e,n,i,s){this.customStrengthOptions.containsLowercaseLetter&&(t.containsLowercaseLetter||(t.containsLowercaseLetter=e)),this.customStrengthOptions.containsUppercaseLetter&&(t.containsUppercaseLetter||(t.containsUppercaseLetter=n)),this.customStrengthOptions.containsNumericCharacter&&(t.containsNumericCharacter||(t.containsNumericCharacter=i)),this.customStrengthOptions.containsNonAlphanumericCharacter&&(t.containsNonAlphanumericCharacter||(t.containsNonAlphanumericCharacter=s))}};var ct=class{constructor(t,e,n,i){this.app=t,this.heartbeatServiceProvider=e,this.appCheckServiceProvider=n,this.config=i,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new Oe(this),this.idTokenSubscription=new Oe(this),this.beforeStateQueue=new ot(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION=1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=ln,this._agentRecaptchaConfig=null,this._tenantRecaptchaConfigs={},this._projectPasswordPolicy=null,this._tenantPasswordPolicies={},this._resolvePersistenceManagerAvailable=void 0,this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=t.name,this.clientVersion=i.sdkClientVersion,this._persistenceManagerAvailable=new Promise(s=>this._resolvePersistenceManagerAvailable=s)}_initializeWithPersistence(t,e){return e&&(this._popupRedirectResolver=x(e)),this._initializationPromise=this.queue(()=>a(this,null,function*(){if(!this._deleted&&(this.persistenceManager=yield Ne.create(this,t),this._resolvePersistenceManagerAvailable?.(),!this._deleted)){if(this._popupRedirectResolver?._shouldInitProactively)try{yield this._popupRedirectResolver._initialize(this)}catch{}yield this.initializeCurrentUser(e),this.lastNotifiedUid=this.currentUser?.uid||null,!this._deleted&&(this._isInitialized=!0)}})),this._initializationPromise}_onStorageEvent(){return a(this,null,function*(){if(this._deleted)return;let t=yield this.assertedPersistence.getCurrentUser();if(!(!this.currentUser&&!t)){if(this.currentUser&&t&&this.currentUser.uid===t.uid){this._currentUser._assign(t),yield this.currentUser.getIdToken();return}yield this._updateCurrentUser(t,!0)}})}initializeCurrentUserFromIdToken(t){return a(this,null,function*(){try{let e=yield ke(this,{idToken:t}),n=yield W._fromGetAccountInfoResponse(this,e,t);yield this.directlySetCurrentUser(n)}catch(e){console.warn("FirebaseServerApp could not login user with provided authIdToken: ",e),yield this.directlySetCurrentUser(null)}})}initializeCurrentUser(t){return a(this,null,function*(){if(A(this.app)){let s=this.app.settings.authIdToken;return s?new Promise(o=>{setTimeout(()=>this.initializeCurrentUserFromIdToken(s).then(o,o))}):this.directlySetCurrentUser(null)}let e=yield this.assertedPersistence.getCurrentUser(),n=e,i=!1;if(t&&this.config.authDomain){yield this.getOrInitRedirectPersistenceManager();let s=this.redirectUser?._redirectEventId,o=n?._redirectEventId,c=yield this.tryRedirectSignIn(t);(!s||s===o)&&c?.user&&(n=c.user,i=!0)}if(!n)return this.directlySetCurrentUser(null);if(!n._redirectEventId){if(i)try{yield this.beforeStateQueue.runMiddleware(n)}catch(s){n=e,this._popupRedirectResolver._overrideRedirectResult(this,()=>Promise.reject(s))}return n?this.reloadAndSetCurrentUserOrClear(n):this.directlySetCurrentUser(null)}return f(this._popupRedirectResolver,this,"argument-error"),yield this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===n._redirectEventId?this.directlySetCurrentUser(n):this.reloadAndSetCurrentUserOrClear(n)})}tryRedirectSignIn(t){return a(this,null,function*(){let e=null;try{e=yield this._popupRedirectResolver._completeRedirectFn(this,t,!0)}catch{yield this._setRedirectUser(null)}return e})}reloadAndSetCurrentUserOrClear(t){return a(this,null,function*(){try{yield Ce(t)}catch(e){if(e?.code!=="auth/network-request-failed")return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(t)})}useDeviceLanguage(){this.languageCode=zn()}_delete(){return a(this,null,function*(){this._deleted=!0})}updateCurrentUser(t){return a(this,null,function*(){if(A(this.app))return Promise.reject(H(this));let e=t?J(t):null;return e&&f(e.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(e&&e._clone(this))})}_updateCurrentUser(t,e=!1){return a(this,null,function*(){if(!this._deleted)return t&&f(this.tenantId===t.tenantId,this,"tenant-id-mismatch"),e||(yield this.beforeStateQueue.runMiddleware(t)),this.queue(()=>a(this,null,function*(){yield this.directlySetCurrentUser(t),this.notifyAuthListeners()}))})}signOut(){return a(this,null,function*(){return A(this.app)?Promise.reject(H(this)):(yield this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&(yield this._setRedirectUser(null)),this._updateCurrentUser(null,!0))})}setPersistence(t){return A(this.app)?Promise.reject(H(this)):this.queue(()=>a(this,null,function*(){yield this.assertedPersistence.setPersistence(x(t))}))}_getRecaptchaConfig(){return this.tenantId==null?this._agentRecaptchaConfig:this._tenantRecaptchaConfigs[this.tenantId]}validatePassword(t){return a(this,null,function*(){this._getPasswordPolicyInternal()||(yield this._updatePasswordPolicy());let e=this._getPasswordPolicyInternal();return e.schemaVersion!==this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION?Promise.reject(this._errorFactory.create("unsupported-password-policy-schema-version",{})):e.validatePassword(t)})}_getPasswordPolicyInternal(){return this.tenantId===null?this._projectPasswordPolicy:this._tenantPasswordPolicies[this.tenantId]}_updatePasswordPolicy(){return a(this,null,function*(){let t=yield ir(this),e=new at(t);this.tenantId===null?this._projectPasswordPolicy=e:this._tenantPasswordPolicies[this.tenantId]=e})}_getPersistenceType(){return this.assertedPersistence.persistence.type}_getPersistence(){return this.assertedPersistence.persistence}_updateErrorMap(t){this._errorFactory=new Ee("auth","Firebase",t())}onAuthStateChanged(t,e,n){return this.registerStateListener(this.authStateSubscription,t,e,n)}beforeAuthStateChanged(t,e){return this.beforeStateQueue.pushCallback(t,e)}onIdTokenChanged(t,e,n){return this.registerStateListener(this.idTokenSubscription,t,e,n)}authStateReady(){return new Promise((t,e)=>{if(this.currentUser)t();else{let n=this.onAuthStateChanged(()=>{n(),t()},e)}})}revokeAccessToken(t){return a(this,null,function*(){if(this.currentUser){let e=yield this.currentUser.getIdToken(),n={providerId:"apple.com",tokenType:"ACCESS_TOKEN",token:t,idToken:e};this.tenantId!=null&&(n.tenantId=this.tenantId),yield er(this,n)}})}toJSON(){return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:this._currentUser?.toJSON()}}_setRedirectUser(t,e){return a(this,null,function*(){let n=yield this.getOrInitRedirectPersistenceManager(e);return t===null?n.removeCurrentUser():n.setCurrentUser(t)})}getOrInitRedirectPersistenceManager(t){return a(this,null,function*(){if(!this.redirectPersistenceManager){let e=t&&x(t)||this._popupRedirectResolver;f(e,this,"argument-error"),this.redirectPersistenceManager=yield Ne.create(this,[x(e._redirectPersistence)],"redirectUser"),this.redirectUser=yield this.redirectPersistenceManager.getCurrentUser()}return this.redirectPersistenceManager})}_redirectUserForId(t){return a(this,null,function*(){return this._isInitialized&&(yield this.queue(()=>a(this,null,function*(){}))),this._currentUser?._redirectEventId===t?this._currentUser:this.redirectUser?._redirectEventId===t?this.redirectUser:null})}_persistUserIfCurrent(t){return a(this,null,function*(){if(t===this.currentUser)return this.queue(()=>a(this,null,function*(){return this.directlySetCurrentUser(t)}))})}_notifyListenersIfCurrent(t){t===this.currentUser&&this.notifyAuthListeners()}_key(){return`${this.config.authDomain}:${this.config.apiKey}:${this.name}`}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){if(!this._isInitialized)return;this.idTokenSubscription.next(this.currentUser);let t=this.currentUser?.uid??null;this.lastNotifiedUid!==t&&(this.lastNotifiedUid=t,this.authStateSubscription.next(this.currentUser))}registerStateListener(t,e,n,i){if(this._deleted)return()=>{};let s=typeof e=="function"?e:e.next.bind(e),o=!1,c=this._isInitialized?Promise.resolve():this._initializationPromise;if(f(c,this,"internal-error"),c.then(()=>{o||s(this.currentUser)}),typeof e=="function"){let u=t.addObserver(e,n,i);return()=>{o=!0,u()}}else{let u=t.addObserver(e);return()=>{o=!0,u()}}}directlySetCurrentUser(t){return a(this,null,function*(){this.currentUser&&this.currentUser!==t&&this._currentUser._stopProactiveRefresh(),t&&this.isProactiveRefreshEnabled&&t._startProactiveRefresh(),this.currentUser=t,t?yield this.assertedPersistence.setCurrentUser(t):yield this.assertedPersistence.removeCurrentUser()})}queue(t){return this.operations=this.operations.then(t,t),this.operations}get assertedPersistence(){return f(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(t){!t||this.frameworks.includes(t)||(this.frameworks.push(t),this.frameworks.sort(),this.clientVersion=An(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}_getAdditionalHeaders(){return a(this,null,function*(){let t={"X-Client-Version":this.clientVersion};this.app.options.appId&&(t["X-Firebase-gmpid"]=this.app.options.appId);let e=yield this.heartbeatServiceProvider.getImmediate({optional:!0})?.getHeartbeatsHeader();e&&(t["X-Firebase-Client"]=e);let n=yield this._getAppCheckToken();return n&&(t["X-Firebase-AppCheck"]=n),t})}_getAppCheckToken(){return a(this,null,function*(){if(A(this.app)&&this.app.settings.appCheckToken)return this.app.settings.appCheckToken;let t=yield this.appCheckServiceProvider.getImmediate({optional:!0})?.getToken();return t?.error&&$n(`Error while retrieving App Check token: ${t.error}`),t?.token})}};function je(r){return J(r)}var Oe=class{constructor(t){this.auth=t,this.observer=null,this.addObserver=jt(e=>this.observer=e)}get next(){return f(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}};var St={loadJS(){return a(this,null,function*(){throw new Error("Unable to load external scripts")})},recaptchaV2Script:"",recaptchaEnterpriseScript:"",gapiScript:""};function or(r){St=r}function ar(r){return St.loadJS(r)}function cr(){return St.gapiScript}function Pn(r){return`__${r}${Math.floor(Math.random()*1e6)}`}function Rn(r,t){let e=Ye(r,"auth");if(e.isInitialized()){let i=e.getImmediate(),s=e.getOptions();if(ve(s,t??{}))return i;$(i,"already-initialized")}return e.initialize({options:t})}function ur(r,t){let e=t?.persistence||[],n=(Array.isArray(e)?e:[e]).map(x);t?.errorMap&&r._updateErrorMap(t.errorMap),r._initializeWithPersistence(n,t?.popupRedirectResolver)}function kn(r,t,e){let n=je(r);f(/^https?:\/\//.test(t),n,"invalid-emulator-scheme");let i=!!e?.disableWarnings,s=Cn(t),{host:o,port:c}=lr(t),u=c===null?"":`:${c}`,l={url:`${s}//${o}${u}/`},h=Object.freeze({host:o,port:c,protocol:s.replace(":",""),options:Object.freeze({disableWarnings:i})});if(!n._canInitEmulator){f(n.config.emulator&&n.emulatorConfig,n,"emulator-config-failed"),f(ve(l,n.config.emulator)&&ve(h,n.emulatorConfig),n,"emulator-config-failed");return}n.config.emulator=l,n.emulatorConfig=h,n.settings.appVerificationDisabledForTesting=!0,Ie(o)?(Ot(`${s}//${o}${u}`),Dt("Auth",!0)):i||dr()}function Cn(r){let t=r.indexOf(":");return t<0?"":r.substr(0,t+1)}function lr(r){let t=Cn(r),e=/(\/\/)?([^?#/]+)/.exec(r.substr(t.length));if(!e)return{host:"",port:null};let n=e[2].split("@").pop()||"",i=/^(\[[^\]]+\])(:|$)/.exec(n);if(i){let s=i[1];return{host:s,port:Xt(n.substr(s.length+1))}}else{let[s,o]=n.split(":");return{host:s,port:Xt(o)}}}function Xt(r){if(!r)return null;let t=Number(r);return isNaN(t)?null:t}function dr(){function r(){let t=document.createElement("p"),e=t.style;t.innerText="Running in emulator mode. Do not use with production credentials.",e.position="fixed",e.width="100%",e.backgroundColor="#ffffff",e.border=".1em solid #000000",e.color="#b50000",e.bottom="0px",e.left="0px",e.margin="0px",e.zIndex="10000",e.textAlign="center",t.classList.add("firebase-emulator-warning"),document.body.appendChild(t)}typeof console<"u"&&typeof console.info=="function"&&console.info("WARNING: You are using the Auth Emulator, which is intended for local testing only.  Do not use with production credentials."),typeof window<"u"&&typeof document<"u"&&(document.readyState==="loading"?window.addEventListener("DOMContentLoaded",r):r())}var De=class{constructor(t,e){this.providerId=t,this.signInMethod=e}toJSON(){return F("not implemented")}_getIdTokenResponse(t){return F("not implemented")}_linkToIdToken(t,e){return F("not implemented")}_getReauthenticationResolver(t){return F("not implemented")}};function et(r,t){return a(this,null,function*(){return pn(r,"POST","/v1/accounts:signInWithIdp",Ve(r,t))})}var Le=class{constructor(t){this.providerId=t,this.defaultLanguageCode=null,this.customParameters={}}setDefaultLanguage(t){this.defaultLanguageCode=t}setCustomParameters(t){return this.customParameters=t,this}getCustomParameters(){return this.customParameters}};var ut=class extends Le{constructor(){super(...arguments),this.scopes=[]}addScope(t){return this.scopes.includes(t)||this.scopes.push(t),this}getScopes(){return[...this.scopes]}};function hr(r,t){return a(this,null,function*(){return pn(r,"POST","/v1/accounts:signUp",Ve(r,t))})}var ee=class r{constructor(t){this.user=t.user,this.providerId=t.providerId,this._tokenResponse=t._tokenResponse,this.operationType=t.operationType}static _fromIdTokenResponse(t,e,n,i=!1){return a(this,null,function*(){let s=yield W._fromIdTokenResponse(t,n,i),o=Qt(n);return new r({user:s,providerId:o,_tokenResponse:n,operationType:e})})}static _forOperation(t,e,n){return a(this,null,function*(){yield t._updateTokensIfNecessary(n,!0);let i=Qt(n);return new r({user:t,providerId:i,_tokenResponse:n,operationType:e})})}};function Qt(r){return r.providerId?r.providerId:"phoneNumber"in r?"phone":null}function yt(r){return a(this,null,function*(){if(A(r.app))return Promise.reject(H(r));let t=je(r);if(yield t._initializationPromise,t.currentUser?.isAnonymous)return new ee({user:t.currentUser,providerId:null,operationType:"signIn"});let e=yield hr(t,{returnSecureToken:!0}),n=yield ee._fromIdTokenResponse(t,"signIn",e,!0);return yield t._updateCurrentUser(n.user),n})}var lt=class r extends _e{constructor(t,e,n,i){super(e.code,e.message),this.operationType=n,this.user=i,Object.setPrototypeOf(this,r.prototype),this.customData={appName:t.name,tenantId:t.tenantId??void 0,_serverResponse:e.customData._serverResponse,operationType:n}}static _fromErrorAndOperation(t,e,n,i){return new r(t,e,n,i)}};function Nn(r,t,e,n){return(t==="reauthenticate"?e._getReauthenticationResolver(r):e._getIdTokenResponse(r)).catch(s=>{throw s.code==="auth/multi-factor-auth-required"?lt._fromErrorAndOperation(r,s,t,n):s})}function pr(r,t,e=!1){return a(this,null,function*(){let n=yield he(r,t._linkToIdToken(r.auth,yield r.getIdToken()),e);return ee._forOperation(r,"link",n)})}function fr(r,t,e=!1){return a(this,null,function*(){let{auth:n}=r;if(A(n.app))return Promise.reject(H(n));let i="reauthenticate";try{let s=yield he(r,Nn(n,i,t,r),e);f(s.idToken,n,"internal-error");let o=vt(s.idToken);f(o,n,"internal-error");let{sub:c}=o;return f(r.uid===c,n,"user-mismatch"),ee._forOperation(r,i,s)}catch(s){throw s?.code==="auth/user-not-found"&&$(n,"user-mismatch"),s}})}function mr(r,t,e=!1){return a(this,null,function*(){if(A(r.app))return Promise.reject(H(r));let n="signIn",i=yield Nn(r,n,t),s=yield ee._fromIdTokenResponse(r,n,i);return e||(yield r._updateCurrentUser(s.user)),s})}function On(r,t,e,n){return J(r).onIdTokenChanged(t,e,n)}function Dn(r,t,e){return J(r).beforeAuthStateChanged(t,e)}var Ue="__sak";var Me=class{constructor(t,e){this.storageRetriever=t,this.type=e}_isAvailable(){try{return this.storage?(this.storage.setItem(Ue,"1"),this.storage.removeItem(Ue),Promise.resolve(!0)):Promise.resolve(!1)}catch{return Promise.resolve(!1)}}_set(t,e){return this.storage.setItem(t,JSON.stringify(e)),Promise.resolve()}_get(t){let e=this.storage.getItem(t);return Promise.resolve(e?JSON.parse(e):null)}_remove(t){return this.storage.removeItem(t),Promise.resolve()}get storage(){return this.storageRetriever()}};var gr=1e3,Ir=10,_r=(()=>{class r extends Me{constructor(){super(()=>window.localStorage,"LOCAL"),this.boundEventHandler=(e,n)=>this.onStorageEvent(e,n),this.listeners={},this.localCache={},this.pollTimer=null,this.fallbackToPolling=bn(),this._shouldAllowMigration=!0}forAllChangedKeys(e){for(let n of Object.keys(this.listeners)){let i=this.storage.getItem(n),s=this.localCache[n];i!==s&&e(n,s,i)}}onStorageEvent(e,n=!1){if(!e.key){this.forAllChangedKeys((c,u,l)=>{this.notifyListeners(c,l)});return}let i=e.key;n?this.detachListener():this.stopPolling();let s=()=>{let c=this.storage.getItem(i);!n&&this.localCache[i]===c||this.notifyListeners(i,c)},o=this.storage.getItem(i);rr()&&o!==e.newValue&&e.newValue!==e.oldValue?setTimeout(s,Ir):s()}notifyListeners(e,n){this.localCache[e]=n;let i=this.listeners[e];if(i)for(let s of Array.from(i))s(n&&JSON.parse(n))}startPolling(){this.stopPolling(),this.pollTimer=setInterval(()=>{this.forAllChangedKeys((e,n,i)=>{this.onStorageEvent(new StorageEvent("storage",{key:e,oldValue:n,newValue:i}),!0)})},gr)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(e,n){Object.keys(this.listeners).length===0&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[e]||(this.listeners[e]=new Set,this.localCache[e]=this.storage.getItem(e)),this.listeners[e].add(n)}_removeListener(e,n){this.listeners[e]&&(this.listeners[e].delete(n),this.listeners[e].size===0&&delete this.listeners[e]),Object.keys(this.listeners).length===0&&(this.detachListener(),this.stopPolling())}_set(e,n){return a(this,null,function*(){yield K(r.prototype,this,"_set").call(this,e,n),this.localCache[e]=JSON.stringify(n)})}_get(e){return a(this,null,function*(){let n=yield K(r.prototype,this,"_get").call(this,e);return this.localCache[e]=JSON.stringify(n),n})}_remove(e){return a(this,null,function*(){yield K(r.prototype,this,"_remove").call(this,e),delete this.localCache[e]})}}return r.type="LOCAL",r})(),Ln=_r;var Er=(()=>{class r extends Me{constructor(){super(()=>window.sessionStorage,"SESSION")}_addListener(e,n){}_removeListener(e,n){}}return r.type="SESSION",r})(),wt=Er;function vr(r){return Promise.all(r.map(t=>a(this,null,function*(){try{return{fulfilled:!0,value:yield t}}catch(e){return{fulfilled:!1,reason:e}}})))}var Tr=(()=>{class r{constructor(e){this.eventTarget=e,this.handlersMap={},this.boundEventHandler=this.handleEvent.bind(this)}static _getInstance(e){let n=this.receivers.find(s=>s.isListeningto(e));if(n)return n;let i=new r(e);return this.receivers.push(i),i}isListeningto(e){return this.eventTarget===e}handleEvent(e){return a(this,null,function*(){let n=e,{eventId:i,eventType:s,data:o}=n.data,c=this.handlersMap[s];if(!c?.size)return;n.ports[0].postMessage({status:"ack",eventId:i,eventType:s});let u=Array.from(c).map(h=>a(this,null,function*(){return h(n.origin,o)})),l=yield vr(u);n.ports[0].postMessage({status:"done",eventId:i,eventType:s,response:l})})}_subscribe(e,n){Object.keys(this.handlersMap).length===0&&this.eventTarget.addEventListener("message",this.boundEventHandler),this.handlersMap[e]||(this.handlersMap[e]=new Set),this.handlersMap[e].add(n)}_unsubscribe(e,n){this.handlersMap[e]&&n&&this.handlersMap[e].delete(n),(!n||this.handlersMap[e].size===0)&&delete this.handlersMap[e],Object.keys(this.handlersMap).length===0&&this.eventTarget.removeEventListener("message",this.boundEventHandler)}}r.receivers=[];return r})();function Un(r="",t=10){let e="";for(let n=0;n<t;n++)e+=Math.floor(Math.random()*10);return r+e}var dt=class{constructor(t){this.target=t,this.handlers=new Set}removeMessageHandler(t){t.messageChannel&&(t.messageChannel.port1.removeEventListener("message",t.onMessage),t.messageChannel.port1.close()),this.handlers.delete(t)}_send(t,e,n=50){return a(this,null,function*(){let i=typeof MessageChannel<"u"?new MessageChannel:null;if(!i)throw new Error("connection_unavailable");let s,o;return new Promise((c,u)=>{let l=Un("",20);i.port1.start();let h=setTimeout(()=>{u(new Error("unsupported_event"))},n);o={messageChannel:i,onMessage(d){let p=d;if(p.data.eventId===l)switch(p.data.status){case"ack":clearTimeout(h),s=setTimeout(()=>{u(new Error("timeout"))},3e3);break;case"done":clearTimeout(s),c(p.data.response);break;default:clearTimeout(h),clearTimeout(s),u(new Error("invalid_response"));break}}},this.handlers.add(o),i.port1.addEventListener("message",o.onMessage),this.target.postMessage({eventType:t,eventId:l,data:e},[i.port2])}).finally(()=>{o&&this.removeMessageHandler(o)})})}};function N(){return window}function Sr(r){N().location.href=r}function Mn(){return typeof N().WorkerGlobalScope<"u"&&typeof N().importScripts=="function"}function yr(){return a(this,null,function*(){if(!navigator?.serviceWorker)return null;try{return(yield navigator.serviceWorker.ready).active}catch{return null}})}function wr(){return navigator?.serviceWorker?.controller||null}function br(){return Mn()?self:null}var Fn="firebaseLocalStorageDb",Ar=1,Fe="firebaseLocalStorage",xn="fbase_key",te=class{constructor(t){this.request=t}toPromise(){return new Promise((t,e)=>{this.request.addEventListener("success",()=>{t(this.request.result)}),this.request.addEventListener("error",()=>{e(this.request.error)})})}};function We(r,t){return r.transaction([Fe],t?"readwrite":"readonly").objectStore(Fe)}function Pr(){let r=indexedDB.deleteDatabase(Fn);return new te(r).toPromise()}function ht(){let r=indexedDB.open(Fn,Ar);return new Promise((t,e)=>{r.addEventListener("error",()=>{e(r.error)}),r.addEventListener("upgradeneeded",()=>{let n=r.result;try{n.createObjectStore(Fe,{keyPath:xn})}catch(i){e(i)}}),r.addEventListener("success",()=>a(this,null,function*(){let n=r.result;n.objectStoreNames.contains(Fe)?t(n):(n.close(),yield Pr(),t(yield ht()))}))})}function Zt(r,t,e){return a(this,null,function*(){let n=We(r,!0).put({[xn]:t,value:e});return new te(n).toPromise()})}function Rr(r,t){return a(this,null,function*(){let e=We(r,!1).get(t),n=yield new te(e).toPromise();return n===void 0?null:n.value})}function en(r,t){let e=We(r,!0).delete(t);return new te(e).toPromise()}var kr=800,Cr=3,Nr=(()=>{class r{constructor(){this.type="LOCAL",this._shouldAllowMigration=!0,this.listeners={},this.localCache={},this.pollTimer=null,this.pendingWrites=0,this.receiver=null,this.sender=null,this.serviceWorkerReceiverAvailable=!1,this.activeServiceWorker=null,this._workerInitializationPromise=this.initializeServiceWorkerMessaging().then(()=>{},()=>{})}_openDb(){return a(this,null,function*(){return this.db?this.db:(this.db=yield ht(),this.db)})}_withRetries(e){return a(this,null,function*(){let n=0;for(;;)try{let i=yield this._openDb();return yield e(i)}catch(i){if(n++>Cr)throw i;this.db&&(this.db.close(),this.db=void 0)}})}initializeServiceWorkerMessaging(){return a(this,null,function*(){return Mn()?this.initializeReceiver():this.initializeSender()})}initializeReceiver(){return a(this,null,function*(){this.receiver=Tr._getInstance(br()),this.receiver._subscribe("keyChanged",(e,n)=>a(this,null,function*(){return{keyProcessed:(yield this._poll()).includes(n.key)}})),this.receiver._subscribe("ping",(e,n)=>a(this,null,function*(){return["keyChanged"]}))})}initializeSender(){return a(this,null,function*(){if(this.activeServiceWorker=yield yr(),!this.activeServiceWorker)return;this.sender=new dt(this.activeServiceWorker);let e=yield this.sender._send("ping",{},800);e&&e[0]?.fulfilled&&e[0]?.value.includes("keyChanged")&&(this.serviceWorkerReceiverAvailable=!0)})}notifyServiceWorker(e){return a(this,null,function*(){if(!(!this.sender||!this.activeServiceWorker||wr()!==this.activeServiceWorker))try{yield this.sender._send("keyChanged",{key:e},this.serviceWorkerReceiverAvailable?800:50)}catch{}})}_isAvailable(){return a(this,null,function*(){try{if(!indexedDB)return!1;let e=yield ht();return yield Zt(e,Ue,"1"),yield en(e,Ue),!0}catch{}return!1})}_withPendingWrite(e){return a(this,null,function*(){this.pendingWrites++;try{yield e()}finally{this.pendingWrites--}})}_set(e,n){return a(this,null,function*(){return this._withPendingWrite(()=>a(this,null,function*(){return yield this._withRetries(i=>Zt(i,e,n)),this.localCache[e]=n,this.notifyServiceWorker(e)}))})}_get(e){return a(this,null,function*(){let n=yield this._withRetries(i=>Rr(i,e));return this.localCache[e]=n,n})}_remove(e){return a(this,null,function*(){return this._withPendingWrite(()=>a(this,null,function*(){return yield this._withRetries(n=>en(n,e)),delete this.localCache[e],this.notifyServiceWorker(e)}))})}_poll(){return a(this,null,function*(){let e=yield this._withRetries(s=>{let o=We(s,!1).getAll();return new te(o).toPromise()});if(!e)return[];if(this.pendingWrites!==0)return[];let n=[],i=new Set;if(e.length!==0)for(let{fbase_key:s,value:o}of e)i.add(s),JSON.stringify(this.localCache[s])!==JSON.stringify(o)&&(this.notifyListeners(s,o),n.push(s));for(let s of Object.keys(this.localCache))this.localCache[s]&&!i.has(s)&&(this.notifyListeners(s,null),n.push(s));return n})}notifyListeners(e,n){this.localCache[e]=n;let i=this.listeners[e];if(i)for(let s of Array.from(i))s(n)}startPolling(){this.stopPolling(),this.pollTimer=setInterval(()=>a(this,null,function*(){return this._poll()}),kr)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}_addListener(e,n){Object.keys(this.listeners).length===0&&this.startPolling(),this.listeners[e]||(this.listeners[e]=new Set,this._get(e)),this.listeners[e].add(n)}_removeListener(e,n){this.listeners[e]&&(this.listeners[e].delete(n),this.listeners[e].size===0&&delete this.listeners[e]),Object.keys(this.listeners).length===0&&this.stopPolling()}}return r.type="LOCAL",r})(),Vn=Nr;var Ci=Pn("rcb"),Ni=new Z(3e4,6e4);function Or(r,t){return t?x(t):(f(r._popupRedirectResolver,r,"argument-error"),r._popupRedirectResolver)}var fe=class extends De{constructor(t){super("custom","custom"),this.params=t}_getIdTokenResponse(t){return et(t,this._buildIdpRequest())}_linkToIdToken(t,e){return et(t,this._buildIdpRequest(e))}_getReauthenticationResolver(t){return et(t,this._buildIdpRequest())}_buildIdpRequest(t){let e={requestUri:this.params.requestUri,sessionId:this.params.sessionId,postBody:this.params.postBody,tenantId:this.params.tenantId,pendingToken:this.params.pendingToken,returnSecureToken:!0,returnIdpCredential:!0};return t&&(e.idToken=t),e}};function Dr(r){return mr(r.auth,new fe(r),r.bypassAuthState)}function Lr(r){let{auth:t,user:e}=r;return f(e,t,"internal-error"),fr(e,new fe(r),r.bypassAuthState)}function Ur(r){return a(this,null,function*(){let{auth:t,user:e}=r;return f(e,t,"internal-error"),pr(e,new fe(r),r.bypassAuthState)})}var pt=class{constructor(t,e,n,i,s=!1){this.auth=t,this.resolver=n,this.user=i,this.bypassAuthState=s,this.pendingPromise=null,this.eventManager=null,this.filter=Array.isArray(e)?e:[e]}execute(){return new Promise((t,e)=>a(this,null,function*(){this.pendingPromise={resolve:t,reject:e};try{this.eventManager=yield this.resolver._initialize(this.auth),yield this.onExecution(),this.eventManager.registerConsumer(this)}catch(n){this.reject(n)}}))}onAuthEvent(t){return a(this,null,function*(){let{urlResponse:e,sessionId:n,postBody:i,tenantId:s,error:o,type:c}=t;if(o){this.reject(o);return}let u={auth:this.auth,requestUri:e,sessionId:n,tenantId:s||void 0,postBody:i||void 0,user:this.user,bypassAuthState:this.bypassAuthState};try{this.resolve(yield this.getIdpTask(c)(u))}catch(l){this.reject(l)}})}onError(t){this.reject(t)}getIdpTask(t){switch(t){case"signInViaPopup":case"signInViaRedirect":return Dr;case"linkViaPopup":case"linkViaRedirect":return Ur;case"reauthViaPopup":case"reauthViaRedirect":return Lr;default:$(this.auth,"internal-error")}}resolve(t){q(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.resolve(t),this.unregisterAndCleanUp()}reject(t){q(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.reject(t),this.unregisterAndCleanUp()}unregisterAndCleanUp(){this.eventManager&&this.eventManager.unregisterConsumer(this),this.pendingPromise=null,this.cleanUp()}};var Oi=new Z(2e3,1e4);var Mr="pendingRedirect",be=new Map,ft=class r extends pt{constructor(t,e,n=!1){super(t,["signInViaRedirect","linkViaRedirect","reauthViaRedirect","unknown"],e,void 0,n),this.eventId=null}execute(){return a(this,null,function*(){let t=be.get(this.auth._key());if(!t){try{let n=(yield Fr(this.resolver,this.auth))?yield K(r.prototype,this,"execute").call(this):null;t=()=>Promise.resolve(n)}catch(e){t=()=>Promise.reject(e)}be.set(this.auth._key(),t)}return this.bypassAuthState||be.set(this.auth._key(),()=>Promise.resolve(null)),t()})}onAuthEvent(t){return a(this,null,function*(){if(t.type==="signInViaRedirect")return K(r.prototype,this,"onAuthEvent").call(this,t);if(t.type==="unknown"){this.resolve(null);return}if(t.eventId){let e=yield this.auth._redirectUserForId(t.eventId);if(e)return this.user=e,K(r.prototype,this,"onAuthEvent").call(this,t);this.resolve(null)}})}onExecution(){return a(this,null,function*(){})}cleanUp(){}};function Fr(r,t){return a(this,null,function*(){let e=jr(t),n=Vr(r);if(!(yield n._isAvailable()))return!1;let i=(yield n._get(e))==="true";return yield n._remove(e),i})}function xr(r,t){be.set(r._key(),t)}function Vr(r){return x(r._redirectPersistence)}function jr(r){return we(Mr,r.config.apiKey,r.name)}function Wr(r,t,e=!1){return a(this,null,function*(){if(A(r.app))return Promise.reject(H(r));let n=je(r),i=Or(n,t),o=yield new ft(n,i,e).execute();return o&&!e&&(delete o.user._redirectEventId,yield n._persistUserIfCurrent(o.user),yield n._setRedirectUser(null,t)),o})}var Hr=10*60*1e3,mt=class{constructor(t){this.auth=t,this.cachedEventUids=new Set,this.consumers=new Set,this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1,this.lastProcessedEventTime=Date.now()}registerConsumer(t){this.consumers.add(t),this.queuedRedirectEvent&&this.isEventForConsumer(this.queuedRedirectEvent,t)&&(this.sendToConsumer(this.queuedRedirectEvent,t),this.saveEventToCache(this.queuedRedirectEvent),this.queuedRedirectEvent=null)}unregisterConsumer(t){this.consumers.delete(t)}onEvent(t){if(this.hasEventBeenHandled(t))return!1;let e=!1;return this.consumers.forEach(n=>{this.isEventForConsumer(t,n)&&(e=!0,this.sendToConsumer(t,n),this.saveEventToCache(t))}),this.hasHandledPotentialRedirect||!$r(t)||(this.hasHandledPotentialRedirect=!0,e||(this.queuedRedirectEvent=t,e=!0)),e}sendToConsumer(t,e){if(t.error&&!jn(t)){let n=t.error.code?.split("auth/")[1]||"internal-error";e.onError(Q(this.auth,n))}else e.onAuthEvent(t)}isEventForConsumer(t,e){let n=e.eventId===null||!!t.eventId&&t.eventId===e.eventId;return e.filter.includes(t.type)&&n}hasEventBeenHandled(t){return Date.now()-this.lastProcessedEventTime>=Hr&&this.cachedEventUids.clear(),this.cachedEventUids.has(tn(t))}saveEventToCache(t){this.cachedEventUids.add(tn(t)),this.lastProcessedEventTime=Date.now()}};function tn(r){return[r.type,r.eventId,r.sessionId,r.tenantId].filter(t=>t).join("-")}function jn({type:r,error:t}){return r==="unknown"&&t?.code==="auth/no-auth-event"}function $r(r){switch(r.type){case"signInViaRedirect":case"linkViaRedirect":case"reauthViaRedirect":return!0;case"unknown":return jn(r);default:return!1}}function qr(e){return a(this,arguments,function*(r,t={}){return oe(r,"GET","/v1/projects",t)})}var Gr=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,zr=/^https?/;function Kr(r){return a(this,null,function*(){if(r.config.emulator)return;let{authorizedDomains:t}=yield qr(r);for(let e of t)try{if(Br(e))return}catch{}$(r,"unauthorized-domain")})}function Br(r){let t=nt(),{protocol:e,hostname:n}=new URL(t);if(r.startsWith("chrome-extension://")){let o=new URL(r);return o.hostname===""&&n===""?e==="chrome-extension:"&&r.replace("chrome-extension://","")===t.replace("chrome-extension://",""):e==="chrome-extension:"&&o.hostname===n}if(!zr.test(e))return!1;if(Gr.test(r))return n===r;let i=r.replace(/\./g,"\\.");return new RegExp("^(.+\\."+i+"|"+i+")$","i").test(n)}var Yr=new Z(3e4,6e4);function nn(){let r=N().___jsl;if(r?.H){for(let t of Object.keys(r.H))if(r.H[t].r=r.H[t].r||[],r.H[t].L=r.H[t].L||[],r.H[t].r=[...r.H[t].L],r.CP)for(let e=0;e<r.CP.length;e++)r.CP[e]=null}}function Jr(r){return new Promise((t,e)=>{function n(){nn(),gapi.load("gapi.iframes",{callback:()=>{t(gapi.iframes.getContext())},ontimeout:()=>{nn(),e(Q(r,"network-request-failed"))},timeout:Yr.get()})}if(N().gapi?.iframes?.Iframe)t(gapi.iframes.getContext());else if(N().gapi?.load)n();else{let i=Pn("iframefcb");return N()[i]=()=>{gapi.load?n():e(Q(r,"network-request-failed"))},ar(`${cr()}?onload=${i}`).catch(s=>e(s))}}).catch(t=>{throw Ae=null,t})}var Ae=null;function Xr(r){return Ae=Ae||Jr(r),Ae}var Qr=new Z(5e3,15e3),Zr="__/auth/iframe",ei="emulator/auth/iframe",ti={style:{position:"absolute",top:"-100px",width:"1px",height:"1px"},"aria-hidden":"true",tabindex:"-1"},ni=new Map([["identitytoolkit.googleapis.com","p"],["staging-identitytoolkit.sandbox.googleapis.com","s"],["test-identitytoolkit.sandbox.googleapis.com","t"]]);function ri(r){let t=r.config;f(t.authDomain,r,"auth-domain-config-required");let e=t.emulator?Et(t,ei):`https://${r.config.authDomain}/${Zr}`,n={apiKey:t.apiKey,appName:r.name,v:ie},i=ni.get(r.config.apiHost);i&&(n.eid=i);let s=r._getFrameworks();return s.length&&(n.fw=s.join(",")),`${e}?${ce(n).slice(1)}`}function ii(r){return a(this,null,function*(){let t=yield Xr(r),e=N().gapi;return f(e,r,"internal-error"),t.open({where:document.body,url:ri(r),messageHandlersFilter:e.iframes.CROSS_ORIGIN_IFRAMES_FILTER,attributes:ti,dontclear:!0},n=>new Promise((i,s)=>a(this,null,function*(){yield n.restyle({setHideOnLeave:!1});let o=Q(r,"network-request-failed"),c=N().setTimeout(()=>{s(o)},Qr.get());function u(){N().clearTimeout(c),i(n)}n.ping(u).then(u,()=>{s(o)})})))})}var si={location:"yes",resizable:"yes",statusbar:"yes",toolbar:"no"},oi=500,ai=600,ci="_blank",ui="http://localhost",xe=class{constructor(t){this.window=t,this.associatedEvent=null}close(){if(this.window)try{this.window.close()}catch{}}};function li(r,t,e,n=oi,i=ai){let s=Math.max((window.screen.availHeight-i)/2,0).toString(),o=Math.max((window.screen.availWidth-n)/2,0).toString(),c="",u=_(g({},si),{width:n.toString(),height:i.toString(),top:s,left:o}),l=w().toLowerCase();e&&(c=vn(l)?ci:e),_n(l)&&(t=t||ui,u.scrollbars="yes");let h=Object.entries(u).reduce((p,[I,k])=>`${p}${I}=${k},`,"");if(nr(l)&&c!=="_self")return di(t||"",c),new xe(null);let d=window.open(t||"",c,h);f(d,r,"popup-blocked");try{d.focus()}catch{}return new xe(d)}function di(r,t){let e=document.createElement("a");e.href=r,e.target=t;let n=document.createEvent("MouseEvent");n.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,1,null),e.dispatchEvent(n)}var hi="__/auth/handler",pi="emulator/auth/handler",fi=encodeURIComponent("fac");function rn(r,t,e,n,i,s){return a(this,null,function*(){f(r.config.authDomain,r,"auth-domain-config-required"),f(r.config.apiKey,r,"invalid-api-key");let o={apiKey:r.config.apiKey,appName:r.name,authType:e,redirectUrl:n,v:ie,eventId:i};if(t instanceof Le){t.setDefaultLanguage(r.languageCode),o.providerId=t.providerId||"",Vt(t.getCustomParameters())||(o.customParameters=JSON.stringify(t.getCustomParameters()));for(let[h,d]of Object.entries(s||{}))o[h]=d}if(t instanceof ut){let h=t.getScopes().filter(d=>d!=="");h.length>0&&(o.scopes=h.join(","))}r.tenantId&&(o.tid=r.tenantId);let c=o;for(let h of Object.keys(c))c[h]===void 0&&delete c[h];let u=yield r._getAppCheckToken(),l=u?`#${fi}=${encodeURIComponent(u)}`:"";return`${mi(r)}?${ce(c).slice(1)}${l}`})}function mi({config:r}){return r.emulator?Et(r,pi):`https://${r.authDomain}/${hi}`}var tt="webStorageSupport",gt=class{constructor(){this.eventManagers={},this.iframes={},this.originValidationPromises={},this._redirectPersistence=wt,this._completeRedirectFn=Wr,this._overrideRedirectResult=xr}_openPopup(t,e,n,i){return a(this,null,function*(){q(this.eventManagers[t._key()]?.manager,"_initialize() not called before _openPopup()");let s=yield rn(t,e,n,nt(),i);return li(t,s,Un())})}_openRedirect(t,e,n,i){return a(this,null,function*(){yield this._originValidation(t);let s=yield rn(t,e,n,nt(),i);return Sr(s),new Promise(()=>{})})}_initialize(t){let e=t._key();if(this.eventManagers[e]){let{manager:i,promise:s}=this.eventManagers[e];return i?Promise.resolve(i):(q(s,"If manager is not set, promise should be"),s)}let n=this.initAndGetManager(t);return this.eventManagers[e]={promise:n},n.catch(()=>{delete this.eventManagers[e]}),n}initAndGetManager(t){return a(this,null,function*(){let e=yield ii(t),n=new mt(t);return e.register("authEvent",i=>(f(i?.authEvent,t,"invalid-auth-event"),{status:n.onEvent(i.authEvent)?"ACK":"ERROR"}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER),this.eventManagers[t._key()]={manager:n},this.iframes[t._key()]=e,n})}_isIframeWebStorageSupported(t,e){this.iframes[t._key()].send(tt,{type:tt},i=>{let s=i?.[0]?.[tt];s!==void 0&&e(!!s),$(t,"internal-error")},gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER)}_originValidation(t){let e=t._key();return this.originValidationPromises[e]||(this.originValidationPromises[e]=Kr(t)),this.originValidationPromises[e]}get _shouldInitProactively(){return bn()||En()||Tt()}},Wn=gt;var sn="@firebase/auth",on="1.11.1";var It=class{constructor(t){this.auth=t,this.internalListeners=new Map}getUid(){return this.assertAuthConfigured(),this.auth.currentUser?.uid||null}getToken(t){return a(this,null,function*(){return this.assertAuthConfigured(),yield this.auth._initializationPromise,this.auth.currentUser?{accessToken:yield this.auth.currentUser.getIdToken(t)}:null})}addAuthTokenListener(t){if(this.assertAuthConfigured(),this.internalListeners.has(t))return;let e=this.auth.onIdTokenChanged(n=>{t(n?.stsTokenManager.accessToken||null)});this.internalListeners.set(t,e),this.updateProactiveRefresh()}removeAuthTokenListener(t){this.assertAuthConfigured();let e=this.internalListeners.get(t);e&&(this.internalListeners.delete(t),e(),this.updateProactiveRefresh())}assertAuthConfigured(){f(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){this.internalListeners.size>0?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}};function gi(r){switch(r){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";case"WebExtension":return"web-extension";default:return}}function Ii(r){Be(new ze("auth",(t,{options:e})=>{let n=t.getProvider("app").getImmediate(),i=t.getProvider("heartbeat"),s=t.getProvider("app-check-internal"),{apiKey:o,authDomain:c}=n.options;f(o&&!o.includes(":"),"invalid-api-key",{appName:n.name});let u={apiKey:o,authDomain:c,clientPlatform:r,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:An(r)},l=new ct(n,i,s,u);return ur(l,e),l},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((t,e,n)=>{t.getProvider("auth-internal").initialize()})),Be(new ze("auth-internal",t=>{let e=je(t.getProvider("auth").getImmediate());return(n=>new It(n))(e)},"PRIVATE").setInstantiationMode("EXPLICIT")),Je(sn,on,gi(r)),Je(sn,on,"esm2020")}var _i=5*60,Ei=Ge("authIdTokenMaxAge")||_i,an=null,vi=r=>t=>a(void 0,null,function*(){let e=t&&(yield t.getIdTokenResult()),n=e&&(new Date().getTime()-Date.parse(e.issuedAtTime))/1e3;if(n&&n>Ei)return;let i=e?.token;an!==i&&(an=i,yield fetch(r,{method:i?"POST":"DELETE",headers:i?{Authorization:`Bearer ${i}`}:{}}))});function bt(r=Ht()){let t=Ye(r,"auth");if(t.isInitialized())return t.getImmediate();let e=Rn(r,{popupRedirectResolver:Wn,persistence:[Vn,Ln,wt]}),n=Ge("authTokenSyncURL");if(n&&typeof isSecureContext=="boolean"&&isSecureContext){let s=new URL(n,location.origin);if(location.origin===s.origin){let o=vi(s.toString());Dn(e,o,()=>o(e.currentUser)),On(e,c=>o(c))}}let i=Nt("auth");return i&&kn(e,`http://${i}`),e}function Ti(){return document.getElementsByTagName("head")?.[0]??document}or({loadJS(r){return new Promise((t,e)=>{let n=document.createElement("script");n.setAttribute("src",r),n.onload=t,n.onerror=i=>{let s=Q("internal-error");s.customData=i,e(s)},n.type="text/javascript",n.charset="UTF-8",Ti().appendChild(n)})},gapiScript:"https://apis.google.com/js/api.js",recaptchaV2Script:"https://www.google.com/recaptcha/api.js",recaptchaEnterpriseScript:"https://www.google.com/recaptcha/enterprise.js?render="});Ii("Browser");var Hn=(()=>{class r{constructor(){this.maintenanceModeSubject=new O(!1),this.isMaintenanceMode$=this.maintenanceModeSubject.asObservable(),this.maintenanceMessageSubject=new O("System is currently undergoing maintenance. Please try again later."),this.maintenanceMessage$=this.maintenanceMessageSubject.asObservable()}setMaintenanceMode(e,n){n&&this.maintenanceMessageSubject.next(n),this.maintenanceModeSubject.next(e),e&&console.warn("Maintenance Mode Activated:",n||"No message")}isMaintenanceMode(){return this.maintenanceModeSubject.value}static{this.\u0275fac=function(n){return new(n||r)}}static{this.\u0275prov=ge({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var Eo=(()=>{class r{constructor(e,n,i,s,o,c){this.http=e,this.loggingService=n,this.customerService=i,this.firebaseService=s,this.storeService=o,this.maintenanceService=c,this.apiUrl=Rt.apiUrl,this._products=ne([]),this.products=this._products.asReadonly(),this._sales=ne([]),this.sales=this._sales.asReadonly(),this._expenses=ne([]),this.expenses=this._expenses.asReadonly(),this._categories=ne([]),this.categories=this._categories.asReadonly(),this._stats=ne(null),this.stats=this._stats.asReadonly(),this.productsSubject=new O([]),this.salesSubject=new O([]),this.expensesSubject=new O([]),this.categoriesSubject=new O([]),this.products$=this.productsSubject.asObservable(),this.sales$=this.salesSubject.asObservable(),this.expenses$=this.expensesSubject.asObservable(),this.categories$=this.categoriesSubject.asObservable(),this.statsSubject=new O(null),this.stats$=this.statsSubject.asObservable(),this.firebaseUser=null,this.unsubscribes=[],this.pollingInterval=null,this.app=this.firebaseService.app,this.db=this.firebaseService.db,this.auth=bt(this.app),this.hydrateFromCache(),re(()=>this.saveToCache("products",this._products())),re(()=>this.saveToCache("sales",this._sales())),re(()=>this.saveToCache("expenses",this._expenses())),re(()=>this.saveToCache("categories",this._categories())),re(()=>this.saveToCache("stats",this._stats()))}getCurrentUser(){return localStorage.getItem("jjm_user_id")||"guest"}getFirestoreUserId(){return this.firebaseUser?this.firebaseUser.uid:localStorage.getItem("firebase_auth_disabled")==="true"?this.getCurrentUser():(console.warn("Firestore User ID requested but not authenticated. Using legacy fallback."),this.getCurrentUser())}reloadData(){this.startRealtimeListeners()}enableFullSync(){console.log("Enabling Full Firestore Sync..."),localStorage.setItem("jjm_force_full_load","true"),this.reloadData()}stopRealtimeListeners(){this.unsubscribes.forEach(e=>e()),this.unsubscribes=[],this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)}hydrateFromCache(){try{[{key:"products",signal:this._products,subject:this.productsSubject},{key:"sales",signal:this._sales,subject:this.salesSubject},{key:"expenses",signal:this._expenses,subject:this.expensesSubject},{key:"categories",signal:this._categories,subject:this.categoriesSubject},{key:"stats",signal:this._stats,subject:this.statsSubject}].forEach(n=>{let i=localStorage.getItem(`jjm_${n.key}`);if(i){let s=JSON.parse(i);n.signal.set(s),n.subject.next(s)}})}catch(e){console.warn("InventoryService: Failed to hydrate from cache",e)}}saveToCache(e,n){try{localStorage.setItem(`jjm_${e}`,JSON.stringify(n))}catch(i){console.error(`InventoryService: Failed to save ${e} to cache`,i)}}handleFirestoreError(e,n){console.error(`${n}:`,e),(e.code==="resource-exhausted"||e.code===8||e.status===429||e.message&&e.message.toLowerCase().includes("quota")||e.error&&e.error.message&&e.error.message.toLowerCase().includes("quota"))&&this.maintenanceService.setMaintenanceMode(!0,"Firebase Quota Exhausted. System is in read-only maintenance mode.")}startRealtimeListeners(){this.stopRealtimeListeners();let e=this.getCurrentUser();if(!e||e==="guest")return;if(localStorage.getItem("firebase_auth_disabled")==="true"){console.log("Auth previously failed. Skipping to Public/Fallback Mode."),this.setupFirestoreListeners(e,e);return}let i=this.auth.currentUser;if(i){console.log("Already Authenticated. Starting Secure Listeners."),this.firebaseUser=i,this.setupFirestoreListeners(i.uid,e);return}yt(this.auth).then(s=>{console.log("Signed In Anonymously. Starting Secure Listeners."),this.firebaseUser=s.user,this.setupFirestoreListeners(s.user.uid,e)}).catch(s=>{console.warn("Anonymous Auth unavailable. Attempting Public Realtime Mode with Legacy ID."),localStorage.setItem("firebase_auth_disabled","true"),this.setupFirestoreListeners(e,e)})}setupFirestoreListeners(e,n){this.storeService.activeStoreId$.pipe(At()).subscribe(i=>{this.doSetupFirestoreListeners(e,n,i)})}doSetupFirestoreListeners(e,n,i){this.unsubscribes.forEach(d=>d()),this.unsubscribes=[],this.setupStatsListener(i);let s=localStorage.getItem("jjm_force_full_load")==="true",o=!!localStorage.getItem("customer_id");if(!s&&!o){console.log("Optimized Mode: Stats Only. Raw data listeners skipped.");return}let c;o?(console.log("InventoryService: Customer Mode - Fetching ALL products for AI"),c=R(S(this.db,"products"),Xe("name","asc"),Qe(100))):(c=R(S(this.db,"products"),b("userId","==",n)),i&&(c=R(S(this.db,"products"),b("userId","==",n),b("storeId","==",i)))),this.unsubscribes.push(se(c,d=>{console.log("Products Snapshot:",d.docs.length);let p=d.docs.map(I=>g({id:I.id},I.data()));this._products.set(p),this.productsSubject.next(p),!o&&p.length===0&&(this.migrateProducts(n,e),this.migrateChat(n,e))},d=>{d.code==="permission-denied"?(console.warn("Permission Denied. Falling back to Legacy Polling."),this.fallbackToLegacyPolling()):this.handleFirestoreError(d,"Products Listener Error")}));let u;o?(console.log("InventoryService: Customer Mode - Querying RECENT sales for fuzzy matching"),u=R(S(this.db,"sales"),Xe("timestamp","desc"),Qe(100))):(u=R(S(this.db,"sales"),b("userId","==",n)),i&&(u=R(S(this.db,"sales"),b("userId","==",n),b("storeId","==",i)))),this.unsubscribes.push(se(u,d=>{console.log("Sales Snapshot:",d.docs.length);let p=d.docs.map(I=>this.transformSale(g({id:I.id},I.data())));this._sales.set(p),this.salesSubject.next(p),!o&&p.length===0&&this.migrateSales(n,e)},d=>this.handleFirestoreError(d,"Sales Listener Error")));let l=R(S(this.db,"expenses"),b("userId","==",e));i&&(l=R(S(this.db,"expenses"),b("userId","==",e),b("storeId","==",i))),this.unsubscribes.push(se(l,d=>{console.log("Expenses Snapshot:",d.docs.length);let p=d.docs.map(I=>g({id:I.id},I.data()));this._expenses.set(p),this.expensesSubject.next(p),p.length===0&&this.migrateExpenses(n,e)},d=>this.handleFirestoreError(d,"Expenses Listener Error")));let h=R(S(this.db,"categories"),b("userId","==",n));i&&(h=R(S(this.db,"categories"),b("userId","==",n),b("storeId","==",i))),this.unsubscribes.push(se(h,d=>{console.log("Categories Snapshot:",d.docs.length);let p=d.docs.map(I=>g({id:I.id},I.data()));this._categories.set(p),this.categoriesSubject.next(p)},d=>this.handleFirestoreError(d,"Categories Listener Error")))}fallbackToLegacyPolling(){this.pollingInterval||(console.log("Starting Legacy Polling (Fallback Mode)..."),this.fetchAllLegacyData(),this.pollingInterval=setInterval(()=>this.fetchAllLegacyData(),1e4))}fetchAllLegacyData(){this.fetchProducts(),this.fetchSales(),this.fetchExpenses()}setupStatsListener(e){if(!e)return;let n=P(this.db,"stats",e);this.unsubscribes.push(se(n,i=>{if(i.exists()){let s=i.data(),o=_(g({},s),{lastUpdated:s.lastUpdated instanceof $t?s.lastUpdated.toDate():new Date(s.lastUpdated)});this._stats.set(o),this.statsSubject.next(o)}else console.log("No aggregation document found for this store."),this._stats.set(null),this.statsSubject.next(null)},i=>this.handleFirestoreError(i,"Stats Listener Error")))}migrateProducts(e,n){let i=this.storeService.getActiveStoreId();this.http.get(`${this.apiUrl}/products?userId=${e}`).subscribe(s=>{s.forEach(o=>a(this,null,function*(){try{yield X(P(this.db,"products",o.id),_(g({},o),{userId:n,storeId:o.storeId||i||null}))}catch(c){console.error("Error migrating product:",c)}}))})}migrateChat(e,n){let i=this.storeService.getActiveStoreId();this.http.get(`${this.apiUrl}/messages?userId=${e}`).subscribe(s=>{s.forEach(o=>a(this,null,function*(){try{yield X(P(this.db,"messages",o.id),_(g({},o),{userId:n,storeId:o.storeId||i||null,timestamp:this.parseDate(o.timestamp)}))}catch(c){console.error("Error migrating message:",c)}}))})}migrateSales(e,n){let i=this.storeService.getActiveStoreId();this.http.get(`${this.apiUrl}/sales?userId=${e}`).subscribe(s=>{s.forEach(o=>a(this,null,function*(){try{let c=_(g({},o),{pending:o.pending===!0||o.pending==="true",timestamp:this.parseDate(o.timestamp),deliveryDate:o.deliveryDate?this.parseDate(o.deliveryDate):null,userId:n,storeId:o.storeId||i||null});yield X(P(this.db,"sales",o.id),c)}catch(c){console.error("Error migrating sale:",c)}}))})}migrateExpenses(e,n){let i=this.storeService.getActiveStoreId();this.http.get(`${this.apiUrl}/expenses?userId=${e}`).subscribe(s=>{s.forEach(o=>a(this,null,function*(){try{let c=_(g({},o),{timestamp:this.parseDate(o.timestamp),userId:n,storeId:o.storeId||i||null});yield X(P(this.db,"expenses",o.id),c)}catch(c){console.error("Error migrating expense:",c)}}))})}loadProducts(){this.fetchProducts()}loadProductsForUser(e){let n=`${this.apiUrl}/products?userId=${e}`;this.http.get(n).subscribe({next:i=>this.productsSubject.next(i),error:i=>console.error("Error fetching products for user:",i)})}fetchProducts(){let e=this.storeService.getActiveStoreId();if(!e){this.productsSubject.next([]);return}let n=this.getCurrentUser(),i=`${this.apiUrl}/products`,s=new URLSearchParams;n&&n!=="guest"&&s.append("userId",n),s.append("storeId",e);let o=s.toString();i+=`?${o}`,this.http.get(i).subscribe({next:c=>this.productsSubject.next(c),error:c=>console.error("Error fetching products:",c)})}fetchSales(){let e=this.getCurrentUser(),n=this.storeService.getActiveStoreId();if(!e||e==="guest"||!n){n||this.salesSubject.next([]);return}let i=`${this.apiUrl}/sales?userId=${e}&storeId=${n}`;this.http.get(i).subscribe({next:s=>{let o=s.map(c=>this.transformSale(c));this.salesSubject.next(o)},error:s=>console.error("Error fetching sales:",s)})}fetchExpenses(){let e=this.getCurrentUser(),n=this.storeService.getActiveStoreId();if(!e||e==="guest"||!n){n||this.expensesSubject.next([]);return}let i=`${this.apiUrl}/expenses?userId=${e}&storeId=${n}`;this.http.get(i).subscribe({next:s=>this.expensesSubject.next(s),error:s=>console.error("Error fetching expenses:",s)})}getProducts(){return this.products$}getSales(){return this.sales$}getExpenses(){return this.expenses$}getCategories(){return this.categories$}addCategory(e){let n=this.storeService.getActiveStoreId();if(!n)return T(()=>new Error("Store selection required for this transaction."));let i={name:e,createdAt:new Date,storeId:n,userId:this.getCurrentUser()};return D(ue(S(this.db,"categories"),i)).pipe(ae(s=>g({id:s.id},i)),M(s=>{let o=this.categoriesSubject.value;this.categoriesSubject.next([...o,s])}),L(s=>(this.handleFirestoreError(s,"Error adding category"),T(()=>s))))}deleteCategory(e){return D(Te(P(this.db,"categories",e))).pipe(M(()=>{let n=this.categoriesSubject.value;this.categoriesSubject.next(n.filter(i=>i.id!==e))}),L(n=>(this.handleFirestoreError(n,"Error deleting category"),T(()=>n))))}addExpense(e){let n=this.storeService.getActiveStoreId();if(!n)return T(()=>new Error("Store selection required for this transaction."));let i=_(g({},e),{timestamp:new Date,storeId:n}),s=_(g({},i),{userId:this.getFirestoreUserId()});return D(ue(S(this.db,"expenses"),s)).pipe(ae(o=>o.id),L(o=>(console.warn("Firestore write failed (proceeding with Legacy):",o),B(void 0))),U(o=>{let c=_(g({},i),{userId:this.getCurrentUser()});return o&&Object.assign(c,{id:o}),this.http.post(`${this.apiUrl}/expenses`,c)}),M({next:o=>{let c=this.expensesSubject.value;c.find(u=>u.id===o.id)||this.expensesSubject.next([...c,o]),this.loggingService.logActivity("create","expense",o.id,o.productName,`$${o.price.toFixed(2)}`)},error:o=>console.error("Error adding expense:",o)}))}deleteExpense(e){return this.storeService.getActiveStoreId()?D(Te(P(this.db,"expenses",e))).pipe(L(i=>(console.warn("Firestore delete failed (proceeding with Legacy):",i),B(void 0))),U(()=>this.http.delete(`${this.apiUrl}/expenses/${e}`)),M({next:()=>{let i=this.expensesSubject.value;this.expensesSubject.next(i.filter(s=>s.id!==e)),this.loggingService.logActivity("delete","expense",e,"Expense","Deleted")},error:i=>console.error("Error deleting expense:",i)})):T(()=>new Error("Store selection required for this transaction."))}addProduct(e){let n=this.storeService.getActiveStoreId();return n?this.storeService.stores$.pipe(qe(1),U(i=>{let o=i.find(d=>d.id===n)?.subscriptionPlan||"Free",c=this.productsSubject.value.length,u=1/0;if(o==="Free"?u=10:(o==="Starter"||o.includes("Starter"))&&(u=2e3),c>=u)return T(()=>new Error(`Product Limit Reached for ${o} plan (${u}). Upgrade to store more.`));let l=_(g({},e),{createdAt:new Date,storeId:n}),h=_(g({},l),{userId:this.getFirestoreUserId()});return D(ue(S(this.db,"products"),h)).pipe(ae(d=>d.id),L(d=>(console.warn("Firestore write failed:",d),B(void 0))),U(d=>{let p=_(g({},l),{userId:this.getCurrentUser()});return d&&Object.assign(p,{id:d}),this.http.post(`${this.apiUrl}/products`,p)}),M({next:d=>{let p=this.productsSubject.value;p.find(I=>I.id===d.id)||this.productsSubject.next([...p,d]),this.loggingService.logActivity("create","product",d.id,d.name),this.recalculateAndSaveStats()},error:d=>this.handleFirestoreError(d,"Error adding product")}))})):T(()=>new Error("Store selection required for this transaction."))}deleteProduct(e){if(!this.storeService.getActiveStoreId())return T(()=>new Error("Store selection required for this transaction."));let s=this.productsSubject.value.find(o=>o.id===e);return D(Te(P(this.db,"products",e))).pipe(L(o=>(console.warn("Firestore delete failed (proceeding with Legacy):",o),B(void 0))),U(()=>this.http.delete(`${this.apiUrl}/products/${e}`)),M({next:()=>{let o=this.productsSubject.value;this.productsSubject.next(o.filter(c=>c.id!==e)),this.loggingService.logActivity("delete","product",e,s?.name||"Product","Deleted")},error:o=>console.error("Error deleting product:",o)}))}recordSale(e,n,i,s,o,c,u=0,l="amount",h){let p=this.productsSubject.value.find(G=>G.id===e);if(!p)return T(()=>new Error("Product not found"));if(p.quantity<n)return T(()=>new Error("Insufficient quantity"));let I=p.price*n;u>0&&(l==="percent"?I=I-I*(u/100):I=I-u),I=Math.max(0,Math.round(I*100)/100);let k=i-I;if(k<0)return T(()=>new Error("Insufficient cash"));let y=this.storeService.getActiveStoreId();return y?this.storeService.stores$.pipe(qe(1),U(G=>{let V=G.find(v=>v.id===y);if(!this.storeService.hasTransactionCredits(y))return T(()=>new Error("Transaction Limit Reached. Please Upgrade to Pro or Top Up."));let C={productId:p.id,productName:p.name,category:p.category,price:p.price,quantitySold:n,total:I,cashReceived:i,change:k,pending:!0,discount:u,discountType:l,timestamp:new Date,storeId:y};s&&(C.deliveryDate=s),o&&(C.deliveryNotes=o),c&&(C.customerId=c),h&&(C.orderId=h);let He=_(g({},C),{userId:this.getFirestoreUserId()});return D(ue(S(this.db,"sales"),He)).pipe(ae(v=>v.id),L(v=>(console.warn("Firestore Sale Write Failed:",v),B(void 0))),U(v=>{let z=_(g({},C),{userId:this.getCurrentUser()});return v&&Object.assign(z,{id:v}),this.http.post(`${this.apiUrl}/sales`,z)}),M({next:v=>{this.storeService.deductTransactionCredit(y);let z=this.transformSale(v),me=this._sales();if(!me.find(m=>m.id===z.id)){let m=[...me,z];this._sales.set(m),this.salesSubject.next(m)}this.loggingService.logActivity("create","sale",v.id,p.name,`Sold ${n} units (Pending Delivery)`),this.recalculateAndSaveStats()},error:v=>console.error("Error recording sale:",v)}))})):T(()=>new Error("Store selection required for this transaction."))}completePendingSale(e){let n=this.salesSubject.value,i=n.find(s=>s.id===e);if(!i){console.error("Sale not found via ID");return}this.http.put(`${this.apiUrl}/sales/${e}`,{pending:!1}).subscribe({next:()=>{let s=n.map(u=>u.id===e?_(g({},u),{pending:!1}):u);this.salesSubject.next(s);let c=this.productsSubject.value.find(u=>u.id===i.productId);if(c){let u=_(g({},c),{quantity:c.quantity-i.quantitySold});this.updateProduct(u).subscribe()}if(i.customerId){let u=this.customerService.getCustomerById(i.customerId);if(u){let l=Math.floor(i.total/5e3);if(l>0){let h=u.credits||0;this.customerService.updateCustomer(u.id,{credits:h+l}),this.loggingService.logActivity("update","customer",u.id,u.name,`Awarded ${l} credits for purchase`)}}}this.loggingService.logActivity("complete","sale",e,i.productName,`Marked as delivered & Deducted ${i.quantitySold} units`),this.recalculateAndSaveStats()},error:s=>console.error("Error completing sale:",s)})}updateSale(e){let n=this.storeService.getActiveStoreId();if(!n){console.error("Store selection required to update sale.");return}this.http.put(`${this.apiUrl}/sales/${e.id}`,_(g({},e),{storeId:n})).subscribe({next:i=>{let o=this.salesSubject.value.map(c=>c.id===e.id?this.transformSale(i):c);this.salesSubject.next(o),this.loggingService.logActivity("update","sale",e.id,e.productName,"Updated delivery details")},error:i=>console.error("Error updating sale:",i)})}confirmReservation(e){if(!this.productsSubject.value.find(o=>o.id===e.productId)){console.error("Product not found for confirmation stock deduction");return}let s=_(g({},e),{reservationStatus:"confirmed"});this.http.put(`${this.apiUrl}/sales/${e.id}`,s).subscribe({next:o=>{let u=this.salesSubject.value.map(l=>l.id===e.id?this.transformSale(s):l);this.salesSubject.next(u),this.loggingService.logActivity("update","sale",e.id,e.productName,"Confirmed reservation (Stock deduction pending delivery)")},error:o=>console.error("Error confirming reservation:",o)})}transformSale(e){return _(g({},e),{timestamp:this.parseDate(e.timestamp),deliveryDate:e.deliveryDate?this.parseDate(e.deliveryDate):void 0})}parseDate(e){if(!e)return new Date;if(e instanceof Date)return e;if(e&&typeof e.toDate=="function")return e.toDate();if(e&&(e.seconds!==void 0||e._seconds!==void 0)){let n=e.seconds??e._seconds;return new Date(n*1e3)}return typeof e=="string"?new Date(e):new Date(e)}restockProduct(e,n){let s=this.productsSubject.value.find(o=>o.id===e);if(s){let o=_(g({},s),{quantity:s.quantity+n});this.updateProduct(o).subscribe(),this.loggingService.logActivity("restock","product",e,s.name,`Added ${n} units`)}}deleteSale(e){this.http.delete(`${this.apiUrl}/sales/${e}`).subscribe({next:()=>{let i=this._sales().filter(s=>s.id!==e);this._sales.set(i),this.salesSubject.next(i),this.loggingService.logActivity("delete","sale",e,"Reservation/Sale","Deleted sale record"),this.recalculateAndSaveStats()},error:n=>console.error("Error deleting sale:",n)})}updateProduct(e){let n=this.storeService.getActiveStoreId();if(!n)return T(()=>new Error("Store selection required for this transaction."));let i=_(g({},e),{storeId:n,userId:this.getFirestoreUserId()});return D(X(P(this.db,"products",e.id),i,{merge:!0})).pipe(L(s=>(console.warn("Firestore update failed (proceeding with Legacy):",s),B(void 0))),U(()=>this.http.put(`${this.apiUrl}/products/${e.id}`,e)),M({next:()=>{let o=this._products().map(l=>l.id===e.id?e:l);this._products.set(o),this.productsSubject.next(o);let c=this.salesSubject.value,u=c.filter(l=>l.productId===e.id&&l.productName!==e.name);if(u.length>0){let l=c.map(h=>h.productId===e.id?_(g({},h),{productName:e.name}):h);this._sales.set(l),this.salesSubject.next(l),u.forEach(h=>{let d=_(g({},h),{productName:e.name});this.http.put(`${this.apiUrl}/sales/${h.id}`,d).subscribe({error:p=>console.error(`Error updating sale ${h.id} name:`,p)})})}this.loggingService.logActivity("update","product",e.id,e.name),this.recalculateAndSaveStats()},error:s=>console.error("Error updating product:",s)}))}recalculateAndSaveStats(){let e=this.storeService.getActiveStoreId();if(!e)return;let n=this.productsSubject.value,i=this.salesSubject.value,s=i.reduce((m,E)=>m+(E.total||0),0),o=new Date,c=new Date(o.getFullYear(),o.getMonth(),1),u=i.filter(m=>new Date(m.timestamp)>=c).reduce((m,E)=>m+(E.total||0),0),l=o.toISOString().split("T")[0],h=i.filter(m=>new Date(m.timestamp).toISOString().split("T")[0]===l),d=h.reduce((m,E)=>m+(E.total||0),0),p=h.length,I=n.length,k=n.filter(m=>(m.quantity||0)<=5).length,y={};i.forEach(m=>{let E=m.productId||m.productName;y[E]||(y[E]={name:m.productName,units:0,rev:0}),y[E].units+=m.quantitySold||1,y[E].rev+=m.total||0});let G=Object.values(y).sort((m,E)=>E.rev-m.rev).slice(0,5).map(m=>({name:m.name,unitsSold:m.units,revenue:m.rev})),V={};n.forEach(m=>{let E=m.category||"Others";V[E]=(V[E]||0)+1});let C=Object.entries(V).map(([m,E])=>({name:m,percentage:Math.round(E/(n.length||1)*100)})),He=[...i].sort((m,E)=>new Date(E.timestamp).getTime()-new Date(m.timestamp).getTime()).slice(0,5),v={};i.forEach(m=>{let E=m.customerId||m.customerName||"Walk-in";v[E]||(v[E]={name:m.customerName||"Customer",totalSpent:0,ordersCount:0}),v[E].totalSpent+=m.total||0,v[E].ordersCount+=1});let z=Object.values(v).sort((m,E)=>E.totalSpent-m.totalSpent).slice(0,5),me={totalRevenue:s,mtdRevenue:u,todayRevenue:d,todayOrdersCount:p,totalProductsCount:I,lowStockCount:k,lastUpdated:new Date,storeId:e,topSellingProducts:G,categoryDistribution:C,recentOrders:He,topCustomers:z};X(P(this.db,"stats",e),me).catch(m=>console.error("Error updating aggregation document:",m))}clearAllData(){this.productsSubject.next([]),this.salesSubject.next([]),this.expensesSubject.next([])}migrateFromLocalStorage(){let e=localStorage.getItem("jjm_products"),n=localStorage.getItem("jjm_sales"),i=localStorage.getItem("jjm_expenses");e&&JSON.parse(e).forEach(o=>this.addProduct(o).subscribe()),n&&JSON.parse(n).forEach(o=>{this.http.post(`${this.apiUrl}/sales`,o).subscribe({error:c=>console.error("Error migrating sale:",c)})}),i&&JSON.parse(i).forEach(o=>this.addExpense(o).subscribe()),console.log("Migration started...")}static{this.\u0275fac=function(n){return new(n||r)(Y(Pt),Y(Gt),Y(zt),Y(qt),Y(kt),Y(Hn))}}static{this.\u0275prov=ge({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{Hn as a,Eo as b};
