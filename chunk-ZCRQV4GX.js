import{La as x,M as S,P as w,U as _,Wc as g,Xc as p,Yc as I,Zc as l,bd as C,cd as D,dd as E,ed as N,g as y,i as a,j,jd as R,k as d,kd as A,o as h,x as f}from"./chunk-OBNOSUJD.js";import{a as n,b as v}from"./chunk-7QOE2ANW.js";var k=(()=>{class m{get db(){return this.firebaseService.db}constructor(e,t){this.firebaseService=e,this.storeService=t,this._customers=x([]),this.customers=this._customers.asReadonly(),this.customersSubject=new y([]),this.customers$=this.customersSubject.asObservable(),this.hydrateFromCache(),this.storeService.activeStoreId$.subscribe(s=>{s?this.loadCustomers(!0):(this._customers.set([]),this.customersSubject.next([]))})}hydrateFromCache(){let e=localStorage.getItem("jjm_cached_customers");if(e)try{let t=JSON.parse(e);this._customers.set(t),this.customersSubject.next(t),console.log("Hydrated Customers from cache")}catch(t){console.warn("Failed to hydrate customers from cache",t)}}saveToCache(e){localStorage.setItem("jjm_cached_customers",JSON.stringify(e))}loadCustomers(e=!1){if(!e&&this._customers().length>0){console.log("Customers already loaded in Signal. Skipping fetch.");return}this.fetchCustomers()}loadInitialData(){this.loadCustomers()}getCurrentUser(){return localStorage.getItem("jjm_user_id")||"guest"}reloadData(){this.loadCustomers(!0)}fetchCustomers(){let e=this.storeService.getActiveStoreId();if(!e){console.log("CustomerService: No storeId, clearing customers."),this._customers.set([]),this.customersSubject.next([]);return}console.log("CustomerService: Fetching customers for storeId:",e);let t=g(this.db,"customers"),s=I(t,l("storeId","==",e));C(s).then(o=>{let r=o.docs.map(i=>n({id:i.id},i.data()));this._customers.set(r),this.customersSubject.next(r),this.saveToCache(r)}).catch(o=>console.error("Error fetching customers:",o))}getCustomers(){return this.customers$}getCustomerByName(e){let t=this.storeService.getActiveStoreId();if(!t)return j([]);let s=g(this.db,"customers"),o=I(s,l("storeId","==",t));return a(C(o)).pipe(h(r=>r.docs.map(c=>n({id:c.id},c.data())).filter(c=>c.name?.toLowerCase().includes(e.toLowerCase())).map(c=>v(n({},c),{phoneNumber:c.phoneNumber,deliveryAddress:"***",gpsCoordinates:"***",userId:"***"}))))}getCustomerByPhone(e){let t=this.storeService.getActiveStoreId();if(!t)return j([]);let s=g(this.db,"customers"),o=I(s,l("storeId","==",t),l("phoneNumber","==",e));return a(C(o)).pipe(h(r=>r.docs.map(i=>n({id:i.id},i.data()))))}addCustomer(e){let t=this.storeService.getActiveStoreId();if(!t&&!e.storeId)return d(()=>new Error("Store selection required for this transaction."));let s=this.enforceStoreId(e.storeId||t||""),o=crypto.randomUUID(),r=v(n({},e),{id:o,userId:this.getCurrentUser(),storeId:s,createdAt:new Date}),i=p(this.db,"customers",o);return a(D(i,r)).pipe(h(()=>r),S(u=>{let b=[...this._customers(),u];this._customers.set(b),this.customersSubject.next(b),this.saveToCache(b)}),f(u=>(console.error("Error adding customer:",u),d(()=>u))))}updateCustomer(e,t){let s=n({},t);s.storeId&&(s.storeId=this.enforceStoreId(s.storeId));let o=p(this.db,"customers",e);return a(E(o,s)).pipe(h(()=>{let i=this._customers().find(u=>u.id===e);return n(n({},i),t)}),S(r=>{let u=this._customers().map(c=>c.id===e?n(n({},c),t):c);this._customers.set(u),this.customersSubject.next(u),this.saveToCache(u)}),f(r=>(console.error("Error updating customer:",r),d(()=>r))))}deleteCustomer(e){let t=p(this.db,"customers",e);return a(N(t)).pipe(S(()=>{let o=this._customers().filter(r=>r.id!==e);this._customers.set(o),this.customersSubject.next(o),this.saveToCache(o)}),f(s=>(console.error("Error deleting customer:",s),d(()=>s))))}getCustomerById(e){return this.customersSubject.value.find(t=>t.id===e)}enforceStoreId(e){let t=localStorage.getItem("jjm_role"),s=localStorage.getItem("jjm_store_id");return t==="super-admin"?e:s||void 0}static{this.\u0275fac=function(t){return new(t||m)(_(R),_(A))}}static{this.\u0275prov=w({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})();export{k as a};
