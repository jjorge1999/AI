import{La as w,M as f,P as y,U as I,Wc as p,Xc as g,Zc as C,_c as b,cd as S,dd as x,ed as D,fd as E,g as j,i as a,j as _,k as d,md as R,nd as N,o as h,x as l}from"./chunk-IZ5DWI6X.js";import{a as u,b as v}from"./chunk-7QOE2ANW.js";var k=(()=>{class m{get db(){return this.firebaseService.db}constructor(t,e){this.firebaseService=t,this.storeService=e,this._customers=w([]),this.customers=this._customers.asReadonly(),this.customersSubject=new j([]),this.customers$=this.customersSubject.asObservable(),this.hydrateFromCache()}hydrateFromCache(){let t=localStorage.getItem("jjm_cached_customers");if(t)try{let e=JSON.parse(t);this._customers.set(e),this.customersSubject.next(e),console.log("Hydrated Customers from cache")}catch(e){console.warn("Failed to hydrate customers from cache",e)}}saveToCache(t){localStorage.setItem("jjm_cached_customers",JSON.stringify(t))}loadCustomers(t=!1){if(!t&&this._customers().length>0){console.log("Customers already loaded in Signal. Skipping fetch.");return}this.fetchCustomers()}loadInitialData(){this.loadCustomers()}getCurrentUser(){return localStorage.getItem("jjm_user_id")||"guest"}reloadData(){this.loadCustomers(!0)}fetchCustomers(){let t=this.getCurrentUser(),e=this.storeService.getActiveStoreId();if(!t||t==="guest"||!e){e||(this._customers.set([]),this.customersSubject.next([]));return}let c=p(this.db,"customers"),s=C(c,b("storeId","==",e));S(s).then(r=>{let o=r.docs.map(n=>u({id:n.id},n.data()));this._customers.set(o),this.customersSubject.next(o),this.saveToCache(o)}).catch(r=>console.error("Error fetching customers:",r))}getCustomers(){return this.customers$}getCustomerByName(t){let e=this.storeService.getActiveStoreId();if(!e)return _([]);let c=p(this.db,"customers"),s=C(c,b("storeId","==",e));return a(S(s)).pipe(h(r=>r.docs.map(i=>u({id:i.id},i.data())).filter(i=>i.name?.toLowerCase().includes(t.toLowerCase())).map(i=>v(u({},i),{phoneNumber:i.phoneNumber,deliveryAddress:"***",gpsCoordinates:"***",userId:"***"}))))}getCustomerByPhone(t){let e=p(this.db,"customers"),c=C(e,b("phoneNumber","==",t));return a(S(c)).pipe(h(s=>s.docs.map(r=>u({id:r.id},r.data()))))}addCustomer(t){let e=this.storeService.getActiveStoreId();if(!e)return d(()=>new Error("Store selection required for this transaction."));let c=crypto.randomUUID(),s=v(u({},t),{id:c,userId:this.getCurrentUser(),storeId:e,createdAt:new Date}),r=g(this.db,"customers",c);return a(x(r,s)).pipe(h(()=>s),f(o=>{let i=[...this._customers(),o];this._customers.set(i),this.customersSubject.next(i),this.saveToCache(i)}),l(o=>(console.error("Error adding customer:",o),d(()=>o))))}updateCustomer(t,e){let c=g(this.db,"customers",t);return a(D(c,e)).pipe(h(()=>{let r=this._customers().find(o=>o.id===t);return u(u({},r),e)}),f(s=>{let o=this._customers().map(n=>n.id===t?u(u({},n),e):n);this._customers.set(o),this.customersSubject.next(o),this.saveToCache(o)}),l(s=>(console.error("Error updating customer:",s),d(()=>s))))}deleteCustomer(t){let e=g(this.db,"customers",t);return a(E(e)).pipe(f(()=>{let s=this._customers().filter(r=>r.id!==t);this._customers.set(s),this.customersSubject.next(s),this.saveToCache(s)}),l(c=>(console.error("Error deleting customer:",c),d(()=>c))))}getCustomerById(t){return this.customersSubject.value.find(e=>e.id===t)}static{this.\u0275fac=function(e){return new(e||m)(I(R),I(N))}}static{this.\u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})();export{k as a};
