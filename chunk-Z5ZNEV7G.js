import{P as L,U as S,Xc as g,Zc as b,_c as u,ad as x,cd as p,g as y,gd as A,i as m,j as f,jd as N,kd as k,md as B,o as D,x as w}from"./chunk-TA5RWKR2.js";import{a as h,b as I,g as j}from"./chunk-7QOE2ANW.js";var O=(()=>{class n{get db(){return this.firebaseService.db}constructor(i,t){this.firebaseService=i,this.storeService=t,this.logsSubject=new y([]),this.logs$=this.logsSubject.asObservable(),this.storeService.activeStoreId$.subscribe(r=>{r?this.fetchLogs(r):this.logsSubject.next([])})}getCurrentUserId(){return localStorage.getItem("jjm_user_id")||"guest"}fetchLogs(i){let t=i||this.storeService.getActiveStoreId();if(!t){this.logsSubject.next([]);return}let r=g(this.db,"activityLogs"),a=b(r,u("storeId","==",t),x(200));m(p(a)).subscribe({next:c=>{let o=c.docs.map(e=>{let s=e.data();return I(h({id:e.id},s),{timestamp:s.timestamp?.toDate?s.timestamp.toDate():s.timestamp})}).sort((e,s)=>{let d=e.timestamp instanceof Date?e.timestamp.getTime():0;return(s.timestamp instanceof Date?s.timestamp.getTime():0)-d});this.logsSubject.next(o)},error:c=>{}})}logActivity(i,t,r,a,c){let o=this.storeService.getActiveStoreId();if(!o)return;let e=this.getCurrentUserId()||"system",s=localStorage.getItem("jjm_user_name")||localStorage.getItem("jjm_user_email")||e,d=this.storeService.getActiveStoreName()||"Unknown Store",l={action:i||"unknown",entityType:t||"unknown",entityId:r||"",entityName:a||"",details:c||"",userId:e,userName:s,storeId:o,storeName:d,timestamp:new Date},U=g(this.db,"activityLogs");m(A(U,l)).subscribe({next:v=>{let _=h({id:v.id},l),q=this.logsSubject.value;this.logsSubject.next([_,...q])},error:v=>{}})}getLogs(){return this.logs$}refreshLogs(){this.fetchLogs()}cleanupOldLogs(){let i=this.getCurrentUserId(),t=this.storeService.getActiveStoreId();if(!t)return f({message:"No store selected"});let r=new Date;r.setDate(r.getDate()-30);let a=g(this.db,"activityLogs"),c=b(a,u("storeId","==",t),u("timestamp","<",r));return m(p(c)).pipe(D(o=>j(this,null,function*(){let e=N(this.db);return o.docs.forEach(s=>{e.delete(s.ref)}),yield e.commit(),{deleted:o.docs.length}})),w(o=>(console.error("Error cleaning up logs:",o),f({error:o.message}))))}static{this.\u0275fac=function(t){return new(t||n)(S(k),S(B))}}static{this.\u0275prov=L({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{O as a};
