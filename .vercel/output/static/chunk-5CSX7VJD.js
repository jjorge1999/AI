import{K as u,La as d,P as U,U as j,g as l,i as g,j as c,nc as b,o as n,qc as _,rc as w,x as f}from"./chunk-OKMRB5PS.js";import{a as h,b as m}from"./chunk-7QOE2ANW.js";var T=(()=>{class a{setLoginState(e,t){this.loggedInSubject.next(e),this.isLoggedIn.set(e),t?(this._currentUser.set(t),this.currentUserSubject.next(t),localStorage.setItem("jjm_user_id",t.id),localStorage.setItem("jjm_user_role",t.role)):e||(this._currentUser.set(null),this.currentUserSubject.next(null))}constructor(e,t){this.http=e,this.storeService=t,this.apiUrl=_.apiUrl,this._users=d([]),this.users=this._users.asReadonly(),this._currentUser=d(null),this.currentUser=this._currentUser.asReadonly(),this.usersSubject=new l([]),this.users$=this.usersSubject.asObservable(),this.loggedInSubject=new l(localStorage.getItem("jjm_logged_in")==="true"),this.isLoggedIn$=this.loggedInSubject.asObservable(),this.isLoggedIn=d(localStorage.getItem("jjm_logged_in")==="true"),this.currentUserSubject=new l(null),this.currentUser$=this.currentUserSubject.asObservable(),this.hydrateFromCache()}hydrateFromCache(){let e=localStorage.getItem("jjm_cached_users");if(e)try{let t=JSON.parse(e);this._users.set(t),this.usersSubject.next(t),console.log("Hydrated Users from cache");let r=localStorage.getItem("jjm_user_id");if(r){let s=t.find(i=>i.id===r);s&&(this._currentUser.set(s),this.currentUserSubject.next(s))}}catch(t){console.warn("Failed to hydrate users from cache",t)}}saveToCache(e){localStorage.setItem("jjm_cached_users",JSON.stringify(e))}hashPassword(e){let r=new TextEncoder().encode(e);return g(crypto.subtle.digest("SHA-256",r)).pipe(n(s=>Array.from(new Uint8Array(s)).map(i=>i.toString(16).padStart(2,"0")).join("")))}loadUsers(e=!1){if(!e&&this._users().length>0){console.log("Users already loaded in Signal. Skipping fetch.");return}let t=localStorage.getItem("jjm_user_id");this.http.get(`${this.apiUrl}/users`).subscribe({next:r=>{let s=r.map(i=>this.transformUser(i));if(s.length===0)this.initializeDefaultAdmin().subscribe();else if(this._users.set(s),this.usersSubject.next(s),t){let i=s.find(o=>o.id===t);i&&(this._currentUser.set(i),this.currentUserSubject.next(i))}},error:r=>{console.error("Error fetching users:",r),r.status===404&&this.initializeDefaultAdmin().subscribe()}})}initializeDefaultAdmin(){return this.usersSubject.value.length>0?c(void 0):this.hashPassword("Gr*l0v3R").pipe(u(e=>{let t={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:e,role:"admin",createdAt:new Date,hasSubscription:!0};return this.http.post(`${this.apiUrl}/users`,t).pipe(n(r=>{let s=this.transformUser(r);this._users.set([s]),this.usersSubject.next([s])}),f(r=>(console.warn("Could not save default admin to backend, using local only",r),this._users.set([t]),this.usersSubject.next([t]),c(void 0))))}))}getUsers(){return this.users$}addUser(e){let t=m(h({},e),{createdAt:new Date,userId:e.userId||localStorage.getItem("jjm_user_id")||"system"});return this.hashPassword(e.password||"").pipe(u(r=>(t.password=r,this.http.post(`${this.apiUrl}/users`,t))),n(r=>{let s=this.transformUser(r),o=[...this._users(),s];return this._users.set(o),this.usersSubject.next(o),this.saveToCache(o),s}))}updateUser(e){let t=h({},e);return(t.password?this.hashPassword(t.password):c(void 0)).pipe(u(s=>(s&&(t.password=s),this.http.put(`${this.apiUrl}/users/${t.id}`,t))),n(s=>{let i=this.transformUser(s),p=this._users().map(S=>S.id===i.id?i:S);return this._users.set(p),this.usersSubject.next(p),this.saveToCache(p),i}))}deleteUser(e){return this.http.delete(`${this.apiUrl}/users/${e}`).pipe(n(()=>{let r=this._users().filter(s=>s.id!==e);this._users.set(r),this.usersSubject.next(r),this.saveToCache(r)}))}getUserById(e){return this.usersSubject.value.find(t=>t.id===e)}validateCredentials(e,t){return this.hashPassword(t).pipe(u(r=>this.http.post(`${this.apiUrl}/login`,{username:e,password:r}).pipe(n(s=>{if(!s)return null;let i=this.transformUser(s);return i.storeId&&this.storeService.setActiveStore(i.storeId),i}),f(s=>c(null)))))}transformUser(e){let t=m(h({},e),{createdAt:this.parseDate(e.createdAt)});return(t.role==="admin"||t.username==="jjm143256789")&&(t.hasSubscription=!0),t}parseDate(e){return e?e instanceof Date?e:typeof e=="string"?new Date(e):typeof e=="object"&&e._seconds!==void 0?new Date(e._seconds*1e3):new Date(e):new Date}static{this.\u0275fac=function(t){return new(t||a)(j(b),j(w))}}static{this.\u0275prov=U({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{T as a};
