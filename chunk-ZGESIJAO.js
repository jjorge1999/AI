import{H as p,M as j,R as g,bc as S,c as f,ec as U,g as d,i as l,j as b,o as u,w}from"./chunk-X3H5FUR6.js";import{a,b as h,g as o}from"./chunk-7QOE2ANW.js";var P=(()=>{class n{setLoginState(t){this.loggedInSubject.next(t)}constructor(t){this.http=t,this.apiUrl=U.apiUrl,this.usersSubject=new d([]),this.users$=this.usersSubject.asObservable(),this.loggedInSubject=new d(localStorage.getItem("jjm_logged_in")==="true"),this.isLoggedIn$=this.loggedInSubject.asObservable()}hashPassword(t){return o(this,null,function*(){let s=new TextEncoder().encode(t),r=yield crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("")})}loadUsers(){this.http.get(`${this.apiUrl}/users`).subscribe({next:t=>{let e=t.map(s=>this.transformUser(s));e.length===0?this.initializeDefaultAdmin():this.usersSubject.next(e)},error:t=>{console.error("Error fetching users:",t),t.status===404&&this.initializeDefaultAdmin()}})}initializeDefaultAdmin(){return o(this,null,function*(){if(this.usersSubject.value.length>0)return;let e={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:yield this.hashPassword("Gr*l0v3R"),role:"admin",createdAt:new Date,hasSubscription:!0};this.http.post(`${this.apiUrl}/users`,e).subscribe({next:s=>{let r=this.transformUser(s);this.usersSubject.next([r])},error:s=>{console.warn("Could not save default admin to backend, using local only",s),this.usersSubject.next([e])}})})}getUsers(){return this.users$}addUser(t){let e=h(a({},t),{createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system"});return l(this.hashPassword(t.password||"")).pipe(p(s=>(e.password=s,this.http.post(`${this.apiUrl}/users`,e))),u(s=>{let r=this.transformUser(s),i=this.usersSubject.value;return this.usersSubject.next([...i,r]),r}))}updateUser(t){return new f(e=>{o(this,null,function*(){let r=a({},t);r.password&&(r.password=yield this.hashPassword(r.password)),this.http.put(`${this.apiUrl}/users/${r.id}`,r).subscribe({next:i=>{let c=this.transformUser(i),y=this.usersSubject.value.map(m=>m.id===c.id?c:m);this.usersSubject.next(y),e.next(c),e.complete()},error:i=>e.error(i)})})})}deleteUser(t){return this.http.delete(`${this.apiUrl}/users/${t}`).pipe(u(()=>{let e=this.usersSubject.value;this.usersSubject.next(e.filter(s=>s.id!==t))}))}getUserById(t){return this.usersSubject.value.find(e=>e.id===t)}validateCredentials(t,e){return l(this.hashPassword(e)).pipe(p(s=>this.http.post(`${this.apiUrl}/login`,{username:t,password:s}).pipe(u(r=>r?this.transformUser(r):null),w(r=>b(null)))))}transformUser(t){let e=h(a({},t),{createdAt:this.parseDate(t.createdAt)});return(e.role==="admin"||e.username==="jjm143256789")&&(e.hasSubscription=!0),e}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):new Date(t):new Date}static{this.\u0275fac=function(e){return new(e||n)(g(S))}}static{this.\u0275prov=j({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{P as a};
