import{K as p,La as b,P as A,U as w,Wc as y,Xc as S,Yc as g,Zc as I,bd as D,cd as x,dd as C,ed as R,g as _,i as l,j,jd as T,kd as E,o as h,x as m}from"./chunk-OBNOSUJD.js";import{a as d,b as v}from"./chunk-7QOE2ANW.js";var k=(()=>{class f{get db(){return this.firebaseService.db}setLoginState(t,e){this.loggedInSubject.next(t),this.isLoggedIn.set(t),e?(this._currentUser.set(e),this.currentUserSubject.next(e),localStorage.setItem("jjm_user_id",e.id),localStorage.setItem("jjm_role",e.role),e.storeId&&(localStorage.setItem("jjm_store_id",e.storeId),this.storeService.setActiveStore(e.storeId)),sessionStorage.setItem("jjm_user_details",JSON.stringify(e))):t||(this._currentUser.set(null),this.currentUserSubject.next(null),localStorage.removeItem("jjm_user_id"),localStorage.removeItem("jjm_role"),localStorage.removeItem("jjm_store_id"),sessionStorage.removeItem("jjm_user_details"))}constructor(t,e){this.firebaseService=t,this.storeService=e,this._users=b([]),this.users=this._users.asReadonly(),this._currentUser=b(null),this.currentUser=this._currentUser.asReadonly(),this.usersSubject=new _([]),this.users$=this.usersSubject.asObservable(),this.loggedInSubject=new _(localStorage.getItem("jjm_logged_in")==="true"),this.isLoggedIn$=this.loggedInSubject.asObservable(),this.isLoggedIn=b(localStorage.getItem("jjm_logged_in")==="true"),this.currentUserSubject=new _(null),this.currentUser$=this.currentUserSubject.asObservable(),this.hydrateFromCache()}hydrateFromCache(){let t=localStorage.getItem("jjm_cached_users");if(t)try{let e=JSON.parse(t);this._users.set(e),this.usersSubject.next(e),console.log("Hydrated Users from cache");let s=localStorage.getItem("jjm_user_id");if(s){let r=e.find(o=>o.id===s);r&&(this._currentUser.set(r),this.currentUserSubject.next(r),r.storeId&&this.storeService.setActiveStore(r.storeId))}}catch(e){console.warn("Failed to hydrate users from cache",e)}}saveToCache(t){localStorage.setItem("jjm_cached_users",JSON.stringify(t))}hashPassword(t){let s=new TextEncoder().encode(t);return l(crypto.subtle.digest("SHA-256",s)).pipe(h(r=>Array.from(new Uint8Array(r)).map(o=>o.toString(16).padStart(2,"0")).join("")))}loadUsers(t=!1){if(!t&&this._users().length>0){console.log("Users already loaded in Signal. Skipping fetch.");return}let e=this.currentUser(),s=e?.id||localStorage.getItem("jjm_user_id"),r=e?.role||localStorage.getItem("jjm_role"),o=e?.storeId||localStorage.getItem("jjm_store_id");if(!s)return;let i=y(this.db,"users"),u;r==="super-admin"?u=g(i):r==="admin"&&o?u=g(i,I("storeId","==",o)):u=g(i,I("id","==",s)),D(u).then(n=>{let c=n.docs.map(a=>{let U=a.data();return this.transformUser(d({id:a.id},U))});if(c.length===0&&r==="admin"&&!o)this.initializeDefaultAdmin().subscribe();else{this._users.set(c),this.usersSubject.next(c),this.saveToCache(c);let a=c.find(U=>U.id===s);a&&(this._currentUser.set(a),this.currentUserSubject.next(a))}}).catch(n=>{console.error("Error fetching users:",n),r==="super-admin"&&this.initializeDefaultAdmin().subscribe()})}initializeDefaultAdmin(){return this.usersSubject.value.length>0?j(void 0):this.hashPassword("Gr*l0v3R").pipe(p(t=>{let e={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:t,role:"super-admin",createdAt:new Date,hasSubscription:!0},s=S(this.db,"users",e.id);return l(x(s,e)).pipe(h(()=>{let r=this.transformUser(e);this._users.set([r]),this.usersSubject.next([r]),this.saveToCache([r])}),m(r=>(console.warn("Could not save default admin to Firestore, using local only",r),this._users.set([e]),this.usersSubject.next([e]),j(void 0))))}))}getUsers(){return this.users$}addUser(t){let e=crypto.randomUUID(),s=v(d({},t),{id:e,createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system",storeId:this.enforceStoreId(t.storeId)});return this.hashPassword(t.password||"").pipe(p(r=>{s.password=r;let o=S(this.db,"users",e);return l(x(o,s)).pipe(h(()=>{let i=this.transformUser(s),n=[...this._users(),i];return this._users.set(n),this.usersSubject.next(n),this.saveToCache(n),i}))}),m(r=>{throw console.error("Error adding user:",r),r}))}updateUser(t){let e=d({},t);return e.storeId&&(e.storeId=this.enforceStoreId(e.storeId)),Object.keys(e).forEach(r=>{e[r]===void 0&&delete e[r]}),(e.password?this.hashPassword(e.password):j(void 0)).pipe(p(r=>{r&&(e.password=r);let o=S(this.db,"users",e.id);return l(C(o,e)).pipe(h(()=>{let i=this._users(),u=i.find(a=>a.id===e.id),n=this.transformUser(d(d({},u),e)),c=i.map(a=>a.id===n.id?n:a);return this._users.set(c),this.usersSubject.next(c),this.saveToCache(c),n}))}),m(r=>{throw console.error("Error updating user:",r),r}))}deleteUser(t){let e=S(this.db,"users",t);return l(R(e)).pipe(h(()=>{let r=this._users().filter(o=>o.id!==t);this._users.set(r),this.usersSubject.next(r),this.saveToCache(r)}),m(s=>{throw console.error("Error deleting user:",s),s}))}getUserById(t){return this.usersSubject.value.find(e=>e.id===t)}validateCredentials(t,e){return this.hashPassword(e).pipe(p(s=>{let r=y(this.db,"users"),o=g(r,I("username","==",t));return l(D(o)).pipe(h(i=>{if(i.empty)return null;let u=i.docs[0],n=u.data();if(n.password!==s)return null;let c=this.transformUser(d({id:u.id},n));return c.storeId&&this.storeService.setActiveStore(c.storeId),c}),m(i=>(console.error("Login error:",i),j(null))))}))}transformUser(t){let e=v(d({},t),{createdAt:this.parseDate(t.createdAt)});return(e.role==="admin"||e.role==="super-admin"||e.username==="jjm143256789")&&(e.hasSubscription=!0),e.username==="jjm143256789"&&(e.role="super-admin"),e}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):typeof t=="object"&&t.toDate?t.toDate():new Date(t):new Date}enforceStoreId(t){let e=localStorage.getItem("jjm_role"),s=localStorage.getItem("jjm_store_id");return e==="super-admin"?t:s||void 0}static{this.\u0275fac=function(e){return new(e||f)(w(T),w(E))}}static{this.\u0275prov=A({token:f,factory:f.\u0275fac,providedIn:"root"})}}return f})();export{k as a};
