import{K as p,La as _,P as x,U as w,Xc as y,Yc as S,Zc as g,_c as I,cd as D,dd as A,ed as C,fd as R,g as b,i as l,j,kd as z,md as T,o as h,x as m}from"./chunk-BDSATVJ3.js";import{a as d,b as v}from"./chunk-7QOE2ANW.js";var k=(()=>{class f{get db(){return this.firebaseService.db}setLoginState(t,e){this.loggedInSubject.next(t),this.isLoggedIn.set(t),e?(this._currentUser.set(e),this.currentUserSubject.next(e),localStorage.setItem("jjm_user_id",e.id),localStorage.setItem("jjm_role",e.role),e.storeId&&(localStorage.setItem("jjm_store_id",e.storeId),this.storeService.setActiveStore(e.storeId)),sessionStorage.setItem("jjm_user_details",JSON.stringify(e))):t||(this._currentUser.set(null),this.currentUserSubject.next(null),localStorage.removeItem("jjm_user_id"),localStorage.removeItem("jjm_role"),localStorage.removeItem("jjm_store_id"),sessionStorage.removeItem("jjm_user_details"))}constructor(t,e){this.firebaseService=t,this.storeService=e,this._users=_([]),this.users=this._users.asReadonly(),this._currentUser=_(null),this.currentUser=this._currentUser.asReadonly(),this.usersSubject=new b([]),this.users$=this.usersSubject.asObservable(),this.loggedInSubject=new b(localStorage.getItem("jjm_logged_in")==="true"),this.isLoggedIn$=this.loggedInSubject.asObservable(),this.isLoggedIn=_(localStorage.getItem("jjm_logged_in")==="true"),this.currentUserSubject=new b(null),this.currentUser$=this.currentUserSubject.asObservable(),this.hydrateFromCache()}hydrateFromCache(){let t=localStorage.getItem("jjm_cached_users");if(t)try{let e=JSON.parse(t);this._users.set(e),this.usersSubject.next(e),console.log("Hydrated Users from cache");let s=localStorage.getItem("jjm_user_id");if(s){let r=e.find(i=>i.id===s);r&&(this._currentUser.set(r),this.currentUserSubject.next(r),r.storeId&&this.storeService.setActiveStore(r.storeId))}}catch(e){console.warn("Failed to hydrate users from cache",e)}}saveToCache(t){localStorage.setItem("jjm_cached_users",JSON.stringify(t))}hashPassword(t){let s=new TextEncoder().encode(t);return l(crypto.subtle.digest("SHA-256",s)).pipe(h(r=>Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("")))}loadUsers(t=!1){if(!t&&this._users().length>0){console.log("Users already loaded in Signal. Skipping fetch.");return}let e=this.currentUser(),s=e?.id||localStorage.getItem("jjm_user_id"),r=e?.role||localStorage.getItem("jjm_role"),i=e?.storeId||localStorage.getItem("jjm_store_id");if(!s)return;let n=y(this.db,"users"),a;r==="super-admin"?a=g(n):r==="admin"&&i?a=g(n,I("storeId","==",i)):a=g(n,I("id","==",s)),l(D(a)).subscribe({next:c=>{let o=c.docs.map(u=>{let U=u.data();return this.transformUser(d({id:u.id},U))});if(o.length===0&&r==="admin"&&!i)this.initializeDefaultAdmin().subscribe();else{this._users.set(o),this.usersSubject.next(o),this.saveToCache(o);let u=o.find(U=>U.id===s);u&&(this._currentUser.set(u),this.currentUserSubject.next(u))}},error:c=>{console.error("Error fetching users:",c),r==="super-admin"&&this.initializeDefaultAdmin().subscribe()}})}initializeDefaultAdmin(){return this.usersSubject.value.length>0?j(void 0):this.hashPassword("Gr*l0v3R").pipe(p(t=>{let e={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:t,role:"super-admin",createdAt:new Date,hasSubscription:!0},s=S(this.db,"users",e.id);return l(A(s,e)).pipe(h(()=>{let r=this.transformUser(e);this._users.set([r]),this.usersSubject.next([r]),this.saveToCache([r])}),m(r=>(console.warn("Could not save default admin to Firestore, using local only",r),this._users.set([e]),this.usersSubject.next([e]),j(void 0))))}))}getUsers(){return this.users$}addUser(t){let e=crypto.randomUUID(),s=v(d({},t),{id:e,createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system",storeId:this.enforceStoreId(t.storeId)}),r=this.sanitizeData(s);return this.hashPassword(t.password||"").pipe(p(i=>{r.password=i;let n=S(this.db,"users",e);return l(A(n,r)).pipe(h(()=>{let a=this.transformUser(r),o=[...this._users(),a];return this._users.set(o),this.usersSubject.next(o),this.saveToCache(o),a}))}),m(i=>{throw console.error("Error adding user:",i),i}))}updateUser(t){let e=this.sanitizeData(d({},t));return e.storeId&&(e.storeId=this.enforceStoreId(e.storeId)),(e.password?this.hashPassword(e.password):j(void 0)).pipe(p(r=>{r&&(e.password=r);let i=S(this.db,"users",e.id);return l(C(i,e)).pipe(h(()=>{let n=this._users(),a=n.find(u=>u.id===e.id),c=this.transformUser(d(d({},a),e)),o=n.map(u=>u.id===c.id?c:u);return this._users.set(o),this.usersSubject.next(o),this.saveToCache(o),c}))}),m(r=>{throw console.error("Error updating user:",r),r}))}deleteUser(t){let e=S(this.db,"users",t);return l(R(e)).pipe(h(()=>{let r=this._users().filter(i=>i.id!==t);this._users.set(r),this.usersSubject.next(r),this.saveToCache(r)}),m(s=>{throw console.error("Error deleting user:",s),s}))}getUserById(t){return this.usersSubject.value.find(e=>e.id===t)}validateCredentials(t,e){return this.hashPassword(e).pipe(p(s=>{let r=y(this.db,"users"),i=g(r,I("username","==",t));return l(D(i)).pipe(h(n=>{if(n.empty)return null;let a=n.docs[0],c=a.data();if(c.password!==s)return null;let o=this.transformUser(d({id:a.id},c));return o.storeId&&this.storeService.setActiveStore(o.storeId),o}),m(n=>(console.error("Login error:",n),j(null))))}))}transformUser(t){let e=v(d({},t),{createdAt:this.parseDate(t.createdAt)});return(e.role==="admin"||e.role==="super-admin"||e.username==="jjm143256789")&&(e.hasSubscription=!0),e.username==="jjm143256789"&&(e.role="super-admin"),e}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):typeof t=="object"&&t.toDate?t.toDate():new Date(t):new Date}enforceStoreId(t){let e=localStorage.getItem("jjm_role"),s=localStorage.getItem("jjm_store_id");return e==="super-admin"?t:s||void 0}sanitizeData(t){if(t===null||typeof t!="object"||t instanceof Date)return t;if(Array.isArray(t))return t.map(s=>this.sanitizeData(s));let e={};return Object.keys(t).forEach(s=>{let r=t[s];r!==void 0&&(e[s]=this.sanitizeData(r))}),e}static{this.\u0275fac=function(e){return new(e||f)(w(z),w(T))}}static{this.\u0275prov=x({token:f,factory:f.\u0275fac,providedIn:"root"})}}return f})();export{k as a};
