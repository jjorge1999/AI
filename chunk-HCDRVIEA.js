import{K as u,P as j,U as p,g as d,i as f,j as a,mc as b,o as n,pc as S,qc as U,x as l}from"./chunk-N535F6OD.js";import{a as c,b as h}from"./chunk-7QOE2ANW.js";var D=(()=>{class o{setLoginState(t,e){this.loggedInSubject.next(t),e?(this.currentUserSubject.next(e),localStorage.setItem("jjm_user_id",e.id),localStorage.setItem("jjm_user_role",e.role)):t||this.currentUserSubject.next(null)}constructor(t,e){this.http=t,this.storeService=e,this.apiUrl=S.apiUrl,this.usersSubject=new d([]),this.users$=this.usersSubject.asObservable(),this.loggedInSubject=new d(localStorage.getItem("jjm_logged_in")==="true"),this.isLoggedIn$=this.loggedInSubject.asObservable(),this.currentUserSubject=new d(null),this.currentUser$=this.currentUserSubject.asObservable()}hashPassword(t){let s=new TextEncoder().encode(t);return f(crypto.subtle.digest("SHA-256",s)).pipe(n(r=>Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("")))}loadUsers(){let t=localStorage.getItem("jjm_user_id");this.http.get(`${this.apiUrl}/users`).subscribe({next:e=>{let s=e.map(r=>this.transformUser(r));if(s.length===0)this.initializeDefaultAdmin().subscribe();else if(this.usersSubject.next(s),t){let r=s.find(i=>i.id===t);r&&this.currentUserSubject.next(r)}},error:e=>{console.error("Error fetching users:",e),e.status===404&&this.initializeDefaultAdmin().subscribe()}})}initializeDefaultAdmin(){return this.usersSubject.value.length>0?a(void 0):this.hashPassword("Gr*l0v3R").pipe(u(t=>{let e={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:t,role:"admin",createdAt:new Date,hasSubscription:!0};return this.http.post(`${this.apiUrl}/users`,e).pipe(n(s=>{let r=this.transformUser(s);this.usersSubject.next([r])}),l(s=>(console.warn("Could not save default admin to backend, using local only",s),this.usersSubject.next([e]),a(void 0))))}))}getUsers(){return this.users$}addUser(t){let e=h(c({},t),{createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system"});return this.hashPassword(t.password||"").pipe(u(s=>(e.password=s,this.http.post(`${this.apiUrl}/users`,e))),n(s=>{let r=this.transformUser(s),i=this.usersSubject.value;return this.usersSubject.next([...i,r]),r}))}updateUser(t){let e=c({},t);return(e.password?this.hashPassword(e.password):a(void 0)).pipe(u(r=>(r&&(e.password=r),this.http.put(`${this.apiUrl}/users/${e.id}`,e))),n(r=>{let i=this.transformUser(r),g=this.usersSubject.value.map(m=>m.id===i.id?i:m);return this.usersSubject.next(g),i}))}deleteUser(t){return this.http.delete(`${this.apiUrl}/users/${t}`).pipe(n(()=>{let e=this.usersSubject.value;this.usersSubject.next(e.filter(s=>s.id!==t))}))}getUserById(t){return this.usersSubject.value.find(e=>e.id===t)}validateCredentials(t,e){return this.hashPassword(e).pipe(u(s=>this.http.post(`${this.apiUrl}/login`,{username:t,password:s}).pipe(n(r=>{if(!r)return null;let i=this.transformUser(r);return i.storeId&&this.storeService.setActiveStore(i.storeId),i}),l(r=>a(null)))))}transformUser(t){let e=h(c({},t),{createdAt:this.parseDate(t.createdAt)});return(e.role==="admin"||e.username==="jjm143256789")&&(e.hasSubscription=!0),e}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):new Date(t):new Date}static{this.\u0275fac=function(e){return new(e||o)(p(b),p(U))}}static{this.\u0275prov=j({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{D as a};
