import{I as h,J as S,K as y,L as I,M as D,P as A,Q as j,R as m,S as M,V as k}from"./chunk-RYSERWOP.js";import{M as u,P as v,U as b,g as p,i as c,o as f,qc as w,x as d}from"./chunk-N535F6OD.js";import{a as i,b as l,g}from"./chunk-7QOE2ANW.js";var x=(()=>{class o{constructor(e,t){this.firebaseService=e,this.storeService=t,this.salesSubject=new p([]),this.sales$=this.salesSubject.asObservable(),this.unsubscribe=null,this.defaultSales=[{name:"New Year Sale",month:1,day:1,duration:7,discount:40,isActive:!0,bannerTitle:"\u{1F38A} New Year Sale!",bannerMessage:"Start the year with amazing deals!",bannerIcon:"\u{1F386}"},{name:"Valentine's Special",month:2,day:14,duration:3,discount:25,isActive:!0,bannerTitle:"\u{1F495} Valentine's Special!",bannerMessage:"Share the love with special discounts!",bannerIcon:"\u{1F49D}"},{name:"Summer Sale",month:4,day:15,duration:14,discount:30,isActive:!0,bannerTitle:"\u2600\uFE0F Summer Sale!",bannerMessage:"Hot deals for the summer season!",bannerIcon:"\u{1F334}"},{name:"Mid-Year Blowout",month:6,day:15,duration:7,discount:35,isActive:!0,bannerTitle:"\u{1F525} Mid-Year Blowout!",bannerMessage:"Massive savings on selected items!",bannerIcon:"\u{1F4A5}"},{name:"Back to School Sale",month:8,day:1,duration:14,discount:20,isActive:!0,bannerTitle:"\u{1F4DA} Back to School Sale!",bannerMessage:"Get ready for school with great discounts!",bannerIcon:"\u{1F392}"},{name:"Holiday Season Sale",month:11,day:15,duration:45,discount:50,isActive:!0,bannerTitle:"\u{1F381} Christmas Sale!",bannerMessage:"Celebrate Christmas with 15-70% OFF on selected items!",bannerIcon:"\u{1F384}",holidayKeywords:["lechon","food","party","cake","drink","beverage","wine","ham","fruit","meat","chicken","pork","beef","seafood","fish","dessert","candy","chocolate","gift","decoration","light","ornament","toy","clothing","dress","shirt","shoes","bag","watch","jewelry","electronics","phone","laptop","tablet","appliance","kitchen"],excludeKeywords:["sand","gravel","cement","holloblock","hollow","block","steel","rebar","wire","nail","lumber","wood","plywood","paint","tile","pipe","pvc","fitting","construction","building","hardware"]},{name:"Christmas Special",month:12,day:20,duration:12,discount:50,isActive:!0,bannerTitle:"\u{1F381} Christmas Special!",bannerMessage:"Last chance for holiday savings!",bannerIcon:"\u{1F384}"},{name:"Year-End Clearance",month:12,day:26,duration:6,discount:45,isActive:!0,bannerTitle:"\u{1F38A} Year-End Clearance!",bannerMessage:"Clear out the year with massive discounts!",bannerIcon:"\u{1F389}"}],this.db=this.firebaseService.db,this.storeService.activeStoreId$.subscribe(()=>{this.stopListening(),this.startListening()})}startListening(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null);let e=this.storeService.getActiveStoreId();if(!e){this.salesSubject.next([]);return}let t=y(h(this.db,"sales_events"),I("storeId","==",e),D("month","asc"));this.unsubscribe=M(t,s=>{let a=s.docs.map(n=>i({id:n.id},n.data()));this.salesSubject.next(a),a.length===0&&(console.log("No sales found, seeding defaults..."),this.seedDefaultSales())},s=>{console.error("Error listening to sales:",s),this.salesSubject.value.length===0&&(console.warn("Falling back to default sales data due to error"),this.salesSubject.next(this.defaultSales))})}stopListening(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}getSales(){return this.sales$}getCurrentSalesValue(){return this.salesSubject.value}getCurrentSale(){let e=new Date,t=e.getMonth()+1,s=this.salesSubject.value;for(let a of s){if(!a.isActive)continue;let n=new Date(e.getFullYear(),a.month-1,a.day),r=new Date(n);if(r.setDate(r.getDate()+a.duration),r.setHours(23,59,59,999),a.month===12&&t===1&&(n.setFullYear(e.getFullYear()-1),r.setFullYear(e.getFullYear())),e>=n&&e<=r)return l(i({},a),{endDate:r})}return null}addSale(e){let t=l(i({},e),{createdAt:new Date,updatedAt:new Date,storeId:this.storeService.getActiveStoreId()||void 0});return c(m(h(this.db,"sales_events"),t)).pipe(f(s=>s.id),u(s=>console.log("Sale added with ID:",s)),d(s=>{throw console.error("Error adding sale:",s),s}))}updateSale(e,t){let s=l(i({},t),{updatedAt:new Date});return c(A(S(this.db,"sales_events",e),s)).pipe(u(()=>console.log("Sale updated:",e)),d(a=>{throw console.error("Error updating sale:",a),a}))}deleteSale(e){return c(j(S(this.db,"sales_events",e))).pipe(u(()=>console.log("Sale deleted:",e)),d(t=>{throw console.error("Error deleting sale:",t),t}))}toggleSaleActive(e,t){return this.updateSale(e,{isActive:t})}seedDefaultSales(){return g(this,null,function*(){let e=this.storeService.getActiveStoreId();if(e)for(let t of this.defaultSales)try{yield m(h(this.db,"sales_events"),l(i({},t),{storeId:e,createdAt:new Date,updatedAt:new Date})),console.log("Seeded sale:",t.name)}catch(s){console.error("Error seeding sale:",t.name,s)}})}static{this.\u0275fac=function(t){return new(t||o)(b(k),b(w))}}static{this.\u0275prov=v({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{x as a};
