import{a as U,d as S}from"./chunk-IO3I47CY.js";import{B as w,J as p,O as b,T as j,a as o,b as h,c as u,f as m,j as f,l as d,r as c}from"./chunk-K7VUYT6X.js";var P=(()=>{class a{constructor(t){this.http=t,this.apiUrl=S.apiUrl,this.usersSubject=new f([]),this.users$=this.usersSubject.asObservable(),this.loadUsers()}hashPassword(t){return u(this,null,function*(){let e=new TextEncoder().encode(t),r=yield crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("")})}loadUsers(){this.http.get(`${this.apiUrl}/users`).subscribe({next:t=>{let s=t.map(e=>this.transformUser(e));s.length===0?this.initializeDefaultAdmin():this.usersSubject.next(s)},error:t=>{console.error("Error fetching users:",t),t.status===404&&this.initializeDefaultAdmin()}})}initializeDefaultAdmin(){return u(this,null,function*(){if(this.usersSubject.value.length>0)return;let s={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:yield this.hashPassword("Gr*l0v3R"),role:"admin",createdAt:new Date};this.http.post(`${this.apiUrl}/users`,s).subscribe({next:e=>{let r=this.transformUser(e);this.usersSubject.next([r])},error:e=>{console.warn("Could not save default admin to backend, using local only",e),this.usersSubject.next([s])}})})}getUsers(){return this.users$}addUser(t){let s=h(o({},t),{createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system"});return d(this.hashPassword(t.password||"")).pipe(p(e=>(s.password=e,this.http.post(`${this.apiUrl}/users`,s))),c(e=>{let r=this.transformUser(e),i=this.usersSubject.value;return this.usersSubject.next([...i,r]),r}))}updateUser(t){return new m(s=>{u(this,null,function*(){let r=o({},t);r.password&&(r.password=yield this.hashPassword(r.password)),this.http.put(`${this.apiUrl}/users/${r.id}`,r).subscribe({next:i=>{let n=this.transformUser(i),y=this.usersSubject.value.map(l=>l.id===n.id?n:l);this.usersSubject.next(y),s.next(n),s.complete()},error:i=>s.error(i)})})})}deleteUser(t){return this.http.delete(`${this.apiUrl}/users/${t}`).pipe(c(()=>{let s=this.usersSubject.value;this.usersSubject.next(s.filter(e=>e.id!==t))}))}getUserById(t){return this.usersSubject.value.find(s=>s.id===t)}validateCredentials(t,s){return d(this.hashPassword(s)).pipe(p(e=>this.users$.pipe(w(1),c(r=>r.find(n=>n.username===t&&n.password===e)||null))))}transformUser(t){return h(o({},t),{createdAt:this.parseDate(t.createdAt)})}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):new Date(t):new Date}static{this.\u0275fac=function(s){return new(s||a)(j(U))}}static{this.\u0275prov=b({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{P as a};
