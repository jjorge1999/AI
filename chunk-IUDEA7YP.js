import{$c as D,K as p,Ma as b,P as y,U as I,Xc as v,Yc as j,ad as x,ed as U,fd as w,g,gd as A,hd as C,i as d,j as f,md as R,nd as T,o as h,x as l}from"./chunk-PYKLABYS.js";import{a,b as _}from"./chunk-7QOE2ANW.js";var L=(()=>{class m{get db(){return this.firebaseService.db}setLoginState(t,e){this.loggedInSubject.next(t),this.isLoggedIn.set(t),e?(this._currentUser.set(e),this.currentUserSubject.next(e),localStorage.setItem("jjm_user_id",e.id),localStorage.setItem("jjm_user_role",e.role),e.storeId&&this.storeService.setActiveStore(e.storeId),sessionStorage.setItem("jjm_user_details",JSON.stringify(e)),e.storeId&&sessionStorage.setItem("jjm_store_id",e.storeId)):t||(this._currentUser.set(null),this.currentUserSubject.next(null),localStorage.removeItem("jjm_user_id"),localStorage.removeItem("jjm_user_role"),sessionStorage.removeItem("jjm_user_details"),sessionStorage.removeItem("jjm_store_id"))}constructor(t,e){this.firebaseService=t,this.storeService=e,this._users=b([]),this.users=this._users.asReadonly(),this._currentUser=b(null),this.currentUser=this._currentUser.asReadonly(),this.usersSubject=new g([]),this.users$=this.usersSubject.asObservable(),this.loggedInSubject=new g(localStorage.getItem("jjm_logged_in")==="true"),this.isLoggedIn$=this.loggedInSubject.asObservable(),this.isLoggedIn=b(localStorage.getItem("jjm_logged_in")==="true"),this.currentUserSubject=new g(null),this.currentUser$=this.currentUserSubject.asObservable(),this.hydrateFromCache()}hydrateFromCache(){let t=localStorage.getItem("jjm_cached_users");if(t)try{let e=JSON.parse(t);this._users.set(e),this.usersSubject.next(e),console.log("Hydrated Users from cache");let r=localStorage.getItem("jjm_user_id");if(r){let s=e.find(i=>i.id===r);s&&(this._currentUser.set(s),this.currentUserSubject.next(s),s.storeId&&this.storeService.setActiveStore(s.storeId))}}catch(e){console.warn("Failed to hydrate users from cache",e)}}saveToCache(t){localStorage.setItem("jjm_cached_users",JSON.stringify(t))}hashPassword(t){let r=new TextEncoder().encode(t);return d(crypto.subtle.digest("SHA-256",r)).pipe(h(s=>Array.from(new Uint8Array(s)).map(i=>i.toString(16).padStart(2,"0")).join("")))}loadUsers(t=!1){if(!t&&this._users().length>0){console.log("Users already loaded in Signal. Skipping fetch.");return}let e=localStorage.getItem("jjm_user_id"),r=v(this.db,"users");U(r).then(s=>{let i=s.docs.map(o=>{let c=o.data();return this.transformUser(a({id:o.id},c))});if(i.length===0)this.initializeDefaultAdmin().subscribe();else if(this._users.set(i),this.usersSubject.next(i),this.saveToCache(i),e){let o=i.find(c=>c.id===e);o&&(this._currentUser.set(o),this.currentUserSubject.next(o))}}).catch(s=>{console.error("Error fetching users:",s),this.initializeDefaultAdmin().subscribe()})}initializeDefaultAdmin(){return this.usersSubject.value.length>0?f(void 0):this.hashPassword("Gr*l0v3R").pipe(p(t=>{let e={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:t,role:"admin",createdAt:new Date,hasSubscription:!0},r=j(this.db,"users",e.id);return d(w(r,e)).pipe(h(()=>{let s=this.transformUser(e);this._users.set([s]),this.usersSubject.next([s]),this.saveToCache([s])}),l(s=>(console.warn("Could not save default admin to Firestore, using local only",s),this._users.set([e]),this.usersSubject.next([e]),f(void 0))))}))}getUsers(){return this.users$}addUser(t){let e=crypto.randomUUID(),r=_(a({},t),{id:e,createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system"});return this.hashPassword(t.password||"").pipe(p(s=>{r.password=s;let i=j(this.db,"users",e);return d(w(i,r)).pipe(h(()=>{let o=this.transformUser(r),n=[...this._users(),o];return this._users.set(n),this.usersSubject.next(n),this.saveToCache(n),o}))}),l(s=>{throw console.error("Error adding user:",s),s}))}updateUser(t){let e=a({},t);return Object.keys(e).forEach(s=>{e[s]===void 0&&delete e[s]}),(e.password?this.hashPassword(e.password):f(void 0)).pipe(p(s=>{s&&(e.password=s);let i=j(this.db,"users",e.id);return d(A(i,e)).pipe(h(()=>{let o=this._users(),c=o.find(S=>S.id===e.id),n=this.transformUser(a(a({},c),e)),u=o.map(S=>S.id===n.id?n:S);return this._users.set(u),this.usersSubject.next(u),this.saveToCache(u),n}))}),l(s=>{throw console.error("Error updating user:",s),s}))}deleteUser(t){let e=j(this.db,"users",t);return d(C(e)).pipe(h(()=>{let s=this._users().filter(i=>i.id!==t);this._users.set(s),this.usersSubject.next(s),this.saveToCache(s)}),l(r=>{throw console.error("Error deleting user:",r),r}))}getUserById(t){return this.usersSubject.value.find(e=>e.id===t)}validateCredentials(t,e){return this.hashPassword(e).pipe(p(r=>{let s=v(this.db,"users"),i=D(s,x("username","==",t));return d(U(i)).pipe(h(o=>{if(o.empty)return null;let c=o.docs[0],n=c.data();if(n.password!==r)return null;let u=this.transformUser(a({id:c.id},n));return u.storeId&&this.storeService.setActiveStore(u.storeId),u}),l(o=>(console.error("Login error:",o),f(null))))}))}transformUser(t){let e=_(a({},t),{createdAt:this.parseDate(t.createdAt)});return(e.role==="admin"||e.username==="jjm143256789")&&(e.hasSubscription=!0),e}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):typeof t=="object"&&t.toDate?t.toDate():new Date(t):new Date}static{this.\u0275fac=function(e){return new(e||m)(I(R),I(T))}}static{this.\u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})();export{L as a};
