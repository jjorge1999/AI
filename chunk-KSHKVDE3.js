import{a as j}from"./chunk-YBL43BVC.js";import{a as v,d as x}from"./chunk-IO3I47CY.js";import{O as m,T as f,a as n,b as a,j as g}from"./chunk-K7VUYT6X.js";var A=(()=>{class h{constructor(e,t){this.http=e,this.loggingService=t,this.apiUrl=x.apiUrl,this.productsSubject=new g([]),this.salesSubject=new g([]),this.expensesSubject=new g([]),this.products$=this.productsSubject.asObservable(),this.sales$=this.salesSubject.asObservable(),this.expenses$=this.expensesSubject.asObservable(),this.loadInitialData()}getCurrentUser(){return localStorage.getItem("jjm_user_id")||"guest"}reloadData(){this.loadInitialData()}loadInitialData(){this.fetchProducts(),this.fetchSales(),this.fetchExpenses()}fetchProducts(){let e=this.getCurrentUser(),t=`${this.apiUrl}/products`;e&&e!=="guest"&&(t+=`?userId=${e}`),this.http.get(t).subscribe({next:r=>this.productsSubject.next(r),error:r=>console.error("Error fetching products:",r)})}fetchSales(){let e=this.getCurrentUser();this.http.get(`${this.apiUrl}/sales?userId=${e}`).subscribe({next:t=>{let r=t.map(s=>this.transformSale(s));this.salesSubject.next(r)},error:t=>console.error("Error fetching sales:",t)})}fetchExpenses(){let e=this.getCurrentUser();this.http.get(`${this.apiUrl}/expenses?userId=${e}`).subscribe({next:t=>this.expensesSubject.next(t),error:t=>console.error("Error fetching expenses:",t)})}getProducts(){return this.products$}getSales(){return this.sales$}getExpenses(){return this.expenses$}addExpense(e){let t=a(n({},e),{userId:this.getCurrentUser()});this.http.post(`${this.apiUrl}/expenses`,t).subscribe({next:r=>{let s=this.expensesSubject.value;this.expensesSubject.next([...s,r]),this.loggingService.logActivity("create","expense",r.id,r.productName,`$${r.price.toFixed(2)}`)},error:r=>console.error("Error adding expense:",r)})}addProduct(e){let t=a(n({},e),{userId:this.getCurrentUser()});this.http.post(`${this.apiUrl}/products`,t).subscribe({next:r=>{let s=this.productsSubject.value;this.productsSubject.next([...s,r]),this.loggingService.logActivity("create","product",r.id,r.name)},error:r=>console.error("Error adding product:",r)})}recordSale(e,t,r,s,i,c,o=0,l="amount",S){let d=this.productsSubject.value.find(p=>p.id===e);if(!d)throw new Error("Product not found");if(d.quantity<t)throw new Error("Insufficient quantity");let u=d.price*t;o>0&&(l==="percent"?u=u-u*(o/100):u=u-o),u=Math.max(0,Math.round(u*100)/100);let b=r-u;if(b<0)throw new Error("Insufficient cash");let $={productId:d.id,productName:d.name,category:d.category,price:d.price,quantitySold:t,total:u,cashReceived:r,change:b,deliveryDate:s,deliveryNotes:i,customerId:c,pending:!0,discount:o,discountType:l,userId:this.getCurrentUser(),orderId:S};this.http.post(`${this.apiUrl}/sales`,$).subscribe({next:p=>{let U=this.salesSubject.value;this.salesSubject.next([...U,this.transformSale(p)]),this.loggingService.logActivity("create","sale",p.id,d.name,`Sold ${t} units (Pending Delivery)`)},error:p=>console.error("Error recording sale:",p)})}completePendingSale(e){let t=this.salesSubject.value,r=t.find(s=>s.id===e);if(!r){console.error("Sale not found via ID");return}this.http.put(`${this.apiUrl}/sales/${e}`,{pending:!1}).subscribe({next:()=>{let s=t.map(o=>o.id===e?a(n({},o),{pending:!1}):o);this.salesSubject.next(s);let c=this.productsSubject.value.find(o=>o.id===r.productId);if(c){let o=a(n({},c),{quantity:c.quantity-r.quantitySold});this.updateProduct(o)}this.loggingService.logActivity("complete","sale",e,r.productName,`Marked as delivered & Deducted ${r.quantitySold} units`)},error:s=>console.error("Error completing sale:",s)})}updateSale(e){this.http.put(`${this.apiUrl}/sales/${e.id}`,e).subscribe({next:t=>{let s=this.salesSubject.value.map(i=>i.id===e.id?this.transformSale(t):i);this.salesSubject.next(s),this.loggingService.logActivity("update","sale",e.id,e.productName,"Updated delivery details")},error:t=>console.error("Error updating sale:",t)})}confirmReservation(e){if(!this.productsSubject.value.find(i=>i.id===e.productId)){console.error("Product not found for confirmation stock deduction");return}let s=a(n({},e),{reservationStatus:"confirmed"});this.http.put(`${this.apiUrl}/sales/${e.id}`,s).subscribe({next:i=>{let o=this.salesSubject.value.map(l=>l.id===e.id?this.transformSale(s):l);this.salesSubject.next(o),this.loggingService.logActivity("update","sale",e.id,e.productName,"Confirmed reservation (Stock deduction pending delivery)")},error:i=>console.error("Error confirming reservation:",i)})}transformSale(e){return a(n({},e),{timestamp:this.parseDate(e.timestamp),deliveryDate:e.deliveryDate?this.parseDate(e.deliveryDate):void 0})}parseDate(e){return e?e instanceof Date?e:typeof e=="string"?new Date(e):typeof e=="object"&&e._seconds!==void 0?new Date(e._seconds*1e3):new Date(e):new Date}restockProduct(e,t){let s=this.productsSubject.value.find(i=>i.id===e);if(s){let i=a(n({},s),{quantity:s.quantity+t});this.updateProduct(i),this.loggingService.logActivity("restock","product",e,s.name,`Added ${t} units`)}}deleteSale(e){this.http.delete(`${this.apiUrl}/sales/${e}`).subscribe({next:()=>{let r=this.salesSubject.value.filter(s=>s.id!==e);this.salesSubject.next(r),this.loggingService.logActivity("delete","sale",e,"Reservation/Sale","Deleted sale record")},error:t=>console.error("Error deleting sale:",t)})}updateProduct(e){this.http.put(`${this.apiUrl}/products/${e.id}`,e).subscribe({next:()=>{let r=this.productsSubject.value.map(c=>c.id===e.id?e:c);this.productsSubject.next(r);let s=this.salesSubject.value,i=s.filter(c=>c.productId===e.id&&c.productName!==e.name);if(i.length>0){let c=s.map(o=>o.productId===e.id?a(n({},o),{productName:e.name}):o);this.salesSubject.next(c),i.forEach(o=>{let l=a(n({},o),{productName:e.name});this.http.put(`${this.apiUrl}/sales/${o.id}`,l).subscribe({error:S=>console.error(`Error updating sale ${o.id} name:`,S)})})}this.loggingService.logActivity("update","product",e.id,e.name)},error:t=>console.error("Error updating product:",t)})}clearAllData(){this.productsSubject.next([]),this.salesSubject.next([]),this.expensesSubject.next([])}migrateFromLocalStorage(){let e=localStorage.getItem("jjm_products"),t=localStorage.getItem("jjm_sales"),r=localStorage.getItem("jjm_expenses");e&&JSON.parse(e).forEach(i=>this.addProduct(i)),t&&JSON.parse(t).forEach(i=>{this.http.post(`${this.apiUrl}/sales`,i).subscribe({error:c=>console.error("Error migrating sale:",c)})}),r&&JSON.parse(r).forEach(i=>this.addExpense(i)),console.log("Migration started...")}static{this.\u0275fac=function(t){return new(t||h)(f(v),f(j))}}static{this.\u0275prov=m({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();export{A as a};
