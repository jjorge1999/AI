import{a as S,d as y}from"./chunk-WBOVR5CZ.js";import{H as p,M as j,R as U,c as m,g as f,i as d,j as w,o as u,w as b}from"./chunk-AAFZVE2M.js";import{a,b as h,g as o}from"./chunk-7QOE2ANW.js";var I=(()=>{class n{constructor(t){this.http=t,this.apiUrl=y.apiUrl,this.usersSubject=new f([]),this.users$=this.usersSubject.asObservable()}hashPassword(t){return o(this,null,function*(){let e=new TextEncoder().encode(t),r=yield crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("")})}loadUsers(){this.http.get(`${this.apiUrl}/users`).subscribe({next:t=>{let s=t.map(e=>this.transformUser(e));s.length===0?this.initializeDefaultAdmin():this.usersSubject.next(s)},error:t=>{console.error("Error fetching users:",t),t.status===404&&this.initializeDefaultAdmin()}})}initializeDefaultAdmin(){return o(this,null,function*(){if(this.usersSubject.value.length>0)return;let s={id:"admin-1",username:"jjm143256789",fullName:"System Administrator",password:yield this.hashPassword("Gr*l0v3R"),role:"admin",createdAt:new Date,hasSubscription:!0};this.http.post(`${this.apiUrl}/users`,s).subscribe({next:e=>{let r=this.transformUser(e);this.usersSubject.next([r])},error:e=>{console.warn("Could not save default admin to backend, using local only",e),this.usersSubject.next([s])}})})}getUsers(){return this.users$}addUser(t){let s=h(a({},t),{createdAt:new Date,userId:t.userId||localStorage.getItem("jjm_user_id")||"system"});return d(this.hashPassword(t.password||"")).pipe(p(e=>(s.password=e,this.http.post(`${this.apiUrl}/users`,s))),u(e=>{let r=this.transformUser(e),i=this.usersSubject.value;return this.usersSubject.next([...i,r]),r}))}updateUser(t){return new m(s=>{o(this,null,function*(){let r=a({},t);r.password&&(r.password=yield this.hashPassword(r.password)),this.http.put(`${this.apiUrl}/users/${r.id}`,r).subscribe({next:i=>{let c=this.transformUser(i),g=this.usersSubject.value.map(l=>l.id===c.id?c:l);this.usersSubject.next(g),s.next(c),s.complete()},error:i=>s.error(i)})})})}deleteUser(t){return this.http.delete(`${this.apiUrl}/users/${t}`).pipe(u(()=>{let s=this.usersSubject.value;this.usersSubject.next(s.filter(e=>e.id!==t))}))}getUserById(t){return this.usersSubject.value.find(s=>s.id===t)}validateCredentials(t,s){return d(this.hashPassword(s)).pipe(p(e=>this.http.post(`${this.apiUrl}/login`,{username:t,password:e}).pipe(u(r=>r?this.transformUser(r):null),b(r=>w(null)))))}transformUser(t){let s=h(a({},t),{createdAt:this.parseDate(t.createdAt)});return(s.role==="admin"||s.username==="jjm143256789")&&(s.hasSubscription=!0),s}parseDate(t){return t?t instanceof Date?t:typeof t=="string"?new Date(t):typeof t=="object"&&t._seconds!==void 0?new Date(t._seconds*1e3):new Date(t):new Date}static{this.\u0275fac=function(s){return new(s||n)(U(S))}}static{this.\u0275prov=j({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{I as a};
