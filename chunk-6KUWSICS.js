import{B as y,E as g,La as A,M as p,P as w,U as l,Xc as b,Yc as v,Zc as I,_c as f,cd as C,dd as F,ed as z,fd as R,g as x,i as a,j as _,k as m,kd as B,ld as N,md as T,nc as E,o as h,x as S}from"./chunk-TA5RWKR2.js";import{a as n,b as D}from"./chunk-7QOE2ANW.js";var M=(()=>{class d{get db(){return this.firebaseService.db}constructor(e,t,r,s){this.firebaseService=e,this.storeService=t,this.indexedDbService=r,this.loadingService=s,this._customers=A([]),this.customers=this._customers.asReadonly(),this.customersSubject=new x([]),this.customers$=this.customersSubject.asObservable(),this.hydrateFromCache(),this.storeService.activeStoreId$.subscribe(o=>{o?this.loadCustomers(!0):(this._customers.set([]),this.customersSubject.next([]))})}hydrateFromCache(){this.indexedDbService.get("jjm_cached_customers").pipe(y(1)).subscribe({next:e=>{if(e)try{this._customers.set(e),this.customersSubject.next(e),console.log("Hydrated Customers from IndexedDB")}catch(t){console.warn("Failed to parse cached customers",t)}},error:e=>console.warn("Failed to hydrate customers from IndexedDB",e)})}saveToCache(e){this.indexedDbService.set("jjm_cached_customers",e).pipe(y(1)).subscribe({error:t=>console.error("Failed to save customers to cache",t)})}loadCustomers(e=!1){if(!e&&this._customers().length>0){console.log("Customers already loaded in Signal. Skipping fetch.");return}this.fetchCustomers()}loadInitialData(){this.loadCustomers()}getCurrentUser(){return localStorage.getItem("jjm_user_id")||"guest"}reloadData(){this.loadCustomers(!0)}fetchCustomers(){let e=this.storeService.getActiveStoreId();if(!e){console.log("CustomerService: No storeId, clearing customers."),this._customers.set([]),this.customersSubject.next([]);return}console.log("CustomerService: Fetching customers for storeId:",e);let t=b(this.db,"customers"),r=I(t,f("storeId","==",e));a(C(r)).subscribe({next:s=>{let o=s.docs.map(c=>n({id:c.id},c.data()));this._customers.set(o),this.customersSubject.next(o),this.saveToCache(o)},error:s=>console.error("Error fetching customers:",s)})}getCustomers(){return this.customers$}getCustomerByName(e){let t=this.storeService.getActiveStoreId();if(!t)return _([]);let r=b(this.db,"customers"),s=I(r,f("storeId","==",t));return a(C(s)).pipe(h(o=>o.docs.map(i=>n({id:i.id},i.data())).filter(i=>i.name?.toLowerCase().includes(e.toLowerCase())).map(i=>D(n({},i),{phoneNumber:i.phoneNumber,deliveryAddress:"***",gpsCoordinates:"***",userId:"***"}))))}getCustomerByPhone(e){let t=this.storeService.getActiveStoreId();if(!t)return _([]);let r=b(this.db,"customers"),s=I(r,f("storeId","==",t),f("phoneNumber","==",e));return a(C(s)).pipe(h(o=>o.docs.map(c=>n({id:c.id},c.data()))))}addCustomer(e){let t=this.storeService.getActiveStoreId();if(!t&&!e.storeId)return m(()=>new Error("Store selection required for this transaction."));let r=this.enforceStoreId(t||e.storeId||""),s=crypto.randomUUID(),o=D(n({},e),{id:s,userId:this.getCurrentUser(),storeId:r,createdAt:new Date}),c=this.sanitizeData(o),u=v(this.db,"customers",s);return this.loadingService.show("Adding customer..."),a(F(u,c)).pipe(h(()=>c),p(i=>{let j=[...this._customers(),i];this._customers.set(j),this.customersSubject.next(j),this.saveToCache(j)}),S(i=>(console.error("Error adding customer:",i),m(()=>i))),g(()=>this.loadingService.hide()))}updateCustomer(e,t){let r=this.sanitizeData(n({},t));r.storeId&&(r.storeId=this.enforceStoreId(r.storeId));let s=v(this.db,"customers",e);return this.loadingService.show("Updating customer..."),a(z(s,r)).pipe(h(()=>{let c=this._customers().find(u=>u.id===e);return n(n({},c),t)}),p(o=>{let u=this._customers().map(i=>i.id===e?n(n({},i),t):i);this._customers.set(u),this.customersSubject.next(u),this.saveToCache(u)}),S(o=>(console.error("Error updating customer:",o),m(()=>o))),g(()=>this.loadingService.hide()))}deleteCustomer(e){let t=v(this.db,"customers",e);return this.loadingService.show("Deleting customer..."),a(R(t)).pipe(p(()=>{let s=this._customers().filter(o=>o.id!==e);this._customers.set(s),this.customersSubject.next(s),this.saveToCache(s)}),S(r=>(console.error("Error deleting customer:",r),m(()=>r))),g(()=>this.loadingService.hide()))}getCustomerById(e){return this.customersSubject.value.find(t=>t.id===e)}enforceStoreId(e){let t=localStorage.getItem("jjm_role"),r=localStorage.getItem("jjm_store_id");return t==="super-admin"||!t?e:r||e}sanitizeData(e){if(e===null||typeof e!="object"||e instanceof Date)return e;if(Array.isArray(e))return e.map(r=>this.sanitizeData(r));let t={};return Object.keys(e).forEach(r=>{let s=e[r];s!==void 0&&(t[r]=this.sanitizeData(s))}),t}static{this.\u0275fac=function(t){return new(t||d)(l(B),l(T),l(N),l(E))}}static{this.\u0275prov=w({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();export{M as a};
