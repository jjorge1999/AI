import{P as L,U as f,Xc as d,Zc as b,_c as u,ad as w,cd as p,g as y,gd as x,i as g,j as l,jd as A,kd as B,md as k,o as j,x as D}from"./chunk-BDSATVJ3.js";import{a as h,b as S,g as I}from"./chunk-7QOE2ANW.js";var F=(()=>{class n{get db(){return this.firebaseService.db}constructor(i,t){this.firebaseService=i,this.storeService=t,this.logsSubject=new y([]),this.logs$=this.logsSubject.asObservable(),this.storeService.activeStoreId$.subscribe(r=>{r?this.fetchLogs(r):this.logsSubject.next([])})}getCurrentUserId(){return localStorage.getItem("jjm_user_id")||"guest"}fetchLogs(i){let t=i||this.storeService.getActiveStoreId();if(!t){this.logsSubject.next([]);return}let r=d(this.db,"activityLogs"),a=b(r,u("storeId","==",t),w(200));g(p(a)).subscribe({next:c=>{let o=c.docs.map(e=>{let s=e.data();return S(h({id:e.id},s),{timestamp:s.timestamp?.toDate?s.timestamp.toDate():s.timestamp})}).sort((e,s)=>{let m=e.timestamp instanceof Date?e.timestamp.getTime():0;return(s.timestamp instanceof Date?s.timestamp.getTime():0)-m});this.logsSubject.next(o)},error:c=>{}})}logActivity(i,t,r,a,c){let o=this.storeService.getActiveStoreId();if(!o)return;let e={action:i||"unknown",entityType:t||"unknown",entityId:r||"",entityName:a||"",details:c||"",userId:this.getCurrentUserId()||"system",storeId:o,timestamp:new Date},s=d(this.db,"activityLogs");g(x(s,e)).subscribe({next:m=>{let v=h({id:m.id},e),q=this.logsSubject.value;this.logsSubject.next([v,...q])},error:m=>{}})}getLogs(){return this.logs$}refreshLogs(){this.fetchLogs()}cleanupOldLogs(){let i=this.getCurrentUserId(),t=this.storeService.getActiveStoreId();if(!t)return l({message:"No store selected"});let r=new Date;r.setDate(r.getDate()-30);let a=d(this.db,"activityLogs"),c=b(a,u("storeId","==",t),u("timestamp","<",r));return g(p(c)).pipe(j(o=>I(this,null,function*(){let e=A(this.db);return o.docs.forEach(s=>{e.delete(s.ref)}),yield e.commit(),{deleted:o.docs.length}})),D(o=>(console.error("Error cleaning up logs:",o),l({error:o.message}))))}static{this.\u0275fac=function(t){return new(t||n)(f(B),f(k))}}static{this.\u0275prov=L({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{F as a};
