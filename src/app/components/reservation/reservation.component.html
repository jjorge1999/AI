<div class="relative flex w-full flex-col bg-gray-50 dark:bg-[#101822] text-gray-900 dark:text-white font-display transition-colors duration-200">
    <!-- TopNavBar -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-gray-200 dark:border-gray-700 px-6 lg:px-10 py-4 bg-white dark:bg-[#101822] z-20 sticky top-0 transition-colors duration-200">
        <div class="flex items-center gap-4 text-blue-600 dark:text-[#1269e2]">
            <div class="size-6 text-current">
                <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path clip-rule="evenodd" d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z" fill="currentColor" fill-rule="evenodd"></path>
                </svg>
            </div>
            <h2 class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">JJM Inventory</h2>
        </div>
        <div class="flex flex-1 justify-end gap-8">
            <button (click)="goBack()" class="flex items-center gap-2 group cursor-pointer text-gray-500 dark:text-[#92a9c9] hover:text-blue-600 dark:hover:text-white transition-colors bg-transparent border-none p-0">
                <span class="material-symbols-outlined text-xl">arrow_back</span>
                <span class="text-sm font-medium leading-normal">Back to Login</span>
            </button>
        </div>
    </header>

    <div class="layout-container flex h-full grow flex-col">
        <!-- Store Selection Screen (Only if no store selected) -->
        <div *ngIf="!selectedStoreId" class="flex flex-1 flex-col items-center justify-center py-12 px-6 lg:py-20 animate-fadeIn">
            <div class="max-w-[800px] w-full flex flex-col items-center text-center gap-8">
                <div class="flex flex-col gap-3">
                    <h1 class="text-4xl md:text-5xl font-black text-gray-900 dark:text-white tracking-tight">Welcome to JJM Inventory</h1>
                    <p class="text-lg text-gray-500 dark:text-[#92a9c9]">Please select a branch to view products and make a reservation.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full mt-4">
                    <button *ngFor="let store of (stores$ | async)" 
                         (click)="selectStore(store)"
                         type="button"
                         [attr.aria-label]="'Select ' + store.name"
                         class="group relative flex flex-col gap-5 p-8 bg-white dark:bg-[#1a2432] rounded-3xl border-2 border-transparent hover:border-blue-600 dark:hover:border-[#1269e2] shadow-sm hover:shadow-2xl transition-all duration-500 cursor-pointer overflow-hidden text-left focus:outline-none focus:ring-2 focus:ring-blue-500">
                        
                        <!-- Glow effect on hover -->
                        <div class="absolute -right-12 -top-12 w-32 h-32 bg-blue-600/5 rounded-full blur-3xl group-hover:bg-blue-600/15 transition-all duration-700"></div>
                        
                        <div class="flex items-start gap-5">
                            <div class="w-20 h-20 rounded-2xl bg-blue-50 dark:bg-[#233348] text-blue-600 dark:text-[#1269e2] flex items-center justify-center shrink-0 group-hover:scale-105 transition-all duration-500 overflow-hidden shadow-inner border border-blue-100 dark:border-blue-900/30">
                                <img *ngIf="store.logoUrl" [src]="store.logoUrl" class="w-full h-full object-cover" [alt]="store.name + ' logo'">
                                <span *ngIf="!store.logoUrl" class="material-symbols-outlined text-4xl">storefront</span>
                            </div>
                            <div class="flex flex-col items-start text-left min-w-0">
                                <h3 class="text-2xl font-black text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-[#1269e2] transition-colors line-clamp-1">{{ store.name }}</h3>
                                <div class="flex items-center gap-1.5 text-blue-600 dark:text-blue-400 mt-1">
                                    <span class="material-symbols-outlined text-sm">location_on</span>
                                    <p class="text-sm font-bold truncate">{{ store.address || 'Local Branch' }}</p>
                                </div>
                                <p *ngIf="store.description" class="text-xs text-gray-500 dark:text-[#92a9c9] mt-3 line-clamp-2 leading-relaxed italic">
                                    "{{ store.description }}"
                                </p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-2">
                            <div class="flex items-center gap-2 p-2.5 rounded-xl bg-gray-50 dark:bg-[#233348]/50 border border-gray-100 dark:border-gray-800 transition-colors group-hover:bg-blue-50/50 dark:group-hover:bg-blue-900/10">
                                <span class="material-symbols-outlined text-blue-600/70 text-base">schedule</span>
                                <span class="text-[10px] font-bold text-gray-600 dark:text-[#92a9c9] uppercase tracking-wider">Fast Service</span>
                            </div>
                            <div class="flex items-center gap-2 p-2.5 rounded-xl bg-gray-50 dark:bg-[#233348]/50 border border-gray-100 dark:border-gray-800 transition-colors group-hover:bg-blue-50/50 dark:group-hover:bg-blue-900/10">
                                <span class="material-symbols-outlined text-blue-600/70 text-base">local_shipping</span>
                                <span class="text-[10px] font-bold text-gray-600 dark:text-[#92a9c9] uppercase tracking-wider">Reliable Delivery</span>
                            </div>
                        </div>

                        <div class="mt-2 w-full h-12 bg-gray-100 dark:bg-[#233348] group-hover:bg-blue-600 dark:group-hover:bg-[#1269e2] text-gray-900 dark:text-white group-hover:text-white rounded-xl flex items-center justify-center font-black text-sm uppercase tracking-widest transition-all duration-300 shadow-sm group-hover:shadow-lg">
                            Enter Branch
                        </div>
                    </button>
                </div>

                <div *ngIf="(stores$ | async)?.length === 0" class="flex flex-col items-center gap-4 py-12">
                    <span class="material-symbols-outlined text-6xl text-gray-300">location_off</span>
                    <p class="text-gray-500">No branches currently available.</p>
                </div>
            </div>
        </div>

        <!-- Main Reservation Form (If store selected) -->
        <div *ngIf="selectedStoreId" class="flex flex-1 justify-center py-5 px-4 lg:px-8 animate-fadeIn">
            <div class="layout-content-container flex flex-col max-w-[1200px] flex-1 w-full">


                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Left Column: Form Steps -->
                    <div class="flex-1 flex flex-col gap-8 min-w-0">
                        <!-- Branch Info Bar (Compact) -->
                        <div class="flex items-center justify-between p-3 bg-blue-50/30 dark:bg-[#233348]/20 rounded-xl border border-blue-100/50 dark:border-blue-900/10">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center shrink-0 shadow-sm">
                                    <span class="material-symbols-outlined text-base">location_on</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[9px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest leading-none mb-0.5">Order Location</span>
                                    <span class="text-sm font-bold text-gray-900 dark:text-white">{{ selectedStore?.name }}</span>
                                </div>
                            </div>
                            <button (click)="changeStore()" class="text-xs font-bold text-blue-600 dark:text-[#1269e2] hover:text-blue-700 underline flex items-center gap-1 transition-colors">
                                <span class="material-symbols-outlined text-sm">swap_horiz</span>
                                Change
                            </button>
                        </div>

                        <!-- Page Heading -->
                        <div class="flex flex-col gap-2">
                            <h1 class="text-gray-900 dark:text-white text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em]">New Reservation</h1>
                            <p class="text-gray-500 dark:text-[#92a9c9] text-base font-normal leading-normal">Select items and schedule your pickup in 3 simple steps.</p>
                        </div>
                        
                        <!-- Progress Bar (Step Indicator) -->
                        <div class="flex flex-col gap-3">
                            <div class="flex gap-6 justify-between items-center">
                                <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">Current Progress</p>
                                <span class="text-gray-500 dark:text-[#92a9c9] text-sm bg-gray-200 dark:bg-[#233348] px-2 py-1 rounded">Step {{ currentStep }} of 3</span>
                            </div>
                            <div class="rounded-full bg-gray-200 dark:bg-[#324867] h-2 overflow-hidden">
                                <div class="h-full bg-blue-600 dark:bg-[#1269e2] rounded-full transition-all duration-300" [style.width.%]="progressPercentage"></div>
                            </div>
                        </div>

                        <!-- Sale Banner (Interactive & Mobile Responsive) - Only show when there's an active sale -->
                        <button 
                             *ngIf="currentSale"
                             (click)="scrollToFeaturedDeals()"
                             type="button"
                             aria-label="View featured deals"
                             class="relative overflow-hidden rounded-xl bg-gradient-to-r from-red-500 via-pink-500 to-orange-500 p-4 sm:p-5 shadow-lg animate-pulse-subtle cursor-pointer group hover:shadow-2xl hover:scale-[1.005] sm:hover:scale-[1.01] transition-all duration-300 ring-offset-2 hover:ring-2 ring-red-400 dark:ring-offset-[#101822] w-full text-left focus:outline-none">
                            <!-- Background Shimmer -->
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer opacity-50 group-hover:opacity-100 transition-opacity"></div>
                            
                            <!-- Floating Glow -->
                            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-300/30 rounded-full blur-3xl group-hover:bg-yellow-300/50 transition-colors duration-500"></div>

                            <!-- Content Container -->
                            <div class="relative flex flex-col sm:flex-row items-center justify-between gap-4 sm:gap-0">
                                
                                <!-- Icon & Text -->
                                <div class="flex items-center gap-3 sm:gap-4 w-full sm:w-auto">
                                    <div class="flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-white/20 rounded-full backdrop-blur-md shadow-inner group-hover:scale-110 group-hover:rotate-12 transition-all duration-500 border border-white/20 shrink-0">
                                         <span class="text-2xl sm:text-3xl filter drop-shadow-sm">{{ currentSale.bannerIcon || 'ðŸŽ‰' }}</span>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <h3 class="text-white font-black text-lg sm:text-xl tracking-tight drop-shadow-md group-hover:text-yellow-100 transition-colors truncate">
                                             {{ currentSale.bannerTitle || currentSale.name }}
                                        </h3>
                                        <div class="flex flex-wrap items-center gap-2 mt-0.5">
                                            <span class="bg-white/90 text-red-600 text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm shrink-0">SALE</span>
                                            <p class="text-white/95 text-xs sm:text-sm font-medium group-hover:translate-x-1 transition-transform truncate">
                                                 {{ currentSale.bannerMessage || 'Tap to view exclusive deals!' }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Urgency Countdown -->
                                <div class="w-full sm:w-auto text-center sm:text-right shrink-0 flex flex-col items-center sm:items-end mt-1 sm:mt-0">
                                    <span class="text-white/90 text-[10px] font-bold uppercase tracking-widest mb-1.5 drop-shadow-md">
                                        {{ urgencyText }}
                                    </span>
                                    <div class="flex gap-1.5 justify-center sm:justify-end w-full">
                                        <div *ngFor="let item of [
                                            {val: countdown.days, label: 'DAYS'},
                                            {val: countdown.hours, label: 'HRS'},
                                            {val: countdown.minutes, label: 'MIN'},
                                            {val: countdown.seconds, label: 'SEC'}
                                        ]" 
                                        class="backdrop-blur-md rounded-lg px-1.5 py-1 text-center min-w-[36px] sm:min-w-[38px] shadow-sm border border-white/10 transition-colors duration-300 flex flex-col justify-center"
                                        [ngClass]="{
                                            'bg-red-600/90 text-white animate-pulse ring-2 ring-red-400': urgencyLevel === 'critical',
                                            'bg-orange-500/90 text-white ring-1 ring-orange-300': urgencyLevel === 'warning',
                                            'bg-white/20 text-white hover:bg-white/30': urgencyLevel === 'normal'
                                        }">
                                            <span class="font-bold text-base sm:text-lg leading-none block font-mono">{{ item.val | number:'2.0-0' }}</span>
                                            <span class="text-[7px] sm:text-[8px] opacity-90 font-semibold mt-0.5">{{ item.label }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tap Hint (Desktop Only) -->
                            <div class="hidden sm:block absolute bottom-2 left-1/2 -translate-x-1/2 translate-y-8 group-hover:-translate-y-0 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out">
                                <span class="bg-black/40 text-white text-[10px] uppercase font-bold px-3 py-1 rounded-full backdrop-blur-md border border-white/20 shadow-lg flex items-center gap-1">
                                    View Deals <span class="material-symbols-outlined text-[10px]">arrow_downward</span>
                                </span>
                            </div>
                        </button>

                        <!-- Ads Slider -->
                        <app-ads-slider [storeId]="selectedStoreId"></app-ads-slider>

                        <!-- Featured Deals Table -->
                        <div *ngIf="currentSale && discountedProducts.length > 0" id="featured-deals" class="flex flex-col gap-4 animate-fadeIn scroll-mt-24">
                            <div class="flex items-center justify-between gap-3">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-orange-500 text-xl translate-y-[3px]">local_fire_department</span>
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white leading-tight">Featured Deals</h3>
                                </div>
                                
                                <!-- Sort Dropdown -->
                                <div class="relative flex items-center gap-2">
                                    <span class="text-xs text-gray-500 dark:text-[#92a9c9] hidden sm:inline">Sort by:</span>
                                    <select [(ngModel)]="saleSortBy" (ngModelChange)="setSaleSortBy($event)" class="text-xs sm:text-sm bg-white dark:bg-[#233348] border border-gray-300 dark:border-gray-600 rounded-lg px-2 sm:px-3 py-1.5 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 dark:focus:ring-[#1269e2] focus:border-transparent cursor-pointer transition-all hover:border-blue-500 dark:hover:border-[#1269e2]">
                                        <option value="discount">ðŸ”¥ Best Discount</option>
                                        <option value="price-low">ðŸ’° Lowest Price</option>
                                        <option value="price-high">ðŸ’Ž Highest Price</option>
                                        <option value="stock">âš¡ Low Stock First</option>
                                        <option value="name">ðŸ”¤ A-Z</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="overflow-hidden rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-[#1a2432] shadow-sm">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-gray-50 dark:bg-[#233348] text-gray-500 dark:text-[#92a9c9] border-b border-gray-200 dark:border-gray-700">
                                            <tr>
                                                <th class="px-4 py-3 font-medium">Product</th>
                                                <th class="px-4 py-3 font-medium hidden sm:table-cell">Category</th>
                                                <th class="px-4 py-3 font-medium text-center hidden sm:table-cell">Discount</th>
                                                <th class="px-4 py-3 font-medium text-right">Price</th>
                                                <th class="px-4 py-3 font-medium w-20 text-center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                            <tr *ngFor="let product of paginatedSaleProducts" class="group hover:bg-gray-50 dark:hover:bg-[#233348]/50 transition-colors">
                                                <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">
                                                    <div class="flex items-center gap-3">
                                                        <div class="size-10 rounded-lg bg-gray-100 dark:bg-[#324867] flex items-center justify-center shrink-0 bg-cover bg-center border border-gray-200 dark:border-gray-600" [style.backgroundImage]="product.imageUrl ? 'url(' + product.imageUrl + ')' : ''">
                                                             <span *ngIf="!product.imageUrl" class="material-symbols-outlined text-gray-400 text-sm">inventory_2</span>
                                                        </div>
                                                        <div class="flex flex-col gap-0.5">
                                                            <div class="flex items-center gap-1.5">
                                                                <span class="line-clamp-1 font-semibold">{{ product.name }}</span>
                                                                <!-- Urgency Label for Low Stock -->
                                                                <span *ngIf="isVeryLowStock(product)" class="text-[9px] font-bold px-1.5 py-0.5 rounded-full bg-red-500 text-white uppercase animate-pulse whitespace-nowrap">
                                                                    On-Demand
                                                                </span>
                                                                <span *ngIf="isLowStock(product) && !isVeryLowStock(product)" class="text-[9px] font-bold px-1.5 py-0.5 rounded-full bg-amber-500 text-white uppercase whitespace-nowrap">
                                                                    Limited
                                                                </span>
                                                            </div>
                                                            <span class="text-xs text-orange-500 font-medium sm:hidden">-{{ getProductDiscount(product) }}% OFF</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-gray-500 dark:text-[#92a9c9] hidden sm:table-cell">
                                                    <span class="bg-gray-100 dark:bg-[#233348] px-2 py-1 rounded text-xs">{{ product.category }}</span>
                                                </td>
                                                <td class="px-4 py-3 text-center hidden sm:table-cell">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-400 border border-orange-200 dark:border-orange-800">
                                                        -{{ getProductDiscount(product) }}%
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <div class="flex flex-col items-end">
                                                        <span class="text-sm font-bold text-blue-600 dark:text-[#1269e2]">â‚±{{ getFinalPrice(product) | number }}</span>
                                                        <span class="text-xs text-gray-400 line-through">â‚±{{ getOriginalPrice(product) | number }}</span>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <button (click)="increaseCart(product)" class="size-8 inline-flex items-center justify-center rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                                        <span class="material-symbols-outlined text-sm">add_shopping_cart</span>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div class="flex items-center justify-between px-4 py-3 bg-gray-50/50 dark:bg-[#233348]/30 border-t border-gray-200 dark:border-gray-700" *ngIf="discountedProducts.length > salePageSize">
                                     <span class="text-xs text-gray-500 dark:text-[#92a9c9]">Page {{ salePage }} of {{ saleTotalPages }}</span>
                                     <div class="flex gap-1">
                                         <button [disabled]="salePage === 1" (click)="prevSalePage()" class="size-8 flex items-center justify-center rounded hover:bg-white dark:hover:bg-[#324867] border border-transparent hover:border-gray-200 dark:hover:border-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-gray-500 transition-all">
                                             <span class="material-symbols-outlined text-sm">chevron_left</span>
                                         </button>
                                         <button [disabled]="salePage === saleTotalPages" (click)="nextSalePage()" class="size-8 flex items-center justify-center rounded hover:bg-white dark:hover:bg-[#324867] border border-transparent hover:border-gray-200 dark:hover:border-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-gray-500 transition-all">
                                             <span class="material-symbols-outlined text-sm">chevron_right</span>
                                         </button>
                                     </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 1: Item Selection -->
                        <section class="flex flex-col gap-6 pb-8 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 dark:bg-[#1269e2] text-xs text-white">1</span>
                                    Select Product
                                </h3>
                            </div>
                            
                            <!-- Category Tabs -->
                            <div class="flex gap-2 overflow-x-auto pb-2 -mx-1 px-1">
                                <button 
                                    *ngFor="let cat of categories" 
                                    (click)="selectedCategory = cat"
                                    class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap transition-all"
                                    [ngClass]="{
                                        'bg-blue-600 dark:bg-[#1269e2] text-white shadow-md': selectedCategory === cat,
                                        'bg-gray-100 dark:bg-[#233348] text-gray-600 dark:text-[#92a9c9] hover:bg-gray-200 dark:hover:bg-[#324867]': selectedCategory !== cat
                                    }">
                                    {{ cat }}
                                </button>
                            </div>
                            
                            <!-- Search Bar -->
                            <div class="w-full">
                                <label class="flex flex-col h-12 w-full">
                                    <div class="flex w-full flex-1 items-stretch rounded-lg h-full border border-gray-300 dark:border-gray-600 focus-within:border-blue-600 dark:focus-within:border-[#1269e2]/50 transition-colors bg-white dark:bg-[#233348]">
                                        <div class="text-gray-400 dark:text-[#92a9c9] flex items-center justify-center pl-4">
                                            <span class="material-symbols-outlined">search</span>
                                        </div>
                                        <input [(ngModel)]="searchQuery" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-gray-400 dark:placeholder:text-[#92a9c9] px-4 pl-2 text-base font-normal leading-normal transition-all" placeholder="Search products..." />
                                    </div>
                                </label>
                            </div>
                            <!-- Items List -->
                            <div class="flex flex-col gap-3 max-h-[500px] overflow-y-auto pr-2">
                                <div *ngFor="let product of filteredProducts" class="flex items-center gap-4 bg-white dark:bg-[#1a2432] px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600 hover:border-blue-600 dark:hover:border-[#1269e2]/30 transition-all shadow-sm group">
                                    <div class="bg-center bg-no-repeat bg-cover rounded-lg size-16 shrink-0 relative overflow-hidden bg-gray-100 dark:bg-gray-800">
                                        <img [src]="product.imageUrl || 'assets/placeholder.jpg'" alt="{{product.name}}" class="w-full h-full object-cover" />
                                        <div class="absolute inset-0 bg-black/5 dark:bg-black/10"></div>
                                    </div>
                                    <div class="flex flex-col justify-center flex-1 min-w-0">
                                        <div class="flex justify-between items-start gap-2">
                                            <p class="text-gray-900 dark:text-white text-base font-medium leading-normal line-clamp-1">{{ product.name }}</p>
                                            <div class="flex items-center gap-1.5 shrink-0">
                                                <!-- Very Low Stock - Urgent -->
                                                <span *ngIf="isVeryLowStock(product)" class="text-[10px] font-semibold px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-400/10 text-red-600 dark:text-red-400 animate-pulse">
                                                    Few Left!
                                                </span>
                                                <!-- Low Stock Warning -->
                                                <span *ngIf="isLowStock(product) && !isVeryLowStock(product)" class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-amber-100 dark:bg-amber-400/10 text-amber-600 dark:text-amber-400">
                                                    Selling Fast
                                                </span>
                                                <!-- In Stock Badge -->
                                                <span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-emerald-100 dark:bg-emerald-400/10 text-emerald-600 dark:text-emerald-400">
                                                    Available
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                                            <!-- Sale Price Display (only for holiday items) -->
                                            <ng-container *ngIf="isProductOnSale(product)">
                                                <span class="text-gray-400 dark:text-[#4a5568] text-xs line-through">â‚±{{ getOriginalPrice(product) | number:'1.0-0' }}</span>
                                                <span class="text-red-500 dark:text-red-400 text-sm font-bold">â‚±{{ getFinalPrice(product) | number:'1.2-2' }}</span>
                                                <span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-red-500 text-white uppercase">-{{ getProductDiscount(product) }}%</span>
                                            </ng-container>
                                            <!-- Regular Price Display (non-holiday items or no sale) -->
                                            <span *ngIf="!isProductOnSale(product)" class="text-blue-600 dark:text-[#1269e2] text-sm font-semibold">â‚±{{ getFinalPrice(product) | number:'1.2-2' }}</span>
                                            <span class="text-gray-400 dark:text-[#324867]">â€¢</span>
                                            <span class="text-gray-500 dark:text-[#92a9c9] text-xs">{{ product.category }}</span>
                                        </div>
                                    </div>
                                    <div class="shrink-0 flex items-center gap-2">
                                        <!-- Quick Add Button (when qty is 0) -->
                                        <button *ngIf="getCartQty(product) === 0" (click)="increaseCart(product)" class="h-9 px-4 flex items-center justify-center gap-1.5 rounded-lg bg-blue-600 dark:bg-[#1269e2] text-white text-sm font-medium hover:bg-blue-700 dark:hover:bg-[#1269e2]/80 transition-all opacity-80 group-hover:opacity-100">
                                            <span class="material-symbols-outlined text-sm">add_shopping_cart</span>
                                            <span>Add</span>
                                        </button>
                                        <!-- Quantity Controls (when already in cart) -->
                                        <div *ngIf="getCartQty(product) > 0" class="flex items-center gap-2 bg-gray-100 dark:bg-[#233348] rounded-lg px-1">
                                            <button (click)="decreaseCart(product)" class="size-8 flex items-center justify-center rounded-lg text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-[#324867] transition-colors">
                                                <span class="material-symbols-outlined text-sm">remove</span>
                                            </button>
                                            <span class="text-gray-900 dark:text-white font-semibold w-6 text-center">{{ getCartQty(product) }}</span>
                                            <button (click)="increaseCart(product)" class="size-8 flex items-center justify-center rounded-lg text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-[#324867] transition-colors">
                                                <span class="material-symbols-outlined text-sm">add</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="filteredProducts.length === 0" class="text-center p-4 text-gray-500 dark:text-[#92a9c9]">
                                    No products found.
                                </div>
                            </div>
                        </section>

                        <!-- Step 2: Logistics -->
                        <section class="flex flex-col gap-6 pt-8 border-t border-gray-300 dark:border-gray-700 pb-8 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 dark:bg-[#1269e2] text-xs text-white">2</span>
                                    Schedule Delivery
                                </h3>
                            </div>
                            <div class="flex flex-col gap-6">
                                <!-- Date Inputs -->
                                <div class="flex flex-col gap-6">
                                    <div class="flex gap-4">
                                        <label class="flex flex-col gap-1.5 flex-1">
                                            <span class="text-sm font-medium text-gray-500 dark:text-[#92a9c9]">Delivery Date</span>
                                            <div class="flex items-center bg-white dark:bg-[#233348] rounded-lg px-3 h-12 border border-gray-300 dark:border-gray-600 focus-within:border-blue-600 dark:focus-within:border-[#1269e2]/50 transition-colors">
                                                <span class="material-symbols-outlined text-gray-400 dark:text-[#92a9c9] mr-3">calendar_today</span>
                                                <input [(ngModel)]="pickupDate" (ngModelChange)="onDateChange()" class="bg-transparent border-none text-gray-900 dark:text-white w-full focus:ring-0 p-0 text-sm" type="date" />
                                            </div>
                                        </label>
                                        <label class="flex flex-col gap-1.5 w-36">
                                            <span class="text-sm font-medium text-gray-500 dark:text-[#92a9c9]">Time</span>
                                            <div class="flex items-center bg-white dark:bg-[#233348] rounded-lg px-3 h-12 border border-gray-300 dark:border-gray-600 focus-within:border-blue-600 dark:focus-within:border-[#1269e2]/50 transition-colors">
                                                <span class="material-symbols-outlined text-gray-400 dark:text-[#92a9c9] mr-2">schedule</span>
                                                <input [(ngModel)]="pickupTime" class="bg-transparent border-none text-gray-900 dark:text-white w-full focus:ring-0 p-0 text-sm" type="time" />
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-[#1a2432] rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="text-gray-900 dark:text-white font-medium">{{ calendarDate | date:'MMMM yyyy' }}</span>
                                        <div class="flex gap-1">
                                            <button (click)="changeMonth(-1)" class="p-1 hover:bg-gray-100 dark:hover:bg-[#324867] rounded"><span class="material-symbols-outlined text-sm text-gray-500 dark:text-[#92a9c9]">chevron_left</span></button>
                                            <button (click)="changeMonth(1)" class="p-1 hover:bg-gray-100 dark:hover:bg-[#324867] rounded"><span class="material-symbols-outlined text-sm text-gray-500 dark:text-[#92a9c9]">chevron_right</span></button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2 text-gray-400 dark:text-[#92a9c9]">
                                        <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1 text-center text-sm">
                                        <div *ngFor="let day of calendarDays" 
                                             class="p-1 rounded cursor-default"
                                             [ngClass]="{
                                                'text-gray-300 dark:text-[#324867]': !day.isCurrentMonth,
                                                'text-gray-900 dark:text-white': day.isCurrentMonth && !day.isSelected,
                                                'bg-blue-600 dark:bg-[#1269e2] text-white': day.isSelected
                                             }">
                                             {{ day.day }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Address & Payment -->
                            <div class="flex flex-col gap-6">
                                <label class="flex flex-col gap-1.5 w-full">
                                    <span class="text-sm font-medium text-gray-500 dark:text-[#92a9c9]">Delivery Address</span>
                                    <div class="flex gap-2">
                                        <div class="flex flex-1 items-center bg-white dark:bg-[#233348] rounded-lg px-3 h-12 border border-gray-300 dark:border-gray-600 focus-within:border-blue-600 dark:focus-within:border-[#1269e2]/50 transition-colors">
                                            <span class="material-symbols-outlined text-gray-400 dark:text-[#92a9c9] mr-3">location_on</span>
                                            <input [(ngModel)]="customerAddress" class="bg-transparent border-none text-gray-900 dark:text-white w-full focus:ring-0 p-0 text-sm" placeholder="Enter delivery address" type="text" />
                                        </div>
                                        <button (click)="getLocation()" [disabled]="isLocationLoading" class="h-12 px-4 bg-blue-600 dark:bg-[#1269e2] hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2 transition-colors whitespace-nowrap">
                                            <span *ngIf="isLocationLoading" class="material-symbols-outlined animate-spin text-sm">refresh</span>
                                            <span *ngIf="!isLocationLoading" class="material-symbols-outlined text-sm">my_location</span>
                                            <span class="hidden sm:inline">Use My Location</span>
                                        </button>
                                    </div>
                                </label>

                                <label class="flex flex-col gap-1.5 w-full">
                                    <span class="text-sm font-medium text-gray-500 dark:text-[#92a9c9]">Payment Option (Optional)</span>
                                    <div class="flex items-center bg-white dark:bg-[#233348] rounded-lg px-3 h-12 border border-gray-300 dark:border-gray-600 focus-within:border-blue-600 dark:focus-within:border-[#1269e2]/50 transition-colors">
                                        <span class="material-symbols-outlined text-gray-400 dark:text-[#92a9c9] mr-3">payments</span>
                                        <select [(ngModel)]="paymentOption" class="themed-select bg-white dark:bg-[#233348] border-none text-gray-900 dark:text-white w-full focus:ring-0 p-0 text-sm cursor-pointer">
                                            <option value="" disabled selected class="bg-white dark:bg-[#233348] text-gray-900 dark:text-white">Select Payment Method</option>
                                            <option *ngFor="let opt of paymentOptions" [value]="opt" class="bg-white dark:bg-[#233348] text-gray-900 dark:text-white">{{ opt }}</option>
                                        </select>
                                    </div>
                                </label>
                            </div>
                        </section>
                        <!-- Step 3: Contact Info -->
                        <section class="flex flex-col gap-6">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 dark:bg-[#1269e2] text-xs text-white">3</span>
                                    Your Details
                                </h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="flex flex-col gap-1.5">
                                    <span class="text-sm font-medium text-gray-500 dark:text-[#92a9c9]">Full Name</span>
                                    <input [(ngModel)]="customerName" class="bg-white dark:bg-[#233348] border border-gray-300 dark:border-gray-600 focus:border-blue-600 dark:focus:border-[#1269e2]/50 rounded-lg px-4 h-12 text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-[#92a9c9]/50 focus:ring-0 transition-colors" placeholder="e.g. Jane Doe" type="text"/>
                                </label>
                                <label class="flex flex-col gap-1.5">
                                    <span class="text-sm font-medium text-gray-500 dark:text-[#92a9c9]">Phone Number</span>
                                    <input [(ngModel)]="customerContact" class="bg-white dark:bg-[#233348] border border-gray-300 dark:border-gray-600 focus:border-blue-600 dark:focus:border-[#1269e2]/50 rounded-lg px-4 h-12 text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-[#92a9c9]/50 focus:ring-0 transition-colors" placeholder="+1 (555) 000-0000" type="tel"/>
                                </label>
                            </div>
                        </section>
                    </div>
                    <!-- Placeholder to maintain layout spacing -->
                    <div class="summary-placeholder"></div>
                    <!-- Right Column: Summary Fixed -->
                    <div class="summary-container">
                        <div class="flex flex-col gap-6">
                            <div class="bg-white dark:bg-[#1a2432] border border-gray-200 dark:border-gray-600 rounded-xl p-6 shadow-xl flex flex-col gap-6">
                                <div class="flex justify-between items-center border-b border-dashed remove-top border-gray-200 dark:border-gray-600 pb-4">
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">Summary</h3>
                                    <span class="text-xs font-medium text-gray-500 dark:text-[#92a9c9] bg-gray-100 dark:bg-[#233348] px-2 py-1 rounded">ID: #RES-8921</span>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <div *ngIf="orderItems.length === 0" class="text-sm text-gray-500 dark:text-[#92a9c9] text-center">No items selected</div>
                                    <div *ngFor="let item of orderItems" class="flex justify-between items-start text-sm">
                                        <div class="flex flex-col gap-1">
                                            <span class="text-gray-900 dark:text-white font-medium">{{ item.product.name }}</span>
                                            <span class="text-gray-500 dark:text-[#92a9c9] text-xs">x{{ item.quantity }} Unit</span>
                                        </div>
                                        <span class="text-gray-900 dark:text-white font-medium">â‚±{{ (getFinalPrice(item.product) * item.quantity) | number:'1.2-2' }}</span>
                                    </div>
                                    <div *ngIf="orderItems.length > 0" class="flex justify-between items-start text-sm font-bold pt-2 border-b border-dashed remove-bottom border-gray-200 dark:border-gray-600">
                                        <span class="text-gray-900 dark:text-white">Total</span>
                                        <span class="text-gray-900 dark:text-white">â‚±{{ totalAmount | number:'1.2-2' }}</span>
                                    </div>
                                </div>
                                <div class="border-t border-dashed remove-bottom border-gray-200 dark:border-gray-600 py-4 flex flex-col gap-3">
                                    <div class="flex items-center gap-3">
                                        <span class="material-symbols-outlined text-blue-600 dark:text-[#1269e2] text-xl">event</span>
                                        <div class="flex flex-col">
                                            <span class="text-xs text-gray-500 dark:text-[#92a9c9]">Delivery</span>
                                            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ pickupDate || 'Select Date' }} {{ pickupTime }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-3">
                                    <button (click)="submitReservation()" [disabled]="isSubmitting || orderItems.length === 0" class="w-full h-12 bg-blue-600 dark:bg-[#1269e2] hover:bg-blue-700 dark:hover:bg-[#1269e2]/90 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <span *ngIf="!isSubmitting">Confirm Reservation</span>
                                        <span *ngIf="isSubmitting">Processing...</span>
                                        <span *ngIf="!isSubmitting" class="material-symbols-outlined text-sm">arrow_forward</span>
                                    </button>
                                    <p class="text-xs text-center text-gray-500 dark:text-[#92a9c9]">By confirming, you agree to the product usage policy.</p>
                                </div>
                            </div>
                            <!-- Need Help Card -->
                            <div class="bg-white dark:bg-[#151f2b] border border-gray-200 dark:border-gray-600 rounded-xl p-4 flex items-start gap-3 shadow-sm">
                                <div class="bg-blue-50 dark:bg-[#233348] p-2 rounded-lg text-blue-600 dark:text-[#92a9c9] shrink-0">
                                    <span class="material-symbols-outlined">support_agent</span>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">Need special product?</p>
                                    <a (click)="openChat()" class="text-xs text-blue-600 dark:text-[#1269e2] hover:underline mt-1 inline-block cursor-pointer">Open Chat</a>
                                </div>
                            </div>
                            
                            <!-- Social Proof Section -->
                            <div class="social-proof-section bg-gradient-to-r from-blue-50 to-purple-50 dark:from-[#1a2432] dark:to-[#1e2a3d] rounded-lg p-3 border border-blue-100 dark:border-blue-900/30">
                                <!-- Header with toggle button -->
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-1.5">
                                        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-base">groups</span>
                                        <span class="text-xs font-bold text-gray-900 dark:text-white">Recent Activity</span>
                                        <span class="flex items-center gap-1 text-[10px] text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30 px-1.5 py-0.5 rounded-full">
                                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                                            Live
                                        </span>
                                    </div>
                                    <button 
                                        (click)="activityViewExpanded = !activityViewExpanded"
                                        class="p-1 rounded hover:bg-white/50 dark:hover:bg-[#233348]/50 transition-colors"
                                        [attr.title]="activityViewExpanded ? 'Compact view' : 'Expand view'">
                                        <span class="material-symbols-outlined text-gray-500 dark:text-gray-400 text-sm">
                                            {{ activityViewExpanded ? 'unfold_less' : 'unfold_more' }}
                                        </span>
                                    </button>
                                </div>
                                
                                <!-- Compact Stats (always visible) -->
                                <div class="flex items-center gap-2 text-[10px] mb-2">
                                    <span class="text-blue-600 dark:text-blue-400 font-bold">{{ recentReservationsToday }} today</span>
                                    <span class="text-gray-400">â€¢</span>
                                    <span class="text-purple-600 dark:text-purple-400 font-bold">{{ recentReservationsWeek }} this week</span>
                                </div>
                                
                                <!-- Expanded Stats Grid (only when expanded) -->
                                <div *ngIf="activityViewExpanded" class="grid grid-cols-3 gap-2 mb-3">
                                    <div class="text-center p-2 bg-white/60 dark:bg-[#233348]/60 rounded-lg">
                                        <div class="text-lg font-bold text-blue-600 dark:text-blue-400">{{ recentReservationsToday }}</div>
                                        <div class="text-[9px] text-gray-500 dark:text-gray-400 uppercase tracking-wider">Today</div>
                                    </div>
                                    <div class="text-center p-2 bg-white/60 dark:bg-[#233348]/60 rounded-lg">
                                        <div class="text-lg font-bold text-purple-600 dark:text-purple-400">{{ recentReservationsWeek }}</div>
                                        <div class="text-[9px] text-gray-500 dark:text-gray-400 uppercase tracking-wider">This Week</div>
                                    </div>
                                    <div class="text-center p-2 bg-white/60 dark:bg-[#233348]/60 rounded-lg">
                                        <div class="text-lg font-bold text-orange-600 dark:text-orange-400">{{ busyDatesCount }}</div>
                                        <div class="text-[9px] text-gray-500 dark:text-gray-400 uppercase tracking-wider">Busy Dates</div>
                                    </div>
                                </div>
                                
                                <!-- Recent Activities List -->
                                <div class="space-y-1">
                                    <div *ngFor="let activity of activityViewExpanded ? recentActivities : recentActivities.slice(0, 2)" 
                                         class="flex items-center gap-2 p-1 bg-white/40 dark:bg-[#233348]/40 rounded transition-all duration-300"
                                         [class.animate-slideIn]="activity.isNew">
                                        <div class="w-5 h-5 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-[8px] font-bold shrink-0">
                                            {{ activity.initials }}
                                        </div>
                                        <p class="flex-1 text-[10px] text-gray-700 dark:text-gray-300 truncate">
                                            <span class="font-medium">{{ activity.name }}</span> {{ activity.action }}
                                        </p>
                                        <span class="text-[9px] text-gray-400">{{ activity.time }}</span>
                                    </div>
                                </div>
                                
                                <!-- Busy dates -->
                                <div class="flex items-center gap-1.5 mt-2 pt-2 border-t border-gray-200/50 dark:border-gray-700/50 flex-wrap">
                                    <span class="text-[9px] text-gray-500 dark:text-gray-400 flex items-center gap-0.5">
                                        <span class="material-symbols-outlined text-orange-500 text-[10px]">event_busy</span>
                                        Busy:
                                    </span>
                                    <span *ngFor="let date of activityViewExpanded ? busyDates : busyDates.slice(0, 2)" 
                                          class="text-[9px] px-1.5 py-0.5 rounded-full"
                                          [ngClass]="{
                                              'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': date.level === 'high',
                                              'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': date.level === 'medium',
                                              'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': date.level === 'low'
                                          }">
                                        {{ date.label }}{{ activityViewExpanded ? ' (' + date.count + ')' : '' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
