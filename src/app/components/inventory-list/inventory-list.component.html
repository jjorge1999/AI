<div class="inventory-container">
  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-title-section">
        <h2 class="page-title">Inventory Overview</h2>
        <p class="page-subtitle">Manage your stock, track sales, and monitor deliveries.</p>
      </div>
      <div class="header-search">
        <div class="search-box">
          <span class="material-icon search-icon">search</span>
          <input type="text" placeholder="Search SKU, product, or category..." class="search-input" />
        </div>
      </div>
    </div>
  </header>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-info">
          <span class="stat-label">Total Products</span>
          <span class="stat-value">{{ products.length | number }}</span>
        </div>
        <div class="stat-icon-container blue">
          <span class="material-icon">inventory_2</span>
        </div>
      </div>
      <div class="stat-trend trend-up">
        <span class="material-icon">trending_up</span>
        +{{ availableProducts.length }}
        <span class="trend-label">available items</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-info">
          <span class="stat-label">Low Stock Alerts</span>
          <span class="stat-value">{{ outOfStockProducts.length }}</span>
        </div>
        <div class="stat-icon-container orange">
          <span class="material-icon">warning</span>
        </div>
      </div>
      <div class="stat-trend trend-warning">
        <span class="trend-label">{{ outOfStockProducts.length > 0 ? 'Require attention' : 'All stocked' }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-info">
          <span class="stat-label">Pending Deliveries</span>
          <span class="stat-value">{{ pendingSales.length }}</span>
        </div>
        <div class="stat-icon-container purple">
          <span class="material-icon">local_shipping</span>
        </div>
      </div>
      <div class="stat-trend">
        <span class="trend-label">{{ pendingSales.length > 0 ? 'Awaiting delivery' : 'None pending' }}</span>
      </div>
    </div>
  </div>

  <!-- Available Inventory Table -->
  <div class="table-card">
    <div class="table-header">
      <h3 class="table-title">Available Inventory</h3>
      <div class="table-actions">
        <select class="filter-select" [(ngModel)]="availableProductsPageSize" (change)="onAvailablePageSizeChange()">
          <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }} / page</option>
        </select>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Product Name</th>
            <th>Category</th>
            <th>Stock Level</th>
            <th>Price</th>
            <th>Status</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of paginatedAvailableProducts" class="table-row">
            <td>
              <div class="product-cell">
                <div class="product-image" [style.backgroundImage]="p.imageUrl ? 'url(' + p.imageUrl + ')' : 'none'">
                  <span *ngIf="!p.imageUrl" class="material-icon no-image">inventory_2</span>
                </div>
                <span class="product-name">{{ p.name }}</span>
              </div>
            </td>
            <td>
              <span class="category-badge">{{ p.category }}</span>
            </td>
            <td>
              <div class="stock-level">
                <div class="stock-info">
                  <span class="stock-count" [class.low]="p.quantity < 10">{{ p.quantity }}</span>
                  <span class="stock-max">/ 100</span>
                </div>
                <div class="stock-bar-bg">
                  <div class="stock-bar" [style.width.%]="(p.quantity / 100) * 100" [class.low]="p.quantity < 10"></div>
                </div>
              </div>
            </td>
            <td class="price-cell">₱{{ p.price | number:'1.2-2' }}</td>
            <td>
              <span class="status-badge active" *ngIf="p.quantity > 10">
                <span class="status-dot"></span> In Stock
              </span>
              <span class="status-badge low-stock" *ngIf="p.quantity <= 10 && p.quantity > 0">
                <span class="status-dot"></span> Low Stock
              </span>
            </td>
            <td class="text-right">
              <div class="action-buttons">
                <button class="action-btn" (click)="openEditModal(p)" title="Edit">
                  <span class="material-icon">edit</span>
                </button>
                <button class="action-btn" (click)="onRestock(p)" title="Restock">
                  <span class="material-icon">add_circle</span>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="paginatedAvailableProducts.length === 0">
            <td colspan="6" class="empty-row">
              <div class="empty-state">
                <span class="material-icon">inventory_2</span>
                <p>No available products</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="table-footer" *ngIf="availableProductsTotalPages > 1">
      <p class="page-info">
        Page {{ availableProductsPage }} of {{ availableProductsTotalPages }}
      </p>
      <div class="pagination-controls">
        <button class="pagination-btn" [disabled]="availableProductsPage === 1" (click)="prevAvailablePage()">Previous</button>
        <button class="pagination-btn" [disabled]="availableProductsPage === availableProductsTotalPages" (click)="nextAvailablePage()">Next</button>
      </div>
    </div>
  </div>

  <!-- Bottom Grid: Sales History & Pending Deliveries -->
  <div class="bottom-grid">
    <!-- Sales History -->
    <div class="table-card">
      <div class="table-header">
        <h3 class="table-title">Sales History</h3>
        <select class="filter-select" [(ngModel)]="selectedCategory" (change)="salesPage = 1">
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
      </div>
      <div class="table-wrapper">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>Product</th>
              <th>Customer</th>
              <th>Qty</th>
              <th>Total</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let s of paginatedSales" class="table-row">
              <td>{{ s.productName }}</td>
              <td class="customer-cell">
                <span *ngIf="getCustomerName(s)" class="customer-name">{{ getCustomerName(s) }}</span>
                <span *ngIf="!getCustomerName(s)" class="no-customer">Walk-in</span>
              </td>
              <td>{{ s.quantitySold }}</td>
              <td class="price-cell">₱{{ s.total | number:'1.2-2' }}</td>
              <td class="date-cell">{{ s.timestamp | date:'short' }}</td>
            </tr>
            <tr *ngIf="paginatedSales.length === 0">
              <td colspan="5" class="empty-row">
                <div class="empty-state small">
                  <span class="material-icon">receipt_long</span>
                  <p>No sales yet</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="table-footer" *ngIf="salesTotalPages > 1">
        <p class="page-info">Page {{ salesPage }} of {{ salesTotalPages }}</p>
        <div class="pagination-controls">
          <button class="pagination-btn" [disabled]="salesPage === 1" (click)="prevSalesPage()">Prev</button>
          <button class="pagination-btn" [disabled]="salesPage === salesTotalPages" (click)="nextSalesPage()">Next</button>
        </div>
      </div>
    </div>

    <!-- Pending Deliveries -->
    <div class="table-card">
      <div class="table-header">
        <h3 class="table-title">Pending Deliveries</h3>
        <span class="badge">{{ pendingSales.length }}</span>
      </div>
      <div class="delivery-list">
        <div *ngFor="let group of paginatedPendingSales" class="delivery-item" [class.reservation]="group.reservationStatus === 'pending_confirmation'">
          <div class="delivery-icon">
            <span class="material-icon">{{ group.isGroup ? 'inventory' : 'local_shipping' }}</span>
          </div>
          <div class="delivery-info">
            <div class="delivery-header-row">
              <span class="delivery-name">{{ group.productName }}</span>
              <span class="reservation-badge" *ngIf="group.reservationStatus === 'pending_confirmation'">RESERVATION</span>
            </div>
            
            <div class="delivery-items-preview" *ngIf="group.isGroup">
              <span *ngFor="let s of group.sales; let last = last">
                {{ s.productName }} (x{{ s.quantitySold }}){{ last ? '' : ', ' }}
              </span>
            </div>

            <div class="delivery-meta-row">
              <div class="meta-item" *ngIf="group.customerName">
                <span class="material-icon">person</span> {{ group.customerName }}
              </div>
              <div class="meta-item">
                <span class="material-icon">event</span> {{ group.deliveryDate | date:'MMM d, h:mm a' }}
              </div>
              <div class="meta-item" *ngIf="group.deliveryNotes">
                <span class="material-icon">notes</span> {{ group.deliveryNotes }}
              </div>
              <div class="meta-item price">
                ₱{{ group.total | number:'1.2-2' }}
              </div>
            </div>
          </div>
          
          <div class="delivery-actions">
            <button class="action-btn confirm" *ngIf="group.reservationStatus === 'pending_confirmation'" (click)="confirmReservation(group)" title="Confirm Reservation">
              <span class="material-icon">check_circle</span>
            </button>
            <button class="action-btn deliver" *ngIf="group.reservationStatus !== 'pending_confirmation'" (click)="markAsDelivered(group)" title="Mark as Delivered">
              <span class="material-icon">local_shipping</span>
            </button>
            <button class="action-btn edit" (click)="openEditDeliveryModal(group)" title="Edit">
              <span class="material-icon">edit</span>
            </button>
            <button class="action-btn cancel" (click)="cancelDelivery(group)" title="Cancel">
              <span class="material-icon">cancel</span>
            </button>
          </div>
        </div>
        <div *ngIf="paginatedPendingSales.length === 0" class="empty-state small">
          <span class="material-icon">local_shipping</span>
          <p>No pending deliveries</p>
        </div>
      </div>
      <div class="table-footer" *ngIf="pendingTotalPages > 1">
        <p class="page-info">Page {{ pendingPage }} of {{ pendingTotalPages }}</p>
        <div class="pagination-controls">
          <button class="pagination-btn" [disabled]="pendingPage === 1" (click)="prevPendingPage()">Prev</button>
          <button class="pagination-btn" [disabled]="pendingPage === pendingTotalPages" (click)="nextPendingPage()">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal-overlay" *ngIf="isEditModalOpen" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <span class="material-icon">edit</span>
        Edit Product
      </h3>
      <button class="modal-close" (click)="closeEditModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Product Name</label>
        <input type="text" [(ngModel)]="editProductName" placeholder="Enter product name" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" [(ngModel)]="editProductQuantity" min="0" />
        </div>
        <div class="form-group">
          <label>Price</label>
          <input type="number" [(ngModel)]="editProductPrice" min="0" step="0.01" />
        </div>
      </div>
      <div class="form-group">
        <label>Product Image</label>
        <div class="image-upload">
          <img *ngIf="editImagePreview" [src]="editImagePreview" class="image-preview" />
          <div *ngIf="!editImagePreview" class="image-placeholder">
            <span class="material-icon">add_photo_alternate</span>
          </div>
          <input type="file" accept="image/*" (change)="onEditImageChange($event)" class="file-input" />
        </div>
        <button *ngIf="editImagePreview" class="btn-remove-image" (click)="removeEditImage()">Remove Image</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeEditModal()">Cancel</button>
      <button class="btn-save" (click)="saveProductEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Restock Modal -->
<div class="modal-overlay" *ngIf="isRestockModalOpen" (click)="closeRestockModal()">
  <div class="modal-content restock-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <span class="material-icon">add_circle</span>
        Restock Product
      </h3>
      <button class="modal-close" (click)="closeRestockModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <p class="restock-product-name">{{ restockingProduct?.name }}</p>
      <p class="restock-current">Current stock: <strong>{{ restockingProduct?.quantity }}</strong></p>
      <div class="form-group">
        <label>Quantity to Add</label>
        <input
          type="number"
          [(ngModel)]="restockQuantity"
          min="1"
          placeholder="Enter quantity"
          class="restock-input"
        />
      </div>
      <p class="restock-result" *ngIf="restockQuantity > 0">
        New stock will be: <strong>{{ (restockingProduct?.quantity || 0) + restockQuantity }}</strong>
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeRestockModal()">Cancel</button>
      <button class="btn-save" (click)="confirmRestock()" [disabled]="restockQuantity <= 0">
        <span class="material-icon">add</span>
        Add Stock
      </button>
    </div>
  </div>
</div>

<!-- Edit Delivery Modal -->
<div class="modal-overlay" *ngIf="isEditDeliveryModalOpen" (click)="closeEditDeliveryModal()">
  <div class="modal-content edit-delivery-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <span class="material-icon">edit_calendar</span>
        Edit Delivery
      </h3>
      <button class="modal-close" (click)="closeEditDeliveryModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <p class="edit-delivery-title">{{ editingDeliveryGroup?.productName }}</p>
      <p class="edit-delivery-customer" *ngIf="editingDeliveryGroup?.customerName">
        <span class="material-icon">person</span>
        {{ editingDeliveryGroup?.customerName }}
      </p>
      <div class="form-group">
        <label>Delivery Date</label>
        <input type="date" [(ngModel)]="editDeliveryDate" />
      </div>
      <div class="form-group">
        <label>Delivery Notes</label>
        <textarea [(ngModel)]="editDeliveryNotes" rows="3" placeholder="Add notes..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeEditDeliveryModal()">Cancel</button>
      <button class="btn-save" (click)="saveDeliveryEdit()">
        <span class="material-icon">save</span>
        Save Changes
      </button>
    </div>
  </div>
</div>
