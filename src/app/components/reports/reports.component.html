<div class="reports-container">
  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-title-section">
        <h1 class="page-title">Income vs Expense Analysis</h1>
        <p class="page-subtitle">Track your financial performance and cash flow health over time.</p>
      </div>
      <div class="header-actions">
        <button class="btn-export">
          <span class="material-icon">download</span>
          <span class="btn-text">Export Report</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Date Range Filters -->
  <div class="filter-chips">
    <button
      *ngFor="let range of dateRanges"
      class="filter-chip"
      [class.active]="dateRange === range.value"
      (click)="setDateRange(range.value)"
    >
      {{ range.label }}
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <!-- Income Card -->
    <div class="stat-card">
      <div class="stat-header">
        <p class="stat-label">Total Income</p>
        <span class="stat-icon green">
          <span class="material-icon">trending_up</span>
        </span>
      </div>
      <p class="stat-value">{{ formatCurrency(totalIncome) }}</p>
      <div class="stat-trend positive">
        <span class="material-icon">arrow_upward</span>
        <span class="trend-value">{{ filteredSales.length }} sales</span>
      </div>
    </div>

    <!-- Expense Card -->
    <div class="stat-card">
      <div class="stat-header">
        <p class="stat-label">Total Expenses</p>
        <span class="stat-icon orange">
          <span class="material-icon">trending_down</span>
        </span>
      </div>
      <p class="stat-value">{{ formatCurrency(totalExpenses) }}</p>
      <div class="stat-trend negative">
        <span class="material-icon">arrow_downward</span>
        <span class="trend-value">{{ filteredExpenses.length }} expenses</span>
      </div>
    </div>

    <!-- Cost of Goods Card -->
    <div class="stat-card">
      <div class="stat-header">
        <p class="stat-label">Cost of Goods</p>
        <span class="stat-icon purple">
          <span class="material-icon">shopping_cart</span>
        </span>
      </div>
      <p class="stat-value">{{ formatCurrency(totalCOGS) }}</p>
      <div class="stat-trend neutral">
        <span class="material-icon">info</span>
        <span class="trend-value">Direct unit costs</span>
      </div>
    </div>

    <!-- Net Profit Card -->
    <div class="stat-card profit-card">
      <div class="stat-glow"></div>
      <div class="stat-header">
        <p class="stat-label">Net Profit</p>
        <span class="stat-icon primary">
          <span class="material-icon">account_balance_wallet</span>
        </span>
      </div>
      <p class="stat-value" [class.negative-profit]="netProfit < 0">{{ formatCurrency(netProfit) }}</p>
      <div class="stat-trend" [class.positive]="profitMargin >= 0" [class.negative]="profitMargin < 0">
        <span class="material-icon">{{ profitMargin >= 0 ? 'arrow_upward' : 'arrow_downward' }}</span>
        <span class="trend-value">{{ profitMargin | number:'1.0-0' }}% margin</span>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-grid">
    <!-- Bar Chart -->
    <div class="chart-card chart-main">
      <div class="chart-header">
        <div class="chart-title-section">
          <h3 class="chart-title">Financial Performance</h3>
          <p class="chart-subtitle">Income vs Expense over time</p>
        </div>
        <div class="chart-legend">
          <div class="legend-item">
            <span class="legend-dot income"></span>
            <span>Income</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot expense"></span>
            <span>Expense</span>
          </div>
        </div>
      </div>

      <div class="bar-chart">
        <div class="chart-grid-lines">
          <div class="grid-line"></div>
          <div class="grid-line"></div>
          <div class="grid-line"></div>
          <div class="grid-line"></div>
        </div>
        <div class="bars-container">
          <div class="bar-group" *ngFor="let data of monthlyData">
            <div class="bar-pair">
              <div
                class="bar income-bar"
                [style.height.%]="getBarHeight(data.income)"
                [title]="formatCurrency(data.income)"
              >
                <span class="bar-tooltip">{{ formatCurrency(data.income) }}</span>
              </div>
              <div
                class="bar expense-bar"
                [style.height.%]="getExpenseBarHeight(data.expense)"
                [title]="formatCurrency(data.expense)"
              ></div>
            </div>
            <span class="bar-label">{{ data.month }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Expense Breakdown -->
    <div class="chart-card chart-secondary">
      <h3 class="chart-title">Expense Summary</h3>
      <div class="summary-content">
        <div class="summary-stat">
          <span class="summary-label">Total Expenses</span>
          <span class="summary-value">{{ formatCurrency(totalExpenses) }}</span>
        </div>
        <div class="summary-stat">
          <span class="summary-label">Expense Count</span>
          <span class="summary-value">{{ filteredExpenses.length }}</span>
        </div>
        <div class="summary-stat">
          <span class="summary-label">Avg. Expense</span>
          <span class="summary-value">{{ formatCurrency(filteredExpenses.length > 0 ? totalExpenses / filteredExpenses.length : 0) }}</span>
        </div>
        <div class="profit-indicator">
          <div class="profit-bar-bg">
            <div class="profit-bar income-segment" [style.width.%]="totalIncome > 0 ? 100 : 0"></div>
            <div class="profit-bar expense-segment" [style.width.%]="(totalExpenses / (totalIncome || 1)) * 100"></div>
          </div>
          <div class="profit-labels">
            <span>Income</span>
            <span>Expenses</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="transactions-card">
    <div class="transactions-header">
      <h3 class="chart-title">Recent Transactions</h3>
      <div class="table-search">
        <div class="search-box miniature">
          <span class="material-icon">search</span>
          <input type="text" placeholder="Search..." [(ngModel)]="searchQuery" class="search-input" />
        </div>
      </div>
    </div>
    <div class="transactions-table-wrapper">
      <table class="transactions-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Category</th>
            <th>Type</th>
            <th class="text-right">Amount</th>
            <th class="text-center">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tx of recentTransactions" class="table-row">
            <td class="date-cell">{{ formatDate(tx.date) }}</td>
            <td class="desc-cell">{{ tx.description }}</td>
            <td class="category-cell">{{ tx.category }}</td>
            <td>
              <span class="type-badge" [class.income]="tx.type === 'income'" [class.expense]="tx.type === 'expense'">
                {{ tx.type | titlecase }}
              </span>
            </td>
            <td class="amount-cell" [class.income]="tx.type === 'income'" [class.expense]="tx.type === 'expense'">
              {{ tx.type === 'income' ? '+' : '-' }}{{ formatCurrency(tx.amount) }}
            </td>
            <td class="status-cell">
              <div class="status-actions">
                <span class="status-badge" [class.completed]="tx.status === 'completed'" [class.pending]="tx.status === 'pending'">
                  {{ tx.status | titlecase }}
                </span>
                <button 
                  *ngIf="tx.originalSale" 
                  class="action-btn print-review-btn" 
                  (click)="viewReceipt(tx)" 
                  title="Print Review"
                >
                  <span class="material-icon">receipt_long</span>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="recentTransactions.length === 0">
            <td colspan="6" class="empty-row">
              <div class="empty-state">
                <span class="material-icon">receipt_long</span>
                <p>No transactions found</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Receipt Preview Modal -->
<div class="modal-overlay" *ngIf="isReceiptPreviewOpen" (click)="closeReceiptPreview()">
  <div class="modal-card receipt-preview-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <span class="material-icon">receipt_long</span>
        Receipt Preview
      </h3>
      <button class="modal-close" (click)="closeReceiptPreview()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body receipt-preview-body">
      <div class="receipt-paper" *ngIf="lastReceiptData">
        <!-- Store Header -->
        <div class="receipt-header">
          <h2 class="store-name">{{ lastReceiptData.storeName }}</h2>
          <p class="store-address" *ngIf="lastReceiptData.storeAddress">{{ lastReceiptData.storeAddress }}</p>
          <p class="store-phone" *ngIf="lastReceiptData.storePhone">Tel: {{ lastReceiptData.storePhone }}</p>
        </div>

        <div class="receipt-divider">================================</div>

        <!-- Order Info -->
        <div class="receipt-order-info">
          <p><strong>Order:</strong> {{ lastReceiptData.orderId }}</p>
          <p><strong>Date:</strong> {{ lastReceiptData.date | date:'short' }}</p>
          <p *ngIf="lastReceiptData.customerName"><strong>Customer:</strong> {{ lastReceiptData.customerName }}</p>
          <p *ngIf="lastReceiptData.deliveryDate"><strong>Delivery:</strong> {{ lastReceiptData.deliveryDate | date:'short' }}</p>
        </div>

        <div class="receipt-divider">--------------------------------</div>

        <!-- Items -->
        <div class="receipt-items">
          <div class="receipt-item" *ngFor="let item of lastReceiptData.items" style="margin-bottom: 8px;">
            <div class="item-name" style="font-weight: 500;">{{ item.name }}</div>
            <div class="item-detail" style="display: flex; justify-content: space-between; font-size: 0.9em;">
              <span>{{ item.quantity }} x {{ formatCurrency(item.price) }}</span>
              <span>{{ formatCurrency(item.total) }}</span>
            </div>
            <div class="item-discount" *ngIf="item.discount && item.discount > 0" style="font-size: 0.85em; color: #ef4444; font-style: italic;">
              <span *ngIf="item.discountType === 'percent'">Discount: {{ item.discount }}%</span>
              <span *ngIf="item.discountType === 'amount'">Discount: -{{ formatCurrency(item.discount) }}</span>
            </div>
          </div>
        </div>

        <div class="receipt-divider">--------------------------------</div>

        <!-- Totals -->
        <div class="receipt-totals">
          <div class="total-row" *ngIf="lastReceiptData.totalDiscount > 0" style="display: flex; justify-content: space-between;">
            <span>Total Discount</span>
            <span>-{{ formatCurrency(lastReceiptData.totalDiscount) }}</span>
          </div>
          <div class="total-row grand-total" style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2em; margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px;">
            <span>TOTAL</span>
            <span>{{ formatCurrency(lastReceiptData.total) }}</span>
          </div>
          <div class="total-row" style="display: flex; justify-content: space-between; margin-top: 5px;">
            <span>Cash</span>
            <span>{{ formatCurrency(lastReceiptData.cashReceived) }}</span>
          </div>
          <div class="total-row" style="display: flex; justify-content: space-between;">
            <span>Change</span>
            <span>{{ formatCurrency(lastReceiptData.change) }}</span>
          </div>
        </div>

        <!-- Notes -->
        <div class="receipt-notes" *ngIf="lastReceiptData.notes">
          <div class="receipt-divider">--------------------------------</div>
          <p><strong>Notes:</strong> {{ lastReceiptData.notes }}</p>
        </div>

        <!-- Footer -->
        <div class="receipt-divider">================================</div>
        <div class="receipt-footer" style="text-align: center; font-size: 0.9em;">
          <p>Thank you for your purchase!</p>
          <p>Please come again</p>
        </div>
      </div>
    </div>

    <!-- Modal Actions -->
    <div class="modal-footer receipt-actions">
      <button class="btn-cancel" (click)="closeReceiptPreview()">Close</button>
      <button class="btn-print" (click)="printFromPreview()" [disabled]="isPrinting">
        <span class="material-icon">print</span>
        {{ (printerStatus$ | async) === 'connected' ? 'Print Receipt' : 'Connect & Print' }}
      </button>
    </div>
  </div>
</div>
