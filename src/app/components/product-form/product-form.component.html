<div class="products-page">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title-section">
        <h2 class="page-title">Inventory Overview</h2>
        <p class="page-subtitle">Manage your stock, track sales, and monitor deliveries.</p>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-info">
          <p class="stat-label">Total Products</p>
          <h3 class="stat-value">{{ formatNumber(stats.totalProducts) }}</h3>
        </div>
        <div class="stat-icon-container blue">
          <span class="material-icon">inventory_2</span>
        </div>
      </div>
      <div class="stat-trend trend-up">
        <span class="material-icon">trending_up</span>
        <span class="trend-value">+12%</span>
        <span class="trend-label">vs last month</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-info">
          <p class="stat-label">Low Stock</p>
          <h3 class="stat-value">{{ stats.lowStockCount }}</h3>
        </div>
        <div class="stat-icon-container orange">
          <span class="material-icon">warning</span>
        </div>
      </div>
      <div class="stat-trend trend-warning">
        <span class="material-icon">trending_up</span>
        <span class="trend-value">+{{ stats.lowStockCount > 0 ? stats.lowStockCount : 0 }}</span>
        <span class="trend-label">items need attention</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-info">
          <p class="stat-label">Total Value</p>
          <h3 class="stat-value">{{ formatCurrency(stats.totalValue) }}</h3>
        </div>
        <div class="stat-icon-container green">
          <span class="material-icon">attach_money</span>
        </div>
      </div>
      <div class="stat-trend trend-up">
        <span class="material-icon">trending_up</span>
        <span class="trend-value">+5%</span>
        <span class="trend-label">vs last month</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-info">
          <p class="stat-label">Estimated Profit</p>
          <h3 class="stat-value">{{ formatCurrency(stats.totalPotentialProfit) }}</h3>
        </div>
        <div class="stat-icon-container purple">
          <span class="material-icon">payments</span>
        </div>
      </div>
      <div class="stat-trend trend-up">
        <span class="material-icon">trending_up</span>
        <span class="trend-value">{{ stats.totalValue > 0 ? ((stats.totalPotentialProfit / stats.totalValue) * 100 | number:'1.0-0') : 0 }}%</span>
        <span class="trend-label">avg. margin</span>
      </div>
    </div>
  </div>

  <!-- Filters and Actions -->
  <div class="filters-bar">
    <div class="filters-left">
      <!-- Search (mobile) -->
      <div class="search-container mobile-only">
        <span class="material-icon search-icon">search</span>
        <input
          type="text"
          class="search-input"
          placeholder="Search..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
        />
      </div>
      <!-- Filter buttons -->
      <div class="filter-buttons">
        <select
          class="filter-select"
          [(ngModel)]="categoryFilter"
          (change)="onFilterChange()"
        >
          <option value="">All Categories</option>
          <option *ngFor="let cat of categories" [value]="cat.name">{{ cat.name }}</option>
        </select>
        <button class="manage-cats-btn" (click)="openCategoryModal()" title="Manage Categories">
          <span class="material-icon">settings</span>
        </button>
        <select
          class="filter-select"
          [(ngModel)]="stockFilter"
          (change)="onFilterChange()"
        >
          <option value="">Stock Status</option>
          <option value="in-stock">In Stock</option>
          <option value="low-stock">Low Stock</option>
          <option value="out-of-stock">Out of Stock</option>
        </select>
      </div>
    </div>
    <button class="add-product-btn" (click)="openAddModal()">
      <span class="material-icon">add</span>
      Add Product
    </button>
  </div>

  <!-- Products Table -->
  <div class="table-container">
    <div class="table-wrapper">
      <table class="products-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>SKU</th>
            <th>Category</th>
            <th>Price</th>
            <th>Cost</th>
            <th>Profit</th>
            <th>Stock Level</th>
            <th>Status</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of filteredProducts" class="table-row">
            <td>
              <div class="product-cell">
                <div
                  class="product-image"
                  [style.backgroundImage]="p.imageUrl ? 'url(' + p.imageUrl + ')' : 'none'"
                >
                  <span *ngIf="!p.imageUrl" class="material-icon no-image">inventory_2</span>
                </div>
                <span class="product-name">{{ p.name }}</span>
              </div>
            </td>
            <td class="sku-cell">{{ p.id.slice(0, 8).toUpperCase() }}</td>
            <td>
              <span class="category-badge">{{ p.category }}</span>
            </td>
            <td class="price-cell">{{ formatCurrency(p.price) }}</td>
            <td class="cost-cell">
              <span *ngIf="p.cost">{{ formatCurrency(p.cost) }}</span>
              <span *ngIf="!p.cost" class="no-cost">—</span>
            </td>
            <td class="profit-cell">
              <span *ngIf="p.cost" class="profit-badge" [class.positive]="p.price - p.cost > 0" [class.negative]="p.price - p.cost < 0">
                {{ ((p.price - p.cost) / p.price * 100) | number:'1.0-0' }}%
              </span>
              <span *ngIf="!p.cost" class="no-profit">—</span>
            </td>
            <td>
              <div class="stock-level">
                <div class="stock-info">
                  <span
                    class="stock-count"
                    [class.low]="getStockStatus(p.quantity) === 'low-stock'"
                    [class.out]="getStockStatus(p.quantity) === 'out-of-stock'"
                  >
                    {{ p.quantity }} left
                  </span>
                </div>
                <div class="stock-bar-bg">
                  <div
                    class="stock-bar"
                    [style.width.%]="getStockPercent(p.quantity)"
                    [class.low]="getStockStatus(p.quantity) === 'low-stock'"
                    [class.out]="getStockStatus(p.quantity) === 'out-of-stock'"
                  ></div>
                </div>
              </div>
            </td>
            <td>
              <span
                class="status-badge"
                [class.active]="getStockStatus(p.quantity) === 'active'"
                [class.low-stock]="getStockStatus(p.quantity) === 'low-stock'"
                [class.out-of-stock]="getStockStatus(p.quantity) === 'out-of-stock'"
              >
                <span class="status-dot"></span>
                {{ getStockStatusLabel(p.quantity) }}
              </span>
            </td>
            <td class="text-right">
              <div class="action-buttons">
                <button class="action-btn edit" (click)="openEditModal(p)" title="Edit">
                  <span class="material-icon">edit</span>
                </button>
                <button class="action-btn delete" (click)="deleteProduct(p)" title="Delete">
                  <span class="material-icon">delete</span>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="filteredProducts.length === 0">
            <td colspan="9" class="empty-state">
              <div class="empty-content">
                <span class="material-icon empty-icon">inventory_2</span>
                <p>No products found</p>
                <button class="add-product-btn small" (click)="openAddModal()">
                  <span class="material-icon">add</span>
                  Add Your First Product
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- Pagination -->
    <div class="table-footer">
      <span class="pagination-info">
        Showing {{ showingFrom }} to {{ showingTo }} of {{ formatNumber(products.length) }} results
      </span>
      <div class="pagination-buttons">
        <button
          class="pagination-btn"
          [disabled]="currentPage === 1"
          (click)="prevPage()"
        >
          Previous
        </button>
        <button
          class="pagination-btn"
          [disabled]="currentPage >= totalPages"
          (click)="nextPage()"
        >
          Next
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal-overlay" *ngIf="showAddModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">{{ isEditMode ? 'Edit Product' : 'Add New Product' }}</h3>
      <button class="modal-close" (click)="closeModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <form (ngSubmit)="onSubmit()" class="modal-form">
      <!-- Image Upload -->
      <div class="form-section">
        <label class="form-label">Product Image (Optional)</label>
        <div class="image-preview-container" *ngIf="imagePreview">
          <img [src]="imagePreview" alt="Product preview" class="image-preview" />
          <button type="button" class="remove-image-btn" (click)="removeImage()">
            <span class="material-icon">close</span>
          </button>
        </div>
        <div class="image-upload-area" *ngIf="!imagePreview">
          <input
            type="file"
            id="productImage"
            accept="image/*"
            (change)="onImageChange($event)"
            class="file-input"
          />
          <label for="productImage" class="file-input-label">
            <span class="material-icon upload-icon">cloud_upload</span>
            <span class="upload-text">Click to upload image</span>
            <span class="upload-hint">PNG, JPG up to 10MB</span>
          </label>
        </div>
      </div>

      <!-- Product Name -->
      <div class="form-section">
        <label for="productName" class="form-label">Product Name</label>
        <input
          type="text"
          id="productName"
          [(ngModel)]="product.name"
          name="name"
          placeholder="Enter product name"
          class="form-input"
          required
        />
      </div>



      <!-- Category -->
      <div class="form-section">
        <label for="category" class="form-label">Category</label>
        <select
          id="category"
          [(ngModel)]="product.category"
          name="category"
          class="form-select"
          required
        >
          <option value="">-- Select Category --</option>
          <option *ngFor="let cat of categories" [value]="cat.name">{{ cat.name }}</option>
          <option *ngIf="categories.length === 0" disabled>No categories found. Please add some first.</option>
        </select>
      </div>

      <!-- Pricing -->
      <div class="form-row">
        <div class="form-section">
          <label for="price" class="form-label">Selling Price</label>
          <input
            type="number"
            id="price"
            [(ngModel)]="product.price"
            name="price"
            placeholder="0.00"
            min="0"
            step="0.01"
            class="form-input"
            required
          />
        </div>
        <div class="form-section">
          <label for="cost" class="form-label">Cost / Purchase Price</label>
          <input
            type="number"
            id="cost"
            [(ngModel)]="product.cost"
            name="cost"
            placeholder="0.00"
            min="0"
            step="0.01"
            class="form-input"
          />
          <span class="form-hint">For profit calculation</span>
        </div>
      </div>

      <!-- Recipe / Ingredients -->
      <div class="form-section recipe-section">
        <div class="section-header">
          <label class="form-label">Ingredients / Raw Materials (Recipe)</label>
          <button type="button" class="btn-manage-raw" (click)="openRawMaterialModal()">
            <span class="material-icon">edit_note</span>
            Manage Database
          </button>
        </div>
        
        <div class="flex-between align-center mb-sm">
          <p class="recipe-info mb-0">
            Define the items used to produce this product.
          </p>
          <button 
            type="button" 
            class="btn-ai-sparkle-mini" 
            (click)="assumeIngredients()" 
            [disabled]="isAiLoading"
            title="AI: Auto-pick ingredients from your database"
          >
            <span class="material-icon" [class.rotating]="isAiLoading">{{ isAiLoading ? 'sync' : 'auto_awesome' }}</span>
            {{ isAiLoading ? 'Assuming...' : 'AI Suggest Recipe' }}
          </button>
        </div>
        
        <div class="ingredient-adder">
          <select 
            [(ngModel)]="selectedIngredientId" 
            name="selectedIngredientId" 
            class="form-select ingredient-select"
          >
            <option value="">-- Select Material --</option>
            <option *ngFor="let rm of rawMaterials" [value]="rm.id">
              {{ rm.name }} ({{ formatCurrency(rm.cost || 0) }})
            </option>
          </select>
          <input 
            type="number" 
            [(ngModel)]="ingredientQuantity" 
            name="ingredientQuantity" 
            placeholder="Qty" 
            min="1" 
            class="form-input qty-input"
          />
          <button type="button" class="btn-add-ingredient" (click)="addIngredient()" [disabled]="!selectedIngredientId">
            <span class="material-icon">add</span>
          </button>
        </div>

        <div class="ingredients-list" *ngIf="product.recipe && product.recipe.length > 0">
          <div class="ingredient-item" *ngFor="let item of product.recipe; let i = index">
            <span class="ingredient-name">{{ item.name }}</span>
            <span class="ingredient-qty">x{{ item.quantity }} <small>({{ formatCurrency(item.unitCost) }}/u)</small></span>
            <span class="ingredient-cost">{{ formatCurrency(item.unitCost * item.quantity) }}</span>
            <button type="button" class="btn-remove-ingredient" (click)="removeIngredient(i)">
              <span class="material-icon">delete</span>
            </button>
          </div>
          <div class="recipe-total">
            <span>Total Material Cost:</span>
            <strong>{{ formatCurrency(product.cost) }}</strong>
          </div>
        </div>
        <p class="form-hint" *ngIf="product.recipe && product.recipe.length > 0">
          Cost price is auto-calculated based on ingredients.
        </p>
      </div>

      <!-- Quantity -->
      <div class="form-section">
        <label for="quantity" class="form-label">Initial Quantity</label>
        <input
          type="number"
          id="quantity"
          [(ngModel)]="product.quantity"
          name="quantity"
          placeholder="0"
          min="0"
          class="form-input"
          required
        />
      </div>

      <!-- Submit -->
      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="closeModal()">Cancel</button>
        <button type="submit" [disabled]="!isValid()" class="btn-submit">
          <span class="material-icon">{{ isEditMode ? 'save' : 'add' }}</span>
          {{ isEditMode ? 'Save Changes' : 'Add Product' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Category Management Modal -->
<div class="modal-overlay" *ngIf="showCategoryModal" (click)="closeCategoryModal()">
  <div class="modal-content category-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Manage Categories</h3>
      <button class="modal-close" (click)="closeCategoryModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    
    <div class="category-manager">
      <div class="add-cat-form">
        <input 
          type="text" 
          [(ngModel)]="newCategoryName" 
          placeholder="New category name..." 
          class="form-input"
          (keyup.enter)="addCategory()"
        />
        <button class="btn-add-cat" (click)="addCategory()" [disabled]="!newCategoryName.trim()">
          <span class="material-icon">add</span>
        </button>
      </div>

      <div class="categories-list">
        <div *ngFor="let cat of categories" class="category-item">
          <span class="category-item-name">{{ cat.name }}</span>
          <button class="btn-delete-cat" (click)="deleteCategory(cat)" title="Delete Category">
            <span class="material-icon">delete</span>
          </button>
        </div>
        <div *ngIf="categories.length === 0" class="empty-categories">
          <p>No categories added yet.</p>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-submit full-width" (click)="closeCategoryModal()">Done</button>
    </div>
  </div>
</div>
<!-- Raw Material Management Modal -->
<div class="modal-overlay" *ngIf="showRawMaterialModal" (click)="closeRawMaterialModal()">
  <div class="modal-content category-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Manage Raw Materials</h3>
      <button class="modal-close" (click)="closeRawMaterialModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    
    <div class="category-manager">
      <div class="raw-material-header-actions mb-md">
        <button 
          type="button" 
          class="btn-ai-sparkle" 
          (click)="suggestMaterials()" 
          [disabled]="isAiLoading"
          [title]="'Suggest ingredients for ' + (product.name || 'this product')"
        >
          <span class="material-icon" [class.rotating]="isAiLoading">{{ isAiLoading ? 'sync' : 'auto_awesome' }}</span>
          {{ isAiLoading ? 'AI is Thinking...' : 'AI Suggest Ingredients' }}
        </button>
      </div>

      <div class="raw-material-form-box">
        <div class="raw-reminder-toast">
          <span class="material-icon">info</span>
          <p><strong>Reminder:</strong> Enter costs based on a single piece/unit.</p>
        </div>
        <div class="form-grid-2">
          <div class="form-group">
            <label class="form-label-small">Material Name</label>
            <input 
              type="text" 
              [(ngModel)]="rawMaterialForm.name" 
              placeholder="e.g. Flour" 
              class="form-input"
            />
          </div>
          <div class="form-group">
            <label class="form-label-small">Cost Price (per unit)</label>
            <div class="input-with-button">
              <input type="number" [(ngModel)]="rawMaterialForm.cost" class="form-input" placeholder="0.00" />
              <button class="btn-primary-sq" (click)="saveRawMaterial()" [disabled]="!rawMaterialForm.name">
                <span class="material-icon">{{ editingRawId ? 'save' : 'add' }}</span>
              </button>
              <button *ngIf="editingRawId" class="btn-ghost-sq" (click)="resetRawForm()" title="Cancel Edit">
                <span class="material-icon">close</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="ai-suggestions-container" *ngIf="aiSuggestions.length > 0">
        <label class="form-label-small">AI Suggestions for "{{ product.name }}"</label>
        <div class="suggestions-grid">
          <div *ngFor="let suggestion of aiSuggestions" class="suggestion-chip" (click)="addSuggestedMaterial(suggestion)">
            <span class="suggestion-name">{{ suggestion.name }}</span>
            <span class="suggestion-cost">₱{{ suggestion.cost }}</span>
            <span class="material-icon">add</span>
          </div>
        </div>
        <button class="btn-clear-suggestions" (click)="aiSuggestions = []">Clear Suggestions</button>
      </div>

      <div class="categories-list mt-lg">
        <div *ngFor="let raw of rawMaterialsDb" class="category-item">
          <div class="raw-info">
            <span class="category-item-name">{{ raw.name }}</span>
            <span class="raw-price-info">₱{{ raw.cost | number:'1.2-2' }}/u</span>
          </div>
          <div class="raw-actions">
            <button class="btn-edit-cat" (click)="editRawMaterial(raw)" title="Edit Material">
              <span class="material-icon">edit</span>
            </button>
            <button class="btn-delete-cat" (click)="deleteRawMaterialFromDb(raw.id)" title="Delete Material">
              <span class="material-icon">delete</span>
            </button>
          </div>
        </div>
        <div *ngIf="rawMaterialsDb.length === 0" class="empty-categories">
          <p>No raw materials added yet.</p>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-submit full-width" (click)="closeRawMaterialModal()">Done</button>
    </div>
  </div>
</div>
