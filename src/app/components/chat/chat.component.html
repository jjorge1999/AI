<div class="chat-container">
  <!-- Registration Form -->
  <div *ngIf="!isRegistered" class="registration-container">
    <div class="registration-card">
      <h2>ğŸ“‹ Customer Information</h2>
      <p class="registration-subtitle">Please provide your information to use the chat</p>
      
      <form class="registration-form" (ngSubmit)="registerCustomer()">
        <div class="form-group">
          <label for="customerName">Full Name *</label>
          <input
            type="text"
            id="customerName"
            [(ngModel)]="customerInfo.name"
            name="customerName"
            placeholder="Enter your full name"
            class="form-input"
            required
          />
        </div>

        <div class="form-group">
          <label for="phoneNumber">Phone Number *</label>
          <input
            type="tel"
            id="phoneNumber"
            [(ngModel)]="customerInfo.phoneNumber"
            name="phoneNumber"
            placeholder="e.g., +1 234 567 8900"
            class="form-input"
            required
          />
        </div>

        <div class="form-group">
          <label for="address">Delivery Address *</label>
          <textarea
            id="address"
            [(ngModel)]="customerInfo.address"
            name="address"
            placeholder="Enter your complete delivery address"
            class="form-textarea"
            rows="3"
            required
          ></textarea>
        </div>

        <button type="submit" class="btn-register">
          Start Chat
        </button>
      </form>
    </div>
  </div>

  <!-- Chat Interface (shown after registration) -->
  <div *ngIf="isRegistered" class="chat-wrapper">
    <!-- Sidebar for Admin -->
    <div class="chat-sidebar" *ngIf="isAppUser">
      <div class="sidebar-header">
        Conversations
      </div>
      <div class="conversation-list">
        <div 
          *ngFor="let conv of conversations" 
          class="conversation-item"
          [class.active]="currentConversationId === conv"
          (click)="selectConversation(conv)"
        >
          <span class="conversation-name">{{ conv }}</span>
          <span class="conversation-preview">Click to view chat</span>
        </div>
        <div *ngIf="conversations.length === 0" class="no-messages">
          No conversations yet.
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main-area">
      <div class="chat-header">
        <div class="header-content">
          <h2>ğŸ’¬ {{ isAppUser && currentConversationId ? 'Chat with ' + currentConversationId : 'Customer Support Chat' }}</h2>
          <div class="user-info">
            <span class="user-name">{{ senderName }}</span>
            <button class="btn-edit" (click)="changeInfo()" title="Edit information">
              âœï¸
            </button>
            <button *ngIf="!isAppUser" class="btn-logout" (click)="logout()" title="Logout">
              ğŸšª
            </button>
            <button 
              class="btn-call" 
              (click)="startCall()" 
              title="Start Audio Call"
              [disabled]="isAppUser && !currentConversationId"
            >
              ğŸ“
            </button>
          </div>
        </div>
      </div>

      <!-- Call Overlays -->
      <!-- 1. Incoming Call -->
      <div class="call-overlay incoming" *ngIf="callStatus === 'incoming' && incomingCall">
        <div class="call-content">
          <h3>ğŸ“ Incoming Call</h3>
          <p>{{ incomingCall.callerName }} is calling...</p>
          <div class="call-actions">
            <button class="btn-accept" (click)="acceptCall()">Accept</button>
            <button class="btn-reject" (click)="rejectCall()">Reject</button>
          </div>
        </div>
      </div>

      <!-- 2. Active Call -->
      <div class="call-overlay active" *ngIf="callStatus === 'connected' || callStatus === 'calling'">
        <div class="call-content">
          <div class="call-avatar pulsing">ğŸ‘¤</div>
          <h3>{{ callStatus === 'calling' ? 'Calling...' : 'Connected' }}</h3>
          <p>{{ isAppUser ? currentConversationId : 'Support' }}</p>
          
          <!-- Audio Element for Remote Stream (Visible for debugging/browser policy) -->
          <div style="opacity: 0; height: 0; width: 0; overflow: hidden; position: absolute; pointer-events: none;">
             <audio #remoteAudio [srcObject]="remoteStream" autoplay playsinline controls></audio>
          </div>

          <div class="call-utilities">
            <button class="btn-round" [class.active]="isSpeakerOn" (click)="toggleSpeaker()" title="Toggle Speaker">
              {{ isSpeakerOn ? 'ğŸ”Š' : 'ğŸ”ˆ' }}
            </button>
            <button *ngIf="isAppUser" class="btn-round" [class.active]="isMicMuted" (click)="toggleMic()" title="Toggle Microphone">
              {{ isMicMuted ? 'ğŸ”‡' : 'ğŸ™ï¸' }}
            </button>
          </div>

          <div class="call-actions">
            <button class="btn-end" (click)="endCall()">End Call</button>
          </div>
        </div>
      </div>

      <div class="messages-container" #messagesContainer>
        <div *ngIf="messages.length === 0" class="no-messages">
          {{ isAppUser && !currentConversationId ? 'Select a conversation to start chatting.' : 'No messages yet. Start the conversation!' }}
        </div>

        <div
          *ngFor="let message of messages"
          class="message"
          [class.my-message]="isMyMessage(message)"
          [class.other-message]="!isMyMessage(message)"
        >
          <div class="message-header">
            <span class="sender-name">{{ message.senderName }}</span>
            <span class="message-time">{{ formatTime(message.timestamp) }}</span>
          </div>
          <div class="message-text" *ngIf="message.text">{{ message.text }}</div>
          <div class="message-audio" *ngIf="message.audioBase64">
            <audio controls [src]="message.audioBase64"></audio>
          </div>
          <button *ngIf="isMyMessage(message)" class="btn-delete-msg" (click)="deleteMessage(message)" title="Delete message">
            ğŸ—‘ï¸
          </button>
        </div>
      </div>

      <div class="input-container">
        <input
          type="text"
          [(ngModel)]="newMessage"
          (keyup.enter)="sendMessage()"
          placeholder="Type a message..."
          class="message-input"
          [disabled]="isAppUser && !currentConversationId"
        />
        <button
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || (isAppUser && !currentConversationId)"
          class="btn-send"
        >
          Send
        </button>
        <button
          class="btn-mic"
          [class.recording]="isRecording"
          (mousedown)="startRecording($event)"
          (mouseup)="stopRecording($event)"
          (mouseleave)="stopRecording($event)"
          (touchstart)="startRecording($event)"
          (touchend)="stopRecording($event)"
          title="Hold to talk"
          [disabled]="isAppUser && !currentConversationId"
        >
          {{ isRecording ? 'ğŸ”´' : 'ğŸ™ï¸' }}
        </button>
      </div>
    </div>
  </div>
</div>
