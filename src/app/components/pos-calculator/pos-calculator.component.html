<div class="card">
  <h3>Point of Sale</h3>

  <div class="pos-layout">
    <!-- Selection Panel -->
    <div class="selection-panel">
      <!-- Row 1: Customer Context -->
      <div class="form-row full-width">
        <div class="form-group">
          <label for="customer">Select Customer</label>
          <select id="customer" [(ngModel)]="selectedCustomerId">
            <option value="">-- Walk-in Customer --</option>
            <option *ngFor="let customer of customers" [value]="customer.id">
              {{ customer.name }}
            </option>
          </select>
        </div>
      </div>

      <!-- Row 2: Product Action Line -->
      <div class="multi-item-row">
        <!-- Product -->
        <div class="form-group product-select-group">
          <label for="product">Select Product</label>
          <select id="product" [(ngModel)]="selectedProductId" (change)="onProductChange()">
            <option value="">-- Choose a product --</option>
            <option *ngFor="let product of products" [value]="product.id">
              {{ product.name }} - ‚Ç±{{ product.price | number:'1.2-2' }} (Stock: {{ product.quantity }})
            </option>
          </select>
        </div>

        <!-- Quantity -->
        <div class="form-group tiny-width">
          <label for="qty">Qty</label>
          <input type="number" id="qty" [(ngModel)]="quantity" [min]="1" [max]="maxQuantity" />
        </div>

        <!-- Discount -->
        <div class="form-group">
          <label>Discount</label>
          <div class="discount-row">
            <input type="number" [(ngModel)]="discount" placeholder="0" class="small-input">
            <select [(ngModel)]="discountType" class="small-select">
              <option value="amount">‚Ç±</option>
              <option value="percent">%</option>
            </select>
          </div>
        </div>

        <!-- Add Button -->
        <div class="form-group">
           <button class="btn-primary btn-add" (click)="addToCart()" [disabled]="!selectedProductId">
             ‚ûï Add
           </button>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-message" *ngIf="errorMessage">‚ö†Ô∏è {{ errorMessage }}</div>

    <!-- Cart Display -->
    <div class="cart-container">
      <table class="cart-table">
        <thead>
          <tr>
            <th>Product</th>
            <th class="text-right">Price</th>
            <th class="text-center">Qty</th>
            <th class="text-right">Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of cart; let i = index">
            <td>
               <div class="cart-prod-name">{{ item.product.name }}</div>
               <div class="cart-prod-disc" *ngIf="item.discount > 0">
                 Disc: -{{ item.discountType === 'percent' ? item.discount + '%' : '‚Ç±' + item.discount }}
               </div>
            </td>
            <td class="text-right">‚Ç±{{ item.product.price | number:'1.2-2' }}</td>
            <td class="text-center">{{ item.quantity }}</td>
            <td class="text-right font-bold">‚Ç±{{ item.total | number:'1.2-2' }}</td>
            <td class="text-center">
              <button class="btn-remove-sm" (click)="removeFromCart(i)" title="Remove">‚úï</button>
            </td>
          </tr>
          <tr *ngIf="cart.length === 0">
             <td colspan="5" class="empty-cart-cell">Cart is empty. Add items above.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Checkout Panel -->
    <div class="checkout-panel" *ngIf="cart.length > 0">
      <div class="delivery-card">
         <h4>üöö Delivery Options</h4>
         <div class="form-row">
           <div class="form-group">
             <label>Date</label>
             <input type="date" [(ngModel)]="deliveryDate" [min]="minDate">
           </div>
           <div class="form-group">
             <label>Time</label>
             <input type="time" [(ngModel)]="deliveryTime">
           </div>
         </div>
         <div class="form-group">
           <textarea [(ngModel)]="deliveryNotes" placeholder="Delivery notes..." rows="2"></textarea>
         </div>
      </div>

      <div class="payment-card">
         <h4>üí∞ Payment</h4>
         <div class="summary-line total-line">
           <span>Total Due:</span>
           <span>‚Ç±{{ total | number:'1.2-2' }}</span>
         </div>
         
         <div class="form-group cash-group">
           <label>Cash Received (‚Ç±)</label>
           <!-- Formatting: Type text to handle raw/formatted switch -->
           <input 
             type="text" 
             [ngModel]="cashDisplayValue"
             (ngModelChange)="onCashInput($event)"
             (blur)="formatCashOnBlur()"
             (focus)="unformatCashOnFocus()"
             class="cash-input" 
             placeholder="0.00"
           >
         </div>
         
         <div class="summary-line change-line" [class.negative]="change < 0">
           <span>Change:</span>
           <span>‚Ç±{{ change | number:'1.2-2' }}</span>
         </div>

         <button class="btn-checkout" (click)="checkout()" [disabled]="!isValid()">
           Complete Order
         </button>
      </div>
    </div>
  </div>
</div>

<!-- Pending Deliveries -->
<div class="card pending-deliveries">
  <h3>üöö Pending Deliveries</h3>
  <div class="filter-row">
    <div class="filter-group">
      <label for="deliveryFilter">Date:</label>
      <input type="date" id="deliveryFilter" [(ngModel)]="deliveryFilterDate" name="deliveryFilter" />
      <button class="btn-clear" (click)="deliveryFilterDate = ''" *ngIf="deliveryFilterDate" title="Clear Date">‚ùå</button>
    </div>
    
    <div class="filter-group">
       <label for="statusFilter">Show:</label>
       <select id="statusFilter" [(ngModel)]="statusFilter" class="status-select">
         <option value="all">All Deliveries</option>
         <option value="reservation">‚ö†Ô∏è Reservations</option>
       </select>
    </div>
  </div>
  <div class="pending-list">
    <div class="pending-item" *ngFor="let group of paginatedGroupedPendingSales">
      <div class="pending-details">
        <div class="pending-header">
           <div class="header-left">
              <span class="product-name" *ngIf="!group.isGroup">{{ group.sales[0].productName }}</span>
              <span class="product-name" *ngIf="group.isGroup">Order #{{ group.orderId | slice:4:12 }}... ({{ group.sales.length }} items)</span>
           </div>
          <span class="status-badge warning" *ngIf="group.status === 'pending_confirmation'">‚ö†Ô∏è RESERVATION</span>
          <span class="status-badge success" *ngIf="group.status === 'confirmed'">‚úÖ CONFIRMED</span>
          <span class="sale-date">{{ group.timestamp | date : 'short' }}</span>
        </div>

        <div class="multi-item-list" *ngIf="group.isGroup">
            <div *ngFor="let s of group.sales" class="sub-item">
               ‚Ä¢ {{ s.productName }} <span class="sub-qty">(x{{ s.quantitySold }})</span>
            </div>
        </div>
        
        <div class="pending-info">
          <span *ngIf="!group.isGroup">Qty: {{ group.quantityTotal }}</span>
          <span *ngIf="group.isGroup">Total Qty: {{ group.quantityTotal }}</span>
          <span class="total-price">Due: ‚Ç±{{ group.total | number:'1.2-2' }}</span>
        </div>

        <div class="customer-details" *ngIf="group.customer">
          <div class="customer-header">üë§ Customer Details</div>
          <div class="customer-row"><span class="customer-label">Name:</span> <span class="customer-value">{{ group.customer.name }}</span></div>
          <div class="customer-row"><span class="customer-label">Phone:</span> <span class="customer-value">{{ group.customer.phoneNumber }}</span></div>
          <div class="customer-row"><span class="customer-label">Address:</span> <span class="customer-value">{{ group.customer.deliveryAddress }}</span></div>
        </div>
        
        <div class="delivery-info" *ngIf="group.deliveryDate">
          <span>üìÖ Due: {{ group.deliveryDate | date : 'mediumDate' }}</span>
          <span>üìÖ Time: {{ group.deliveryDate | date : 'shortTime' }}</span>
          <span *ngIf="group.deliveryNotes">üìù {{ group.deliveryNotes }}</span>
        </div>
      </div>
      
      <div class="pending-actions">
        <button class="btn-edit" (click)="openEditModal(group.sales[0])">‚úèÔ∏è Edit</button>
        
        <button 
          *ngIf="group.status === 'pending_confirmation'" 
          class="btn-confirm" 
          (click)="confirmGroupReservation(group.sales)"
          title="Confirm Reservation"
        >
          üìù Confirm
        </button>

        <button 
          class="btn-delete" 
          (click)="cancelGroupOrder(group.sales)"
          title="Cancel Order"
        >
          üóëÔ∏è Cancel
        </button>

        <button 
          *ngIf="group.status !== 'pending_confirmation'"
          class="btn-deliver" 
          (click)="markGroupAsDelivered(group.sales)"
        >
          üöö Mark Delivered
        </button>
      </div>
    </div>
  </div>

  <!-- Pagination Controls for Pending Deliveries -->
  <div class="pagination" *ngIf="pendingTotalPages > 1 || groupedPendingSales.length > 5">
    <div class="pagination-size">
      <label for="pendingPageSize">Show:</label>
      <select 
        id="pendingPageSize"
        [(ngModel)]="pendingPageSize"
        (change)="pendingPage = 1"
        class="page-size-select"
      >
        <option *ngFor="let size of pendingPageSizeOptions" [value]="size">{{ size }}</option>
      </select>
      <span>per page</span>
    </div>

    <div class="pagination-controls" *ngIf="pendingTotalPages > 1">
      <button 
        class="pagination-btn" 
        [disabled]="pendingPage === 1"
        (click)="prevPendingPage()"
      >
        ‚Üê Prev
      </button>
      
      <div class="pagination-pages">
        <button 
          *ngFor="let page of getPendingPageNumbers()"
          class="pagination-page"
          [class.active]="page === pendingPage"
          (click)="goToPendingPage(page)"
        >
          {{ page }}
        </button>
      </div>

      <button 
        class="pagination-btn" 
        [disabled]="pendingPage === pendingTotalPages"
        (click)="nextPendingPage()"
      >
        Next ‚Üí
      </button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" *ngIf="isEditModalOpen" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Edit Delivery Details</h3>
      <button class="close-btn" (click)="closeEditModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="editDate">Delivery Date</label>
        <input type="date" id="editDate" [(ngModel)]="editDeliveryDate" [min]="minDate" class="date-input" />
      </div>
      <div class="form-group">
        <label for="editTime">Delivery Time</label>
        <input type="time" id="editTime" [(ngModel)]="editDeliveryTime" class="time-input" />
      </div>
      <div class="form-group">
        <label for="editNotes">Notes</label>
        <textarea id="editNotes" [(ngModel)]="editDeliveryNotes" rows="3" class="textarea-input"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeEditModal()">Cancel</button>
      <button class="btn-save" (click)="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>
