<div class="pos-container">
  <!-- LEFT COLUMN: Products -->
  <main class="products-panel">
    <!-- Category Filter Rail -->
    <div class="category-rail">
      <button
        class="category-btn"
        [class.active]="!categoryFilter"
        (click)="categoryFilter = ''"
      >
        <span class="material-icon">star</span>
        <span class="category-label">All Items</span>
      </button>
      <button
        *ngFor="let cat of categories"
        class="category-btn"
        [class.active]="categoryFilter === cat"
        (click)="categoryFilter = cat"
      >
        <span class="material-icon">{{ getCategoryIcon(cat) }}</span>
        <span class="category-label">{{ cat }}</span>
      </button>
    </div>

    <!-- Product Grid -->
    <div class="product-grid-wrapper">
      <div class="product-grid">
        <div
          *ngFor="let product of filteredProducts"
          class="product-card"
          [class.in-cart]="isInCart(product.id)"
          (click)="addProductToCart(product)"
        >
          <div
            class="product-image"
            [style.backgroundImage]="product.imageUrl ? 'url(' + product.imageUrl + ')' : 'none'"
          >
            <span *ngIf="!product.imageUrl" class="material-icon no-image">inventory_2</span>
            <span class="cart-indicator" *ngIf="isInCart(product.id)">
              {{ getCartQuantity(product.id) }}
            </span>
          </div>
          <div class="product-info">
            <p class="product-name">{{ product.name }}</p>
            <div class="product-meta">
              <span class="product-price">{{ formatCurrency(product.price) }}</span>
              <span class="product-stock">Qty: {{ product.quantity }}</span>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="filteredProducts.length === 0" class="empty-products">
          <span class="material-icon">search_off</span>
          <p>No products available</p>
        </div>
      </div>
    </div>
  </main>

  <!-- RIGHT COLUMN: Cart Panel -->
  <aside class="cart-panel">
    <!-- Cart Header -->
    <div class="cart-header">
      <div class="order-info">
        <h3 class="order-title">Order #{{ orderNumber }}</h3>
        <p class="order-meta">{{ currentDate | date:'shortDate' }} • {{ currentTime }}</p>
      </div>
      <button class="clear-btn" (click)="clearCart()" *ngIf="cart.length > 0">Clear</button>
    </div>

    <!-- Customer Select -->
    <div class="customer-select-wrapper">
      <select [(ngModel)]="selectedCustomerId" class="customer-select">
        <option value="">-- Walk-in Customer --</option>
        <option *ngFor="let customer of customers" [value]="customer.id">
          {{ customer.name }}
        </option>
      </select>
    </div>

    <!-- Cart Items List -->
    <div class="cart-items">
      <div
        *ngFor="let item of cart; let i = index"
        class="cart-item"
      >
        <div
          class="cart-item-image"
          [style.backgroundImage]="item.product.imageUrl ? 'url(' + item.product.imageUrl + ')' : 'none'"
        >
          <span *ngIf="!item.product.imageUrl" class="material-icon">inventory_2</span>
        </div>
        <div class="cart-item-details">
          <div class="cart-item-row">
            <span class="cart-item-name">{{ item.product.name }}</span>
            <span class="cart-item-total">{{ formatCurrency(item.total) }}</span>
          </div>
          <div class="cart-item-row">
            <span class="cart-item-price" *ngIf="item.discount === 0">
              {{ formatCurrency(item.product.price) }} each
            </span>
            <span class="cart-item-price discount-applied" *ngIf="item.discount > 0">
              {{ item.discountType === 'percent' ? item.discount + '%' : formatCurrency(item.discount) }} off
            </span>
            <!-- Quantity Controls -->
            <div class="qty-controls">
              <button class="qty-btn" (click)="decrementItem(i)">
                <span class="material-icon">remove</span>
              </button>
              <button class="qty-value-btn" (click)="openQuantityModal(i)" title="Click to enter quantity">
                {{ item.quantity }}
              </button>
              <button class="qty-btn" (click)="incrementItem(i)" [disabled]="item.quantity >= item.product.quantity">
                <span class="material-icon">add</span>
              </button>
            </div>
          </div>
        </div>
        <button class="remove-item-btn" (click)="removeFromCart(i)" title="Remove">
          <span class="material-icon">close</span>
        </button>
      </div>

      <!-- Empty Cart -->
      <div *ngIf="cart.length === 0" class="empty-cart">
        <span class="material-icon">shopping_cart</span>
        <p>Cart is empty</p>
        <span class="hint">Tap products to add them</span>
      </div>
    </div>

    <!-- Bottom Section: Totals & Actions -->
    <div class="cart-footer">
      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="action-btn" (click)="openDiscountModal()">
          <span class="material-icon">percent</span>
          <span class="action-label">Discount</span>
        </button>
        <button class="action-btn" (click)="openDeliveryModal()">
          <span class="material-icon">local_shipping</span>
          <span class="action-label">Delivery</span>
        </button>
        <button class="action-btn" (click)="openNotesModal()">
          <span class="material-icon">edit_note</span>
          <span class="action-label">Notes</span>
        </button>
        <button class="action-btn" (click)="togglePendingPanel()">
          <span class="material-icon">schedule</span>
          <span class="action-label">Pending</span>
          <span class="pending-badge" *ngIf="pendingSales.length > 0">{{ pendingSales.length }}</span>
        </button>
      </div>

      <!-- Delivery Info (if set) -->
      <div class="delivery-summary" *ngIf="deliveryDate">
        <span class="material-icon">local_shipping</span>
        <span>{{ deliveryDate | date:'shortDate' }} {{ deliveryTime ? 'at ' + deliveryTime : '' }}</span>
        <button class="clear-delivery" (click)="clearDelivery()">✕</button>
      </div>

      <!-- Summary -->
      <div class="order-summary">
        <div class="summary-row">
          <span>Subtotal</span>
          <span>{{ formatCurrency(total) }}</span>
        </div>
        <div class="summary-row total-row">
          <span>Total</span>
          <span class="total-amount">{{ formatCurrency(total) }}</span>
        </div>
      </div>

      <!-- Payment Input -->
      <div class="payment-section" *ngIf="cart.length > 0">
        <div class="cash-input-wrapper">
          <label>Cash Received</label>
          <div class="cash-input-row">
            <span class="currency-symbol">₱</span>
            <input
              type="text"
              [ngModel]="cashDisplayValue"
              (ngModelChange)="onCashInput($event)"
              (blur)="formatCashOnBlur()"
              (focus)="unformatCashOnFocus()"
              placeholder="0.00"
              class="cash-input"
            />
          </div>
        </div>
        <div class="change-display" [class.negative]="change < 0">
          <span>Change</span>
          <span class="change-amount">{{ formatCurrency(change) }}</span>
        </div>
      </div>

      <!-- Main Action Buttons -->
      <div class="main-actions">
        <button
          class="charge-btn"
          [disabled]="!isValid()"
          (click)="checkout()"
        >
          <span>CHARGE {{ formatCurrency(total) }}</span>
          <span class="material-icon">arrow_forward</span>
        </button>
      </div>

      <!-- Error Message -->
      <div class="error-banner" *ngIf="errorMessage">
        <span class="material-icon">warning</span>
        {{ errorMessage }}
      </div>
    </div>
  </aside>
</div>

<!-- Pending Deliveries Slide Panel -->
<div class="pending-overlay" [class.open]="isPendingPanelOpen" (click)="closePendingPanel()">
  <div class="pending-panel" [class.open]="isPendingPanelOpen" (click)="$event.stopPropagation()">
    <div class="pending-header">
      <h3>
        <span class="material-icon">schedule</span>
        Pending Deliveries
      </h3>
      <button class="close-pending-btn" (click)="closePendingPanel()">
        <span class="material-icon">close</span>
      </button>
    </div>

    <!-- Filters -->
    <div class="pending-filters">
      <input
        type="date"
        [(ngModel)]="deliveryFilterDate"
        (ngModelChange)="updateGroupedSales()"
        class="filter-input"
        placeholder="Filter by date"
      />
      <select
        [(ngModel)]="statusFilter"
        (ngModelChange)="updateGroupedSales()"
        class="filter-select"
      >
        <option value="all">All Deliveries</option>
        <option value="reservation">Reservations Only</option>
      </select>
      <button
        class="clear-filter-btn"
        *ngIf="deliveryFilterDate || statusFilter !== 'all'"
        (click)="clearFilter()"
      >
        <span class="material-icon">clear</span>
      </button>
    </div>

    <!-- Pending List -->
    <div class="pending-list">
      <div
        *ngFor="let group of paginatedGroupedPendingSales"
        class="pending-order-card"
        [class.reservation]="group.status === 'pending_confirmation'"
      >
        <div class="order-card-header">
          <div class="order-title-section">
            <span class="order-id" *ngIf="group.isGroup">Order #{{ group.orderId | slice:4:12 }}</span>
            <span class="order-id" *ngIf="!group.isGroup">{{ group.sales?.[0]?.productName }}</span>
            <span class="reservation-badge" *ngIf="group.status === 'pending_confirmation'">RESERVATION</span>
          </div>
          <span class="order-total">{{ formatCurrency(group.total) }}</span>
        </div>

        <div class="order-items-preview" *ngIf="group.isGroup">
          <span *ngFor="let s of group.sales; let last = last">
            {{ s.productName }} (x{{ s.quantitySold }}){{ last ? '' : ', ' }}
          </span>
        </div>

        <div class="order-details">
          <div class="detail-row" *ngIf="group.customer">
            <span class="material-icon">person</span>
            <span>{{ group.customer.name }}</span>
          </div>
          <div class="detail-row" *ngIf="group.deliveryDate">
            <span class="material-icon">event</span>
            <span>{{ group.deliveryDate | date:'medium' }}</span>
          </div>
          <div class="detail-row" *ngIf="group.deliveryNotes">
            <span class="material-icon">notes</span>
            <span>{{ group.deliveryNotes }}</span>
          </div>
        </div>

        <div class="order-actions">
          <button class="order-action-btn edit" (click)="openEditModal(group?.sales[0])">
            <span class="material-icon">edit</span>
          </button>
          <button
            *ngIf="group.status === 'pending_confirmation'"
            class="order-action-btn confirm"
            (click)="confirmGroupReservation(group?.sales)"
          >
            <span class="material-icon">check_circle</span>
          </button>
          <button
            *ngIf="group.status !== 'pending_confirmation'"
            class="order-action-btn deliver"
            (click)="markGroupAsDelivered(group?.sales)"
          >
            <span class="material-icon">local_shipping</span>
          </button>
          <button class="order-action-btn delete" (click)="cancelGroupOrder(group?.sales)">
            <span class="material-icon">delete</span>
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="allGroupedSales.length === 0" class="empty-pending">
        <span class="material-icon">check_circle</span>
        <p>No pending deliveries</p>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pending-pagination" *ngIf="pendingTotalPages > 1">
      <button [disabled]="pendingPage === 1" (click)="prevPendingPage()">
        <span class="material-icon">chevron_left</span>
      </button>
      <span>Page {{ pendingPage }} of {{ pendingTotalPages }}</span>
      <button [disabled]="pendingPage >= pendingTotalPages" (click)="nextPendingPage()">
        <span class="material-icon">chevron_right</span>
      </button>
    </div>
  </div>
</div>

<!-- Delivery Modal -->
<div class="modal-overlay" *ngIf="isDeliveryModalOpen" (click)="closeDeliveryModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><span class="material-icon">local_shipping</span> Delivery Options</h3>
      <button class="modal-close" (click)="closeDeliveryModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Delivery Date</label>
        <input type="date" [(ngModel)]="deliveryDate" [min]="minDate" />
      </div>
      <div class="form-group">
        <label>Delivery Time</label>
        <input type="time" [(ngModel)]="deliveryTime" />
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea [(ngModel)]="deliveryNotes" rows="3" placeholder="Special instructions..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeDeliveryModal()">Cancel</button>
      <button class="btn-save" (click)="closeDeliveryModal()">Save</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" *ngIf="isEditModalOpen" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><span class="material-icon">edit</span> Edit Delivery</h3>
      <button class="modal-close" (click)="closeEditModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Delivery Date</label>
        <input type="date" [(ngModel)]="editDeliveryDate" [min]="minDate" />
      </div>
      <div class="form-group">
        <label>Delivery Time</label>
        <input type="time" [(ngModel)]="editDeliveryTime" />
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea [(ngModel)]="editDeliveryNotes" rows="3" placeholder="Notes..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeEditModal()">Cancel</button>
      <button class="btn-save" (click)="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Discount Modal -->
<div class="modal-overlay" *ngIf="isDiscountModalOpen" (click)="closeDiscountModal()">
  <div class="modal-content small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><span class="material-icon">percent</span> Apply Discount</h3>
      <button class="modal-close" (click)="closeDiscountModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="discount-input-row">
        <input type="number" [(ngModel)]="tempDiscount" placeholder="0" min="0" />
        <select [(ngModel)]="tempDiscountType">
          <option value="amount">₱ Amount</option>
          <option value="percent">% Percent</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeDiscountModal()">Cancel</button>
      <button class="btn-save" (click)="applyDiscount()">Apply</button>
    </div>
  </div>
</div>

<!-- Notes Modal -->
<div class="modal-overlay" *ngIf="isNotesModalOpen" (click)="closeNotesModal()">
  <div class="modal-content small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><span class="material-icon">edit_note</span> Order Notes</h3>
      <button class="modal-close" (click)="closeNotesModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <textarea [(ngModel)]="deliveryNotes" rows="4" placeholder="Add notes for this order..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeNotesModal()">Cancel</button>
      <button class="btn-save" (click)="closeNotesModal()">Save</button>
    </div>
  </div>
</div>

<!-- Quantity Modal -->
<div class="modal-overlay" *ngIf="isQuantityModalOpen" (click)="closeQuantityModal()">
  <div class="modal-content small qty-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><span class="material-icon">pin</span> Set Quantity</h3>
      <button class="modal-close" (click)="closeQuantityModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <!-- Current Product Info -->
      <div class="qty-product-info" *ngIf="cart[quantityModalIndex]">
        <span class="qty-product-name">{{ cart[quantityModalIndex].product.name }}</span>
        <span class="qty-stock-info">Max: {{ quantityModalMax }} in stock</span>
      </div>

      <!-- Quantity Input with +/- -->
      <div class="qty-input-group">
        <button class="qty-modal-btn" (click)="decrementModalQty()" [disabled]="quantityModalValue <= 1">
          <span class="material-icon">remove</span>
        </button>
        <input 
          type="number" 
          [(ngModel)]="quantityModalValue" 
          min="1" 
          [max]="quantityModalMax"
          class="qty-input"
        />
        <button class="qty-modal-btn" (click)="incrementModalQty()" [disabled]="quantityModalValue >= quantityModalMax">
          <span class="material-icon">add</span>
        </button>
      </div>

      <!-- Quick Quantity Buttons -->
      <div class="qty-quick-btns">
        <button 
          *ngFor="let q of [1, 5, 10, 25]"
          class="quick-qty-btn" 
          [class.active]="quantityModalValue === q"
          [disabled]="q > quantityModalMax"
          (click)="setQuickQuantity(q)"
        >
          {{ q }}
        </button>
        <button 
          class="quick-qty-btn max-btn" 
          [class.active]="quantityModalValue === quantityModalMax"
          (click)="setQuickQuantity(quantityModalMax)"
        >
          MAX
        </button>
      </div>

      <!-- Validation Hint -->
      <p class="qty-hint" *ngIf="quantityModalValue > quantityModalMax">
        <span class="material-icon">warning</span>
        Exceeds available stock. Will be set to {{ quantityModalMax }}.
      </p>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeQuantityModal()">Cancel</button>
      <button class="btn-save" (click)="applyQuantity()">Apply</button>
    </div>
  </div>
</div>
