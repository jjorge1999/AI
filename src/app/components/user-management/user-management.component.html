<div class="users-container">
  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-title-section">
        <h1 class="page-title">User Management</h1>
        <p class="page-subtitle">Manage access, roles, and permissions across the organization.</p>
      </div>
      <div class="header-actions">
        <div class="view-controls">
          <button 
            class="view-btn" 
            [class.active]="viewMode === 'table'"
            (click)="viewMode = 'table'"
            title="List View"
          >
            <span class="material-icon">view_list</span>
          </button>
          <button 
            class="view-btn" 
            [class.active]="viewMode === 'grid'"
            (click)="viewMode = 'grid'"
            title="Grid View"
          >
            <span class="material-icon">grid_view</span>
          </button>
        </div>
        <button class="btn-add" (click)="openAddModal()">
          <span class="material-icon">add</span>
          <span>Add User</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Filters Toolbar -->
  <div class="filters-toolbar">
    <div class="search-box">
      <span class="material-icon search-icon">search</span>
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange()"
        placeholder="Search by name, email, or role..."
        class="search-input"
      />
    </div>
    <div class="filter-chips">
      <select [(ngModel)]="roleFilter" (ngModelChange)="onFilterChange()" class="filter-select">
        <option value="all">Role: All</option>
        <option *ngFor="let role of roles.slice(1)" [value]="role">{{ role.replace('-', ' ') | titlecase }}</option>
      </select>
      <select *ngIf="isSuperAdmin" [(ngModel)]="storeFilter" (ngModelChange)="onFilterChange()" class="filter-select">
        <option value="all">Store: All</option>
        <option *ngFor="let store of availableStores" [value]="store.id">{{ store.name }}</option>
      </select>
    </div>
  </div>

  <!-- Users Content -->
  <div class="users-content">
    <!-- Table View -->
    <div class="table-container" *ngIf="viewMode === 'table'">
      <table class="users-table">
        <thead>
          <tr>
            <th class="col-user">User</th>
            <th class="col-email">Username</th>
            <th class="col-role">Role</th>
            <th class="col-store" *ngIf="isSuperAdmin">Store</th>
            <th class="col-status">Status</th>
            <th class="col-active">Last Active</th>
            <th class="col-actions"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of paginatedUsers" class="user-row">
            <td class="user-cell">
              <div class="user-info">
                <div class="user-avatar" [ngClass]="getAvatarColor(user)">
                  {{ getUserInitials(user) }}
                </div>
                <span class="user-name">{{ user.fullName || user.username }}</span>
              </div>
            </td>
            <td class="email-cell">{{ user.username }}</td>
            <td class="role-cell">
              <span class="role-badge" [ngClass]="getRoleBadgeClass(user.role)">
                {{ user.role.replace('-', ' ') | titlecase }}
              </span>
            </td>
            <td class="store-cell" *ngIf="isSuperAdmin">
              <span class="store-name-text">{{ getStoreName(user.storeId) }}</span>
            </td>
            <td class="status-cell">
              <div class="status-indicator active">
                <span class="status-dot"></span>
                <span class="status-text">Active</span>
              </div>
            </td>
            <td class="active-cell">{{ getLastActive(user) }}</td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button class="action-btn" (click)="openEditModal(user)" title="Edit">
                  <span class="material-icon">edit</span>
                </button>
                <button class="action-btn delete" (click)="deleteUser(user.id)" title="Delete">
                  <span class="material-icon">delete</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Grid View -->
    <div class="users-grid" *ngIf="viewMode === 'grid'">
      <div *ngFor="let user of paginatedUsers" class="user-card">
        <div class="user-card-header">
          <div class="user-avatar-large" [ngClass]="getAvatarColor(user)">
            {{ getUserInitials(user) }}
          </div>
          <div class="user-card-title">
            <h3 class="user-name">{{ user.fullName || user.username }}</h3>
            <p class="user-handle">{{'@'}}{{ user.username }}</p>
          </div>
          <div class="user-card-actions">
            <button class="icon-btn" (click)="openEditModal(user)">
              <span class="material-icon">edit</span>
            </button>
          </div>
        </div>
        
        <div class="user-card-body">
          <div class="info-row">
            <span class="material-icon">security</span>
            <span class="role-badge" [ngClass]="getRoleBadgeClass(user.role)">
              {{ user.role | titlecase }}
            </span>
          </div>
          <div class="info-row" *ngIf="isSuperAdmin">
            <span class="material-icon">store</span>
            <span class="info-text">{{ getStoreName(user.storeId) }}</span>
          </div>
          <div class="info-row">
            <span class="material-icon">location_on</span>
            <span class="info-text">{{ user.address || 'No address set' }}</span>
          </div>
        </div>

        <div class="user-card-footer">
          <div class="status-indicator active">
            <span class="status-dot"></span>
            <span class="status-text">Active</span>
          </div>
          <button class="btn-delete-small" (click)="deleteUser(user.id)">
            <span class="material-icon">delete</span>
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Empty States -->
    <div *ngIf="paginatedUsers.length === 0 && !isLoading" class="empty-state-container">
      <div class="empty-state">
        <span class="material-icon">group_off</span>
        <p>No users found</p>
        <button class="btn-add-small" (click)="openAddModal()">Add your first user</button>
      </div>
    </div>

    <div *ngIf="isLoading" class="loading-state-container">
      <div class="loading-state">
        <span class="material-icon">sync</span>
        <p>Loading users...</p>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-bar" *ngIf="filteredUsers.length > 0">
      <div class="pagination-info">
        Showing <span class="bold">{{ showingFrom }}-{{ showingTo }}</span> of <span class="bold">{{ filteredUsers.length }}</span> users
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" [disabled]="currentPage === 1" (click)="prevPage()">
          <span class="material-icon">chevron_left</span>
        </button>
        <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
          <span class="material-icon">chevron_right</span>
        </button>
      </div>
    </div>
  </div>

  <!-- AI Settings Section -->
  <div class="ai-settings-card">
    <div class="ai-settings-header" (click)="toggleAiSettings()">
      <div class="ai-settings-title">
        <span class="material-icon">smart_toy</span>
        <div>
          <h3>AI Configuration</h3>
          <p class="ai-status" [class.configured]="isGemmaConfigured">
            {{ isGemmaConfigured ? 'Configured' : 'Not configured' }}
          </p>
        </div>
      </div>
      <span class="material-icon expand-icon" [class.expanded]="showAiSettings">
        expand_more
      </span>
    </div>
    <div class="ai-settings-body" *ngIf="showAiSettings">
      <div class="form-group">
        <label>Hugging Face Token</label>
        <input
          type="password"
          [(ngModel)]="hfToken"
          placeholder="hf_xxxxxxxxxx..."
          class="form-input"
        />
      </div>
      <div class="ai-actions">
        <button class="btn-save" (click)="saveHfToken()" [disabled]="isSavingToken">
          {{ isSavingToken ? 'Saving...' : 'Save Token' }}
        </button>
        <button class="btn-clear" (click)="clearHfToken()" *ngIf="isGemmaConfigured">
          Clear Token
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal-overlay" *ngIf="isModalOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <span class="material-icon">{{ isEditing ? 'edit' : 'person_add' }}</span>
        {{ isEditing ? 'Edit User' : 'Add New User' }}
      </h3>
      <button class="modal-close" (click)="closeModal()">
        <span class="material-icon">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="username">Username *</label>
        <input
          type="text"
          id="username"
          [(ngModel)]="currentUser.username"
          placeholder="Enter username"
        />
      </div>
      <div class="form-group">
        <label for="fullName">Full Name</label>
        <input
          type="text"
          id="fullName"
          [(ngModel)]="currentUser.fullName"
          placeholder="Enter full name"
        />
      </div>
      <div class="form-group">
        <label for="password">{{ isEditing ? 'New Password (leave blank to keep)' : 'Password *' }}</label>
        <input
          type="password"
          id="password"
          [(ngModel)]="formPassword"
          placeholder="Enter password"
        />
      </div>
      <div class="form-group">
        <label for="role">Role *</label>
        <select id="role" [(ngModel)]="currentUser.role">
          <option *ngFor="let role of availableRoles" [value]="role">{{ role.replace('-', ' ') | titlecase }}</option>
        </select>
      </div>
      <div class="form-group">
        <label for="address">Address</label>
        <input
          type="text"
          id="address"
          [(ngModel)]="currentUser.address"
          placeholder="Enter address"
        />
      </div>
      <div class="form-group" *ngIf="currentUser.role !== 'super-admin'">
        <label>Account Expiration Date</label>
        <input type="date" [ngModel]="currentUser.accessExpiryDate | date:'yyyy-MM-dd'" (ngModelChange)="currentUser.accessExpiryDate=$event">
      </div>
      <div class="form-group" *ngIf="availableStores.length > 0 && (isAdmin || isSuperAdmin)">
        <label for="assignedStore">Default Store Assignment</label>
        <select id="assignedStore" [(ngModel)]="currentUser.storeId" [disabled]="!isSuperAdmin && !!currentUser.storeId">
          <option [value]="null">No Store assigned</option>
          <option *ngFor="let store of availableStores" [value]="store.id">{{ store.name }}</option>
        </select>
        <small class="form-help" *ngIf="!isSuperAdmin">Admins can only manage users within their assigned store.</small>
      </div>


    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeModal()">Cancel</button>
      <button class="btn-save" (click)="saveUser()">
        {{ isEditing ? 'Save Changes' : 'Add User' }}
      </button>
    </div>
  </div>
</div>
