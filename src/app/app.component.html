<!-- Public / Login Section -->
<div *ngIf="!isLoggedIn" class="public-container">
  <router-outlet></router-outlet>
</div>

<!-- Main Application with Sidebar Layout -->
<div *ngIf="isLoggedIn" class="app-layout">
  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="isSidebarCollapsed" [class.mobile-open]="isMobileSidebarOpen">
    <div class="sidebar-content">
      <!-- Logo/User Section -->
      <div class="sidebar-header">
        <div class="user-profile">
          <div class="user-avatar">
            <span class="avatar-text">{{ getUserInitials() }}</span>
          </div>
          <div class="user-info" *ngIf="!isSidebarCollapsed">
            <h1 class="user-name">{{ userFullName }}</h1>
            <p class="user-role">
              {{ userRole === 'super-admin' ? 'Super Admin' : (userRole === 'admin' ? 'Administrator' : 'Staff Member') }}
            </p>
          </div>
        </div>
        
        <!-- Actions moved from footer -->
        <div class="header-actions-row" [class.compact]="isSidebarCollapsed" style="margin-top: 1rem;">
          <button class="action-btn theme-btn" (click)="toggleTheme()" [title]="isDarkTheme ? 'Light Mode' : 'Dark Mode'">
            <span class="material-icon">{{ isDarkTheme ? 'light_mode' : 'dark_mode' }}</span>
            <span class="action-label" *ngIf="!isSidebarCollapsed">{{ isDarkTheme ? 'Light' : 'Dark' }}</span>
          </button>
          <button class="action-btn vision-btn" (click)="toggleVisionAid()" title="Vision Aid">
            <span class="material-icon">visibility</span>
            <span class="action-label" *ngIf="!isSidebarCollapsed">Vision</span>
          </button>
          <button class="action-btn logout-btn" (click)="logout()" title="Logout">
            <span class="material-icon">logout</span>
            <span class="action-label" *ngIf="!isSidebarCollapsed">Logout</span>
          </button>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="sidebar-nav">
        <a 
          class="nav-item" 
          routerLink="/home"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'home'">dashboard</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Dashboard</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/add-product"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'add-product'">add_box</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Add Product</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/inventory"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'inventory'">inventory_2</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Inventory</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/sell"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'sell'">point_of_sale</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Point of Sale</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/customers"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'customers'">groups</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Customers</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/expenses"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'expenses'">receipt_long</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Expenses</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/reports"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'reports'">bar_chart</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Analytics</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/logs"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'logs'">history</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Activity Logs</span>
        </a>
        <a 
          class="nav-item chat-nav-item" 
          [class.active]="isChatOpen"
          (click)="toggleChat(); closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="isChatOpen">chat</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Messages</span>
          <span class="chat-badge" *ngIf="totalUnreadMessages > 0 && !isSidebarCollapsed">{{ totalUnreadMessages }}</span>
          <span class="chat-dot" *ngIf="totalUnreadMessages > 0 && isSidebarCollapsed"></span>
        </a>
        <a 
          *ngIf="userRole === 'admin' || userRole === 'super-admin'"
          class="nav-item" 
          routerLink="/users"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'users'">manage_accounts</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">User Management</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/sales"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'sales'">local_offer</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Sales & Promos</span>
        </a>
        <a 
          class="nav-item" 
          routerLink="/ads"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'ads'">campaign</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Ad Inventory</span>
        </a>
        <a 
          *ngIf="userRole === 'admin' || userRole === 'super-admin'"
          class="nav-item" 
          routerLink="/stores"
          routerLinkActive="active"
          (click)="closeMobileSidebar()"
        >
          <span class="material-icon" [class.fill]="activeTab === 'stores'">store</span>
          <span class="nav-label" *ngIf="!isSidebarCollapsed">Store Management</span>
        </a>
      </nav>


    </div>
  </aside>

  <!-- Mobile Sidebar Overlay -->
  <div class="sidebar-overlay" [class.visible]="isMobileSidebarOpen" (click)="closeMobileSidebar()"></div>

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Top Header Bar -->
    <header class="top-header">
      <div class="header-left">
        <button class="menu-toggle" (click)="toggleMobileSidebar()">
          <span class="material-icon">menu</span>
        </button>
        <button class="sidebar-collapse-btn" (click)="toggleSidebarCollapse()">
          <span class="material-icon">{{ isSidebarCollapsed ? 'chevron_right' : 'chevron_left' }}</span>
        </button>
        <h2 class="page-title">{{ getPageTitle() }}</h2>
        
        <!-- Store Switcher -->
        <div class="store-switcher" *ngIf="stores.length > 0">
          <div class="active-store-selector" [class.collapsed]="isSidebarCollapsed">
            <span class="material-icon">storefront</span>
            <span class="store-label" [title]="activeStoreName">
              {{ activeStoreName }}
              <span class="plan-pill" *ngIf="activeStorePlan" style="font-size: 0.7em; background: var(--primary-color, #6366f1); padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle;">{{ activeStorePlan }}</span>
            </span>
          </div>
        </div>
      </div>
      <div class="header-right">
        <!-- Quick Actions -->
        <div class="header-actions">
          <div class="notification-wrapper">
            <button class="notification-btn" 
                    [class.has-notifications]="notificationCount > 0"
                    title="Notifications" (click)="toggleNotifications($event)">
              <span class="material-icon">notifications</span>
            </button>
            <span class="notification-badge-header" *ngIf="notificationCount > 0">{{ notificationCount }}</span>
            <div class="notification-pulse" *ngIf="notificationCount > 0"></div>

            <!-- Notifications Dropdown -->
            <div class="notifications-dropdown" *ngIf="showNotifications" (click)="$event.stopPropagation()">
              <div class="dropdown-header">
                <h3>Notifications</h3>
                <button (click)="clearNotifications()" class="clear-all-btn">Clear All</button>
              </div>
              <div class="notifications-list" *ngIf="recentNotifications.length > 0">
                <div *ngFor="let notif of recentNotifications" 
                     class="notification-item" 
                     [class.unread]="!notif.read">
                  <div class="notif-icon" [ngClass]="notif.type">
                    <span class="material-icon" *ngIf="notif.type === 'message'">chat</span>
                    <span class="material-icon" *ngIf="notif.type === 'reservation'">event</span>
                    <span class="material-icon" *ngIf="notif.type === 'delivery'">local_shipping</span>
                    <span class="material-icon" *ngIf="notif.type === 'reminder'">notification_important</span>
                    <span class="material-icon" *ngIf="notif.type === 'system'">info</span>
                  </div>
                  <div class="notif-content">
                    <p class="notif-title">{{ notif.title }}</p>
                    <p class="notif-body">{{ notif.body }}</p>
                    <span class="notif-time">{{ notif.timestamp | date:'shortTime' }}</span>
                  </div>
                </div>
              </div>
              <div class="no-notifications" *ngIf="recentNotifications.length === 0">
                <span class="material-icon">notifications_off</span>
                <p>No recent notifications</p>
              </div>
            </div>
          </div>
          <button class="quick-nav-btn" routerLink="/ads" *ngIf="userRole === 'admin'" title="Ad Inventory">
            <span class="material-icon">campaign</span>
            <span class="btn-text">Ads</span>
          </button>
          <button class="add-item-btn" routerLink="/add-product">
            <span class="material-icon">add</span>
            <span class="btn-text">Add Inventory</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Scrollable Content Area -->
    <div class="content-area">
      <div class="content-wrapper">
        <!-- Breadcrumbs (Moved from header to content area) -->
        <div class="breadcrumbs-container" *ngIf="breadcrumbs.length > 0">
          <div class="breadcrumbs">
            <a routerLink="/home" class="breadcrumb-link">
              <span class="material-icon">home</span>
            </a>
            <ng-container *ngFor="let breadcrumb of breadcrumbs; let last = last">
              <span class="material-icon breadcrumb-separator">chevron_right</span>
              <a *ngIf="!last" [routerLink]="breadcrumb.url" class="breadcrumb-link">
                {{ breadcrumb.label }}
              </a>
              <span *ngIf="last" class="breadcrumb-current">{{ breadcrumb.label }}</span>
            </ng-container>
          </div>
        </div>
        <router-outlet></router-outlet>
      </div>
    </div>
  </main>
</div>

<!-- Floating Chat Widget (Always Visible except on login or reservation without store) -->
<div class="chat-widget" *ngIf="!isLoginPage && (!isReservationPage || activeStoreId)">
  <button 
    class="chat-toggle-button" 
    (click)="toggleChat()"
    [class.active]="isChatOpen"
    title="Open Chat"
  >
    <span class="chat-icon">ðŸ’¬</span>
    <span class="chat-label">Chat</span>
  </button>
  
  <span class="notification-badge" *ngIf="totalUnreadMessages > 0">{{ totalUnreadMessages }}</span>
  
  <!-- Only render chat modal when open to prevent hidden elements blocking clicks -->
  <div class="chat-modal open" *ngIf="isChatOpen">
    <div class="chat-modal-content">
      <app-chat 
        [isOpen]="isChatOpen" 
        (totalUnreadCountChange)="totalUnreadMessages = $event"
      ></app-chat>
    </div>
    <button class="chat-modal-close" (click)="toggleChat()" title="Close Chat">âœ•</button>
  </div>
</div>

<!-- Global Dialog Component -->
<app-dialog></app-dialog>

<!-- Global Loading Indicator -->
<app-loading></app-loading>

<!-- Maintenance Overlay -->
<app-maintenance></app-maintenance>
