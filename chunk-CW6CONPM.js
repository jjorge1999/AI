import{P as l,g as u}from"./chunk-57FNYN7I.js";import{g as h}from"./chunk-7QOE2ANW.js";var m=(()=>{class a{constructor(){this.device=null,this.characteristic=null,this.connectionStatusSubject=new u("disconnected"),this.connectionStatus$=this.connectionStatusSubject.asObservable(),this.deviceNameSubject=new u(null),this.deviceName$=this.deviceNameSubject.asObservable(),this.PRINTER_SERVICE_UUIDS=["00001101-0000-1000-8000-00805f9b34fb","38eb4a80-c570-11e3-9507-0002a5d5c51b","000018f0-0000-1000-8000-00805f9b34fb","e7810a71-73ae-499d-8c15-faa9aef0c3f2","49535343-fe7d-4ae5-8fa9-9fafd205e455","0000ff00-0000-1000-8000-00805f9b34fb","0000ffe0-0000-1000-8000-00805f9b34fb","6e400001-b5a3-f393-e0a9-e50e24dcca9e","00001101-0000-1000-8000-00805f9b34fb","0000fff0-0000-1000-8000-00805f9b34fb","0000ae00-0000-1000-8000-00805f9b34fb","0000fee7-0000-1000-8000-00805f9b34fb"],this.WRITE_CHARACTERISTIC_UUIDS=["38eb4a81-c570-11e3-9507-0002a5d5c51b","00002af1-0000-1000-8000-00805f9b34fb","bef8d6c9-9c21-4c9e-b632-bd58c1009f9f","49535343-8841-43f4-a8d4-ecbe34729bb3","0000ff02-0000-1000-8000-00805f9b34fb","0000ffe1-0000-1000-8000-00805f9b34fb","6e400002-b5a3-f393-e0a9-e50e24dcca9e","6e400003-b5a3-f393-e0a9-e50e24dcca9e","0000fff2-0000-1000-8000-00805f9b34fb","0000ae01-0000-1000-8000-00805f9b34fb","0000ae02-0000-1000-8000-00805f9b34fb","0000fee7-0000-1000-8000-00805f9b34fb","0000fec7-0000-1000-8000-00805f9b34fb"],this.ESC=27,this.GS=29,this.LF=10;let t=localStorage.getItem("jjm_bluetooth_printer");t&&this.deviceNameSubject.next(t)}isBluetoothSupported(){return!!navigator.bluetooth}connectPrinter(){return h(this,null,function*(){if(!this.isBluetoothSupported())throw new Error("Web Bluetooth API is not supported in this browser");this.connectionStatusSubject.next("connecting");try{let t=navigator.bluetooth;if(this.device=yield t.requestDevice({acceptAllDevices:!0,optionalServices:this.PRINTER_SERVICE_UUIDS}),!this.device)throw new Error("No device selected");console.log("Selected device:",this.device.name||"Unknown Device"),this.device.addEventListener("gattserverdisconnected",this.onDisconnected.bind(this));let r=yield this.device.gatt?.connect();if(!r)throw new Error("Failed to connect to GATT server");let o=[];try{o=yield r.getPrimaryServices()}catch(i){console.warn("Could not get all services, trying known UUIDs...",i);for(let c of this.PRINTER_SERVICE_UUIDS)try{let s=yield r.getPrimaryService(c);o.push(s)}catch{}}console.log("Discovered services:",o.map(i=>i.uuid));for(let i of o)try{let c=yield i.getCharacteristics();console.log(`Service ${i.uuid} characteristics:`,c.map(s=>({uuid:s.uuid,write:s.properties.write,writeNoResp:s.properties.writeWithoutResponse})));for(let s of c){let n=s.uuid.toLowerCase();if(this.WRITE_CHARACTERISTIC_UUIDS.some(f=>n.includes(f.toLowerCase()))){console.log("Found known write characteristic:",n),this.characteristic=s;break}}if(this.characteristic)break}catch(c){console.log("Error getting characteristics for service",i.uuid,c)}if(!this.characteristic){console.log("No known characteristic found, searching for any writable...");for(let i of o)try{let c=yield i.getCharacteristics();for(let s of c)if(s.properties.write||s.properties.writeWithoutResponse){console.log("Using fallback writable characteristic:",s.uuid),this.characteristic=s;break}if(this.characteristic)break}catch{}}if(!this.characteristic)throw new Error("No writable characteristic found on printer. Please ensure the printer is turned on and in pairing mode.");let e=this.device.name||"Bluetooth Printer";return localStorage.setItem("jjm_bluetooth_printer",e),this.deviceNameSubject.next(e),this.connectionStatusSubject.next("connected"),!0}catch(t){throw console.error("Bluetooth connection error:",t),this.connectionStatusSubject.next("disconnected"),t}})}disconnectPrinter(){this.device?.gatt?.connected&&this.device.gatt.disconnect(),this.device=null,this.characteristic=null,this.connectionStatusSubject.next("disconnected")}onDisconnected(){this.characteristic=null,this.connectionStatusSubject.next("disconnected")}sendData(t){return h(this,null,function*(){if(!this.characteristic)throw new Error("Printer not connected");let r=100;for(let o=0;o<t.length;o+=r){let e=t.slice(o,o+r);this.characteristic.properties.writeWithoutResponse?yield this.characteristic.writeValueWithoutResponse(e):yield this.characteristic.writeValue(e),yield new Promise(i=>setTimeout(i,50))}})}buildEscPosReceipt(t){let r=new TextEncoder,o=[],e=(...c)=>{for(let s of c)o.push(s)},i=c=>{let s=r.encode(c);for(let n=0;n<s.length;n++)o.push(s[n])};e(this.ESC,64),e(this.ESC,97,1),e(this.ESC,33,48),i(t.storeName),e(this.LF),e(this.ESC,33,0),t.storeAddress&&(i(t.storeAddress),e(this.LF)),t.storePhone&&(i(`Tel: ${t.storePhone}`),e(this.LF)),i("================================"),e(this.LF),i(`Order: ${t.orderId}`),e(this.LF),i(`Date: ${t.date.toLocaleDateString()} ${t.date.toLocaleTimeString()}`),e(this.LF),t.customerName&&(i(`Customer: ${t.customerName}`),e(this.LF)),t.deliveryDate&&(i(`Delivery: ${t.deliveryDate.toLocaleDateString()} ${t.deliveryDate.toLocaleTimeString()}`),e(this.LF)),i("--------------------------------"),e(this.LF),e(this.ESC,97,0);for(let c of t.items){i(c.name),e(this.LF);let s=`  ${c.quantity} x ${this.formatMoney(c.price)}`,n=this.formatMoney(c.total),f=32-s.length-n.length;if(i(s+" ".repeat(Math.max(1,f))+n),e(this.LF),c.discount&&c.discount>0){let d=c.discountType==="percent"?`  Discount: ${c.discount}%`:`  Discount: -${this.formatMoney(c.discount)}`;i(d),e(this.LF)}}return i("--------------------------------"),e(this.LF),e(this.ESC,97,2),t.totalDiscount>0&&(i(`Total Discount: -${this.formatMoney(t.totalDiscount)}`),e(this.LF)),e(this.ESC,69,1),i(`TOTAL: ${this.formatMoney(t.total)}`),e(this.LF),e(this.ESC,69,0),i(`Cash: ${this.formatMoney(t.cashReceived)}`),e(this.LF),i(`Change: ${this.formatMoney(t.change)}`),e(this.LF),t.notes&&(e(this.ESC,97,0),i("--------------------------------"),e(this.LF),i(`Notes: ${t.notes}`),e(this.LF)),e(this.ESC,97,1),i("================================"),e(this.LF),i("Thank you for your purchase!"),e(this.LF),i("Please come again"),e(this.LF,this.LF,this.LF),e(this.GS,86,1),new Uint8Array(o)}formatMoney(t){return new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(t)}printReceipt(t){return h(this,null,function*(){let r=this.buildEscPosReceipt(t);yield this.sendData(r)})}printTestPage(){return h(this,null,function*(){let t={storeName:"JJM Inventory",storeAddress:"Test Address",storePhone:"123-456-7890",orderId:"TEST-001",date:new Date,items:[{name:"Test Product 1",quantity:2,price:100,total:200},{name:"Test Product 2",quantity:1,price:150,total:150}],subtotal:350,totalDiscount:0,total:350,cashReceived:500,change:150};yield this.printReceipt(t)})}isConnected(){return this.connectionStatusSubject.value==="connected"&&this.characteristic!==null}forgetPrinter(){localStorage.removeItem("jjm_bluetooth_printer"),this.deviceNameSubject.next(null),this.disconnectPrinter()}static{this.\u0275fac=function(r){return new(r||a)}}static{this.\u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{m as a};
