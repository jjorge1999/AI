import{La as f,M as u,P as g,U as h,g as m,j as d,k as l,nc as C,o as p,qc as S,rc as I}from"./chunk-OKMRB5PS.js";import{a as i,b as a}from"./chunk-7QOE2ANW.js";var E=(()=>{class o{constructor(t,e){this.http=t,this.storeService=e,this.apiUrl=S.apiUrl,this._customers=f([]),this.customers=this._customers.asReadonly(),this.customersSubject=new m([]),this.customers$=this.customersSubject.asObservable(),this.hydrateFromCache()}hydrateFromCache(){let t=localStorage.getItem("jjm_cached_customers");if(t)try{let e=JSON.parse(t);this._customers.set(e),this.customersSubject.next(e),console.log("Hydrated Customers from cache")}catch(e){console.warn("Failed to hydrate customers from cache",e)}}saveToCache(t){localStorage.setItem("jjm_cached_customers",JSON.stringify(t))}loadCustomers(t=!1){if(!t&&this._customers().length>0){console.log("Customers already loaded in Signal. Skipping fetch.");return}this.fetchCustomers()}loadInitialData(){this.loadCustomers()}getCurrentUser(){return localStorage.getItem("jjm_user_id")||"guest"}reloadData(){this.loadCustomers(!0)}fetchCustomers(){let t=this.getCurrentUser(),e=this.storeService.getActiveStoreId();if(!t||t==="guest"||!e){e||(this._customers.set([]),this.customersSubject.next([]));return}let s=`${this.apiUrl}/customers?userId=${t}&storeId=${e}`;this.http.get(s).subscribe({next:r=>{this._customers.set(r),this.customersSubject.next(r),this.saveToCache(r)},error:r=>console.error("Error fetching customers:",r)})}getCustomers(){return this.customers$}getCustomerByName(t){let e=this.storeService.getActiveStoreId();return e?this.http.get(`${this.apiUrl}/customers?name=${encodeURIComponent(t)}&storeId=${e}`).pipe(p(s=>s.map(r=>a(i({},r),{phoneNumber:r.phoneNumber,deliveryAddress:"***",gpsCoordinates:"***",userId:"***"})))):d([])}getCustomerByPhone(t){return this.http.get(`${this.apiUrl}/customers?phoneNumber=${encodeURIComponent(t)}`)}addCustomer(t){let e=this.storeService.getActiveStoreId();if(!e)return l(()=>new Error("Store selection required for this transaction."));let s=i({userId:this.getCurrentUser(),storeId:e},t);return this.http.post(`${this.apiUrl}/customers`,s).pipe(u({next:r=>{let n=[...this._customers(),r];this._customers.set(n),this.customersSubject.next(n),this.saveToCache(n)},error:r=>console.error("Error adding customer:",r)}))}updateCustomer(t,e){return this.http.put(`${this.apiUrl}/customers/${t}`,e).pipe(u({next:()=>{let r=this._customers().map(c=>c.id===t?i(i({},c),e):c);this._customers.set(r),this.customersSubject.next(r),this.saveToCache(r)},error:s=>console.error("Error updating customer:",s)}))}deleteCustomer(t){return this.http.delete(`${this.apiUrl}/customers/${t}`).pipe(u({next:()=>{let s=this._customers().filter(r=>r.id!==t);this._customers.set(s),this.customersSubject.next(s),this.saveToCache(s)},error:e=>console.error("Error deleting customer:",e)}))}getCustomerById(t){return this.customersSubject.value.find(e=>e.id===t)}static{this.\u0275fac=function(e){return new(e||o)(h(C),h(I))}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{E as a};
