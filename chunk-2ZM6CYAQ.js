import{$c as v,P as D,U as f,Xc as l,ad as d,cd as w,ed as S,g as I,i as L,id as A,j as u,ld as x,md as E,nd as F,o as y,x as j}from"./chunk-PYKLABYS.js";import{a as h,b as p,g as b}from"./chunk-7QOE2ANW.js";var U=(()=>{class n{get db(){return this.firebaseService.db}constructor(c,t){this.firebaseService=c,this.storeService=t,this.logsSubject=new I([]),this.logs$=this.logsSubject.asObservable(),this.storeService.activeStoreId$.subscribe(s=>{s?this.fetchLogs(s):this.logsSubject.next([])})}getCurrentUserId(){return localStorage.getItem("jjm_user_id")||"guest"}fetchLogs(c){let t=c||this.storeService.getActiveStoreId();if(!t){console.log("LoggingService: No storeId available, skipping fetch."),this.logsSubject.next([]);return}console.log("LoggingService: Fetching logs for storeId:",t);let s=l(this.db,"activityLogs"),g=v(s,d("storeId","==",t),w(200));S(g).then(i=>{console.log("LoggingService: Received",i.docs.length,"logs");let r=i.docs.map(e=>{let o=e.data();return p(h({id:e.id},o),{timestamp:o.timestamp?.toDate?o.timestamp.toDate():o.timestamp})}).sort((e,o)=>{let a=e.timestamp instanceof Date?e.timestamp.getTime():0;return(o.timestamp instanceof Date?o.timestamp.getTime():0)-a});this.logsSubject.next(r)}).catch(i=>{console.error("LoggingService: Error fetching logs:",i),console.error("LoggingService: This may be a Firestore permissions issue. Check Security Rules for /logs collection.")})}logActivity(c,t,s,g,i){let r=this.storeService.getActiveStoreId();if(!r){console.warn("Logging skipped: No active store selected.");return}let e={action:c,entityType:t,entityId:s,entityName:g,details:i,userId:this.getCurrentUserId(),storeId:r,timestamp:new Date};console.log("Logging activity:",e);let o=l(this.db,"activityLogs");A(o,e).then(a=>{let m=h({id:a.id},e);console.log("Activity logged successfully:",m);let R=this.logsSubject.value;this.logsSubject.next([m,...R])}).catch(a=>{console.error("Error logging activity:",a),console.error("Failed log data:",e)})}getLogs(){return this.logs$}refreshLogs(){this.fetchLogs()}cleanupOldLogs(){let c=this.getCurrentUserId(),t=this.storeService.getActiveStoreId();if(!t)return u({message:"No store selected"});let s=new Date;s.setDate(s.getDate()-30);let g=l(this.db,"activityLogs"),i=v(g,d("storeId","==",t),d("timestamp","<",s));return L(S(i)).pipe(y(r=>b(this,null,function*(){let e=x(this.db);return r.docs.forEach(o=>{e.delete(o.ref)}),yield e.commit(),{deleted:r.docs.length}})),j(r=>(console.error("Error cleaning up logs:",r),u({error:r.message}))))}static{this.\u0275fac=function(t){return new(t||n)(f(E),f(F))}}static{this.\u0275prov=D({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{U as a};
