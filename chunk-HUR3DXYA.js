import{$c as L,P as w,U as u,Wc as g,Zc as f,_c as l,ad as A,cd as p,g as S,gd as E,i as j,j as m,ld as x,md as C,nd as U,o as y,x as D}from"./chunk-IZ5DWI6X.js";import{a as h,b,g as I}from"./chunk-7QOE2ANW.js";var $=(()=>{class n{get db(){return this.firebaseService.db}constructor(r,t){this.firebaseService=r,this.storeService=t,this.logsSubject=new S([]),this.logs$=this.logsSubject.asObservable()}getCurrentUserId(){return localStorage.getItem("jjm_user_id")||"guest"}fetchLogs(){let r=this.getCurrentUserId(),t=this.storeService.getActiveStoreId();if(!r||r==="guest"||!t){t||this.logsSubject.next([]);return}let i=g(this.db,"logs"),a=f(i,l("storeId","==",t),L("timestamp","desc"),A(200));p(a).then(c=>{let e=c.docs.map(o=>{let s=o.data();return b(h({id:o.id},s),{timestamp:s.timestamp?.toDate?s.timestamp.toDate():s.timestamp})});this.logsSubject.next(e)}).catch(c=>console.error("Error fetching logs:",c))}logActivity(r,t,i,a,c){let e=this.storeService.getActiveStoreId();if(!e){console.warn("Logging skipped: No active store selected.");return}let o={action:r,entityType:t,entityId:i,entityName:a,details:c,userId:this.getCurrentUserId(),storeId:e,timestamp:new Date};console.log("Logging activity:",o);let s=g(this.db,"logs");E(s,o).then(d=>{let v=h({id:d.id},o);console.log("Activity logged successfully:",v);let q=this.logsSubject.value;this.logsSubject.next([v,...q])}).catch(d=>{console.error("Error logging activity:",d),console.error("Failed log data:",o)})}getLogs(){return this.logs$}refreshLogs(){this.fetchLogs()}cleanupOldLogs(){let r=this.getCurrentUserId(),t=this.storeService.getActiveStoreId();if(!t)return m({message:"No store selected"});let i=new Date;i.setDate(i.getDate()-30);let a=g(this.db,"logs"),c=f(a,l("storeId","==",t),l("timestamp","<",i));return j(p(c)).pipe(y(e=>I(this,null,function*(){let o=x(this.db);return e.docs.forEach(s=>{o.delete(s.ref)}),yield o.commit(),{deleted:e.docs.length}})),D(e=>(console.error("Error cleaning up logs:",e),m({error:e.message}))))}static{this.\u0275fac=function(t){return new(t||n)(u(C),u(U))}}static{this.\u0275prov=w({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{$ as a};
